{% extends "base.html" %}

{% block title %}搜尋 - JavHelper{% endblock %}

{% block extra_css %}
<style>
    /* 主要容器 */
    .search-container {
        min-height: calc(100vh - 56px);
        display: flex;
        flex-direction: column;
    }

    /* 搜尋框區域 - 緊湊 */
    .search-bar {
        flex-shrink: 0;
        padding: 0.5rem 1rem;
        background: #fff;
        border-bottom: 1px solid #dee2e6;
    }

    /* 結果區域 */
    .result-area {
        flex: 1;
        display: flex;
        overflow: hidden;
        padding: 0.5rem;
        gap: 0.5rem;
        min-height: 0;
    }

    /* 結果卡片 */
    #resultCard {
        display: flex;
        flex-direction: column;
        max-height: 100%;
    }

    #resultCard > .result-area {
        flex-shrink: 1;
        min-height: 0;
        align-items: flex-start;  /* 讓 info-section 不要拉伸 */
    }

    /* 列表在 cover-section 內 */
    .cover-section > .file-list-section {
        width: 100%;
        flex-shrink: 0;
        margin-top: 0.5rem;
    }

    /* 封面區域 - 70% */
    .cover-section {
        flex: 7;
        position: relative;
        display: flex;
        flex-direction: column;   /* 垂直排列：封面 + 列表 */
        align-items: center;
        min-width: 0;
        min-height: 0;
        overflow: hidden;
    }

    /* 封面容器（圖片自然尺寸） */
    .cover-wrapper {
        position: relative;
        max-width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .cover-img {
        max-width: 100%;
        max-height: calc(100vh - 250px);  /* 限制最大高度 */
        object-fit: contain;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    /* 導航按鈕 */
    .nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 44px;
        height: 64px;
        background: rgba(0, 0, 0, 0.6);
        border: none;
        color: #fff;
        font-size: 1.4rem;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 10;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .nav-btn:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: translateY(-50%) scale(1.05);
    }
    .nav-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        transform: translateY(-50%);
    }
    .nav-btn.prev { left: 10px; }
    .nav-btn.next { right: 10px; }

    /* 索引顯示 */
    .nav-indicator {
        position: absolute;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.6);
        color: #fff;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
    }

    /* 檔案列表區（封面下方） */
    .file-list-section {
        background: rgba(255,255,255,0.95);
        border-top: 1px solid #dee2e6;
        padding: 8px 12px;
    }

    .file-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }

    .file-list-header .file-count {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .file-list {
        /* 不限制高度，讓頁面滾動 */
    }

    .file-item {
        padding: 4px 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 0.8rem;
        border-radius: 4px;
        transition: background 0.15s;
    }

    .file-item:hover {
        background: #e9ecef;
    }

    .file-item.active {
        background: #e7f1ff;
        font-weight: 500;
    }

    .file-item .file-icon {
        color: #6c757d;
        flex-shrink: 0;
    }

    .file-item .file-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .file-item .file-status {
        font-size: 0.75rem;
        color: #198754;
        flex-shrink: 0;
    }

    .file-item .btn-scrape-single {
        flex-shrink: 0;
        padding: 0 6px;
        font-size: 0.7rem;
        line-height: 1.4;
    }

    /* 資訊區域 - 30% */
    .info-section {
        flex: 3;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        background: #fff;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        min-width: 200px;
    }

    .info-header {
        padding: 0.75rem;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
    }

    .info-number {
        font-size: 1.25rem;
        font-weight: bold;
        color: #0d6efd;
        margin: 0;
    }

    .info-body {
        flex: 1;
        padding: 0.75rem;
        overflow-y: auto;
    }

    .info-row {
        margin-bottom: 0.75rem;
    }
    .info-label {
        font-size: 0.7rem;
        color: #6c757d;
        text-transform: uppercase;
        margin-bottom: 0.15rem;
    }
    .info-value {
        font-size: 0.85rem;
        word-break: break-word;
    }

    .info-footer {
        padding: 0.75rem;
        border-top: 1px solid #eee;
        background: #f8f9fa;
    }

    /* 初始狀態按鈕區 */
    .empty-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.5rem;
    }
    .empty-actions .btn {
        font-size: 0.85rem;
    }

    .info-title {
        font-size: 0.8rem;
        color: #333;
        line-height: 1.3;
    }

    /* 標籤 */
    .tag-badge {
        font-size: 0.65rem;
        margin: 1px;
        padding: 2px 6px;
        background: #e9ecef;
        color: #495057;
    }
    .tag-badge.subtitle {
        background: #198754;
        color: #fff;
    }

    /* 狀態頁面 */
    .state-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
    }
    .state-page i {
        font-size: 3rem;
        margin-bottom: 0.5rem;
    }

    /* 搜尋提示 */
    .search-hint {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    /* === 搜尋進度指示器 === */
    .search-progress {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
    }

    .progress-container {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 12px;
        padding: 1.5rem 2rem;
        min-width: 320px;
        max-width: 420px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.3);
        font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }

    .progress-header {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .progress-query {
        color: #4ade80;
        font-weight: 600;
        font-size: 1.1rem;
    }

    /* 單行日誌 */
    .progress-log {
        color: #94a3b8;
        font-size: 0.85rem;
        text-align: center;
        padding: 0.5rem;
        min-height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .progress-log::before {
        content: '';
        width: 8px;
        height: 8px;
        border: 2px solid rgba(96, 165, 250, 0.3);
        border-top-color: #60a5fa;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* 詳情進度條 */
    .detail-progress {
        margin-top: 1rem;
        position: relative;
        height: 22px;
        background: rgba(255,255,255,0.08);
        border-radius: 11px;
        overflow: hidden;
        display: none;
    }

    .detail-progress.show {
        display: block;
    }

    .detail-bar {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 11px;
        transition: width 0.2s ease;
        min-width: 2%;
    }

    .detail-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #fff;
        font-size: 0.7rem;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    /* === 拖拽覆蓋層 === */
    .drag-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(13, 110, 253, 0.1);
        border: 3px dashed #0d6efd;
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }
    .drag-overlay.active { display: flex; }

    .drag-overlay-content {
        background: white;
        padding: 2rem 3rem;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.15);
        text-align: center;
    }
    .drag-overlay-content i {
        font-size: 3rem;
        color: #0d6efd;
        margin-bottom: 1rem;
        display: block;
    }
    .drag-overlay-content p {
        font-size: 1.1rem;
        color: #333;
        margin: 0;
    }

    /* === RWD 響應式 === */

    /* Tablet & Mobile: 調整容器高度 */
    @media (max-width: 991.98px) {
        .search-container {
            height: calc(100vh - 56px); /* 扣除頂部導航列 */
        }
    }

    /* Tablet: 調整比例 60/40 */
    @media (max-width: 991.98px) and (min-width: 768px) {
        .cover-section {
            flex: 6;
        }
        .info-section {
            flex: 4;
            min-width: 200px;
        }
    }

    /* Mobile: 垂直排列 */
    @media (max-width: 767.98px) {
        .result-area {
            flex-direction: column;
            overflow-y: auto;
        }
        .cover-section {
            flex: none;
            width: 100%;
            max-height: 50vh;
            position: relative;
            padding-bottom: 50px;
        }
        .cover-wrapper {
            max-width: 100%;
        }
        .cover-img {
            max-height: calc(50vh - 60px);
        }
        .info-section {
            flex: none;
            width: 100%;
            min-width: auto;
            max-height: none;
        }
        .nav-btn {
            width: 36px;
            height: 52px;
            font-size: 1.1rem;
        }
        .nav-btn.prev { left: 5px; }
        .nav-btn.next { right: 5px; }
        .search-bar {
            padding: 0.5rem;
        }
        .search-hint {
            display: none;
        }
        .path-input-area {
            position: relative;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- 拖拽覆蓋層 -->
<div class="drag-overlay" id="dragOverlay">
    <div class="drag-overlay-content">
        <i class="bi bi-file-earmark-play"></i>
        <p>放開以搜尋番號</p>
    </div>
</div>

<div class="search-container">
    <!-- 搜尋框 -->
    <div class="search-bar">
        <form id="searchForm" class="d-flex gap-2">
            <!-- 清空按鈕（有內容時顯示） -->
            <button type="button" class="btn btn-outline-secondary btn-lg d-none" id="btnClear" title="清空">
                <i class="bi bi-x-lg"></i>
            </button>
            <div class="flex-grow-1">
                <div class="input-group input-group-lg">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control"
                           id="searchQuery" name="q"
                           placeholder="番號 (SONE-001)、局部番號 (IPZZ-03)、或女優名"
                           autocomplete="off">
                </div>
            </div>
            <button type="submit" class="btn btn-primary btn-lg px-4">
                搜尋
            </button>
        </form>
        <div class="search-hint">
            <i class="bi bi-lightbulb"></i>
            提示：輸入局部番號如 <code>IPZZ-03</code> 可搜尋 030~039，輸入女優名可搜尋其作品
        </div>
    </div>

    <!-- 結果區域 -->
    <div class="result-area">
        <!-- 初始狀態 -->
        <div id="emptyState" class="state-page w-100">
            <i class="bi bi-film"></i>
            <p class="mb-2">輸入番號搜尋，或加入影片檔案</p>
            <div class="empty-actions">
                <button class="btn btn-outline-primary btn-sm" id="btnAddFiles">
                    <i class="bi bi-file-earmark-plus"></i> 加入檔案
                </button>
                <button class="btn btn-outline-primary btn-sm" id="btnAddFolder">
                    <i class="bi bi-folder-plus"></i> 加入資料夾
                </button>
            </div>
            <small class="mt-2 text-muted">也可直接拖入檔案或資料夾</small>
        </div>

        <!-- 載入中 - 進度指示器 -->
        <div id="loadingState" class="search-progress w-100 d-none">
            <div class="progress-container">
                <!-- 搜尋標題 -->
                <div class="progress-header">
                    <span class="progress-query" id="progressQuery">"搜尋中"</span>
                </div>

                <!-- 單行日誌 -->
                <div class="progress-log" id="progressLog">
                    搜尋中...
                </div>

                <!-- 詳情進度條 -->
                <div class="detail-progress" id="detailProgress">
                    <div class="detail-bar" id="detailBar"></div>
                    <span class="detail-text" id="detailText">0 / 0</span>
                </div>
            </div>
        </div>

        <!-- 錯誤狀態 -->
        <div id="errorState" class="state-page w-100 d-none">
            <i class="bi bi-exclamation-triangle text-danger"></i>
            <p class="text-danger mb-1" id="errorMessage">搜尋失敗</p>
            <small>請檢查番號格式或稍後再試</small>
            <!-- 多檔案模式導航 -->
            <div class="error-nav d-none mt-3" id="errorNav">
                <button class="btn btn-outline-secondary btn-sm" id="errorBtnPrev" title="上一個 (←)">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span class="mx-2" id="errorNavIndicator">1/5</span>
                <button class="btn btn-outline-secondary btn-sm" id="errorBtnNext" title="下一個 (→)">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- 結果卡片 -->
        <div id="resultCard" class="d-none w-100">
            <div class="result-area p-0">
                <!-- 封面區 70% -->
                <div class="cover-section">
                    <div class="cover-wrapper">
                        <img id="resultCover" src="" class="cover-img" alt="封面">
                        <button class="nav-btn prev d-none" id="btnPrev" title="上一個 (←)">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="nav-btn next d-none" id="btnNext" title="下一個 (→)">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                        <div class="nav-indicator d-none" id="navIndicator">
                            <span id="currentIndex">1</span> / <span id="totalCount">1</span>
                        </div>
                    </div>

                    <!-- 檔案/搜尋結果列表（緊貼在封面下方） -->
                    <div class="file-list-section d-none" id="fileListSection">
                        <div class="file-list-header">
                            <span class="file-count" id="fileCountText">0 個檔案</span>
                            <button class="btn btn-success btn-sm" id="btnScrapeAll" type="button">
                                <i class="bi bi-folder-plus"></i> 產生全部
                            </button>
                        </div>
                        <div class="file-list" id="fileList">
                            <!-- 動態生成檔案項目 -->
                        </div>
                    </div>
                </div>

                <!-- 資訊區 30% -->
                <div class="info-section">
                    <div class="info-header">
                        <h4 class="info-number" id="resultNumber">-</h4>
                    </div>
                    <div class="info-body">
                        <div class="info-row">
                            <div class="info-label">演員</div>
                            <div class="info-value" id="resultActors">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">發行日期</div>
                            <div class="info-value" id="resultDate">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">片商</div>
                            <div class="info-value" id="resultMaker">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">標籤</div>
                            <div class="info-value" id="resultTags">-</div>
                        </div>
                    </div>
                    <div class="info-footer">
                        <div class="info-label">標題</div>
                        <div class="info-title d-flex align-items-start" id="titleContainer">
                            <span id="resultTitle" style="flex:1;">-</span>
                            <button id="editTitleBtn" class="btn btn-sm btn-link p-0 ms-1" onclick="startEditTitle()" title="編輯標題">
                                <i class="bi bi-pencil text-muted"></i>
                            </button>
                            <!-- AI 翻譯按鈕 -->
                            <button id="translateBtn" class="btn btn-sm btn-link p-0 ms-1 d-none"
                                    onclick="translateWithAI()" title="AI 翻譯">
                                <i class="bi bi-translate"></i>
                            </button>
                            <span id="translateSpinner" class="spinner-border spinner-border-sm ms-1 d-none"></span>
                        </div>
                        <div id="chineseTitleRow" class="mt-2 d-none">
                            <div class="info-label" id="chineseTitleLabel">中文片名</div>
                            <div class="info-title d-flex align-items-start" id="chineseTitleContainer">
                                <span id="resultChineseTitle" class="text-success" style="flex:1;">-</span>
                                <button id="editChineseTitleBtn" class="btn btn-sm btn-link p-0 ms-1" onclick="startEditChineseTitle()" title="編輯中文片名">
                                    <i class="bi bi-pencil text-muted"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// === 全域函數：供 PyWebView Python 端呼叫 ===

/**
 * 從檔名提取番號（全域版本）
 */
function extractNumberGlobal(filename) {
    const basename = filename.split(/[/\\]/).pop().replace(/\.[^.]+$/, '');
    const patterns = [
        /\b([A-Z]{1,5})-(\d{3,5})\b/i,   // T28-650, SONE-205（支援單字母）
        /\b([A-Z]{2,5})(\d{3,5})\b/i,     // IPTD927（無連字號需 2+ 字母避免誤判）
        /\b(FC2-PPV)-(\d{5,7})\b/i,
    ];
    for (const pattern of patterns) {
        const match = basename.match(pattern);
        if (match) {
            const prefix = match[1].toUpperCase();
            if (prefix === 'FC2-PPV') return `FC2-PPV-${match[2]}`;
            return `${prefix}-${match[2]}`;
        }
    }
    return null;
}

/**
 * PyWebView 拖放回調（由 Python 端呼叫）
 * @param {string|string[]} paths - WSL 格式的檔案路徑（單一或陣列）
 */
window.handlePyWebViewDrop = function(paths) {
    // 統一轉為陣列
    const pathList = Array.isArray(paths) ? paths : [paths];
    console.log('PyWebView drop:', pathList.length, '個檔案');

    // 觸發自定義事件，讓主程式處理
    window.dispatchEvent(new CustomEvent('pywebview-files', {
        detail: { paths: pathList }
    }));
};

// === 主程式 ===
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('searchForm');
    const queryInput = document.getElementById('searchQuery');

    const emptyState = document.getElementById('emptyState');
    const loadingState = document.getElementById('loadingState');
    const resultCard = document.getElementById('resultCard');
    const errorState = document.getElementById('errorState');

    // 導航按鈕
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const navIndicator = document.getElementById('navIndicator');
    const currentIndexSpan = document.getElementById('currentIndex');
    const totalCountSpan = document.getElementById('totalCount');

    // 錯誤狀態導航按鈕（多檔案模式用）
    const errorNav = document.getElementById('errorNav');
    const errorBtnPrev = document.getElementById('errorBtnPrev');
    const errorBtnNext = document.getElementById('errorBtnNext');
    const errorNavIndicator = document.getElementById('errorNavIndicator');

    // 清空按鈕
    const btnClear = document.getElementById('btnClear');

    // 搜尋結果
    let searchResults = [];
    let currentIndex = 0;

    // 分頁相關
    let currentQuery = '';
    let currentOffset = 0;
    let hasMoreResults = false;
    let isLoadingMore = false;
    const PAGE_SIZE = 20;

    // === 多檔案列表狀態 ===
    let fileList = [];  // [{path, filename, number, metadata, searched}]
    let currentFileIndex = 0;
    let listMode = null;  // 'file' | 'search' | null

    // === 翻譯功能 ===
    let appConfig = null;  // 應用設定
    const translationCache = new Map();  // 快取：番號 -> {result, mode}
    let isTranslating = false;  // 防止並發翻譯
    let pendingTranslation = null;  // 待處理的翻譯請求

    // 檔案列表 DOM 元素
    const fileListSection = document.getElementById('fileListSection');
    const fileListContainer = document.getElementById('fileList');
    const fileCountText = document.getElementById('fileCountText');
    const btnScrapeAll = document.getElementById('btnScrapeAll');

    // === 載入應用設定 ===
    async function loadAppConfig() {
        try {
            const resp = await fetch('/api/config');
            const data = await resp.json();
            if (data.success) {
                appConfig = data.data;
            }
        } catch (e) {
            console.error('載入設定失敗:', e);
        }
    }

    // === 翻譯功能 ===

    /**
     * 判斷文字是否包含日文（平假名、片假名）
     */
    function hasJapanese(text) {
        return /[\u3040-\u309F\u30A0-\u30FF]/.test(text);
    }

    /**
     * 調用 Ollama 翻譯/優化標題
     */
    async function translateWithOllama(text, mode, metadata = {}) {
        try {
            const resp = await fetch('/api/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: text,
                    mode: mode,
                    actors: metadata.actors || [],
                    number: metadata.number || ''
                })
            });
            return await resp.json();
        } catch (e) {
            return { success: false, error: e.message };
        }
    }

    /**
     * AI 翻譯按鈕點擊事件（全域函數供 onclick 調用）
     */
    window.translateWithAI = async function() {
        const btn = document.getElementById('translateBtn');
        const spinner = document.getElementById('translateSpinner');
        const title = btn.dataset.title;
        const actors = JSON.parse(btn.dataset.actors || '[]');
        const number = btn.dataset.number || '';

        if (!title) return;

        // 防止並發翻譯
        if (isTranslating) return;
        isTranslating = true;

        // 記住開始時的索引（避免切換後存錯位置）
        const startFileIndex = currentFileIndex;
        const startResultIndex = currentIndex;
        const startListMode = listMode;

        // 顯示 loading
        btn.classList.add('d-none');
        spinner.classList.remove('d-none');

        try {
            const result = await translateWithOllama(title, 'translate', { actors, number });

            if (result.success && result.result) {
                // 存入「原本」位置的 metadata（不管現在在哪）
                if (startListMode === 'file' && fileList[startFileIndex]) {
                    const file = fileList[startFileIndex];
                    if (file.searchResults && file.searchResults[startResultIndex]) {
                        file.searchResults[startResultIndex].translated_title = result.result;
                    }
                } else if (searchResults[startResultIndex]) {
                    searchResults[startResultIndex].translated_title = result.result;
                }

                // 只有「還在同一個位置」才更新 UI
                if (currentFileIndex === startFileIndex && currentIndex === startResultIndex) {
                    document.getElementById('resultChineseTitle').textContent = result.result;
                    document.getElementById('chineseTitleRow').classList.remove('d-none');
                    document.getElementById('chineseTitleLabel').textContent = '中文片名 (AI)';
                    // 隱藏按鈕（已翻譯完成）
                    btn.classList.add('d-none');
                }
                // 如果已切換到其他影片，不更新 UI，但資料已存好
                // 用戶切回去時 displayResult() 會正確顯示
            } else {
                // 失敗時，只有還在原位置才恢復按鈕
                if (currentFileIndex === startFileIndex && currentIndex === startResultIndex) {
                    btn.classList.remove('d-none');
                }
                alert(result.error || '翻譯失敗');
            }
        } catch (e) {
            if (currentFileIndex === startFileIndex && currentIndex === startResultIndex) {
                btn.classList.remove('d-none');
            }
            alert('Ollama 連線失敗: ' + e.message);
        } finally {
            // 翻譯完成，解除鎖定
            isTranslating = false;

            // 只有還在原位置才隱藏 spinner
            if (currentFileIndex === startFileIndex && currentIndex === startResultIndex) {
                spinner.classList.add('d-none');
            }

            // 解除當前按鈕的 disabled 狀態（不管在哪）
            btn.disabled = false;
        }
    };

    /**
     * 背景翻譯標題（不阻塞 UI）
     */
    async function translateInBackground(data, currentFile) {
        // 檢查是否啟用翻譯
        if (!appConfig?.translate?.enabled) return;

        const number = data.number;
        if (!number) return;

        // 檢查快取
        if (translationCache.has(number)) {
            const cached = translationCache.get(number);
            updateChineseTitleDisplay(cached.result, cached.mode);
            return;
        }

        // 從檔名提取的中文（如果有）
        const chineseFromFile = currentFile?.chineseTitle || null;
        const japaneseTitle = data.title;

        let textToProcess = null;
        let mode = null;

        // 判斷邏輯：日文假名優先（因為日文漢字也會被判定為中文）
        if (japaneseTitle && hasJapanese(japaneseTitle)) {
            // 標題有日文假名 → 翻譯模式
            textToProcess = japaneseTitle;
            mode = 'translate';
        } else if (chineseFromFile) {
            // 檔名有中文（且標題無日文） → 優化模式
            textToProcess = chineseFromFile;
            mode = 'optimize';
        }

        if (!textToProcess) return;

        // 調用翻譯 API
        const result = await translateWithOllama(textToProcess, mode, {
            actors: data.actors,
            number: number
        });

        if (result.success) {
            // 快取結果
            translationCache.set(number, { result: result.result, mode: mode });
            // 更新 UI（只有當前顯示的番號才更新）
            const currentNumber = document.getElementById('resultNumber').textContent;
            if (currentNumber === number) {
                updateChineseTitleDisplay(result.result, mode);
            }
        } else {
            // 顯示錯誤提示
            console.warn('翻譯失敗:', result.error);
            showTranslateError(result.error);
        }
    }

    /**
     * 更新中文標題顯示（含來源標示）
     */
    function updateChineseTitleDisplay(text, mode) {
        const chineseTitleRow = document.getElementById('chineseTitleRow');
        const chineseTitleLabel = document.getElementById('chineseTitleLabel');
        const chineseTitleEl = document.getElementById('resultChineseTitle');

        if (text) {
            chineseTitleEl.textContent = text;
            // 更新標籤
            if (mode === 'translate') {
                chineseTitleLabel.textContent = '中文片名 (翻譯)';
            } else if (mode === 'optimize') {
                chineseTitleLabel.textContent = '中文片名 (優化)';
            } else {
                chineseTitleLabel.textContent = '中文片名';
            }
            chineseTitleRow.classList.remove('d-none');
        }
    }

    /**
     * 顯示翻譯錯誤（短暫提示）
     */
    function showTranslateError(error) {
        const chineseTitleLabel = document.getElementById('chineseTitleLabel');
        const originalText = chineseTitleLabel.textContent;
        chineseTitleLabel.innerHTML = `中文片名 <span class="text-danger">(${error})</span>`;
        // 3 秒後恢復
        setTimeout(() => {
            if (chineseTitleLabel.innerHTML.includes(error)) {
                chineseTitleLabel.textContent = originalText;
            }
        }, 3000);
    }

    // === 狀態保存/還原 ===
    const STATE_KEY = 'javhelper_search_state';

    function saveState() {
        const state = {
            searchResults,
            currentIndex,
            currentQuery,
            currentOffset,
            hasMoreResults,
            fileList,
            currentFileIndex,
            listMode,
            queryValue: queryInput.value
        };
        sessionStorage.setItem(STATE_KEY, JSON.stringify(state));
    }

    function restoreState() {
        const saved = sessionStorage.getItem(STATE_KEY);
        if (!saved) return false;

        try {
            const state = JSON.parse(saved);
            searchResults = state.searchResults || [];
            currentIndex = state.currentIndex || 0;
            currentQuery = state.currentQuery || '';
            currentOffset = state.currentOffset || 0;
            hasMoreResults = state.hasMoreResults || false;
            fileList = state.fileList || [];
            currentFileIndex = state.currentFileIndex || 0;
            listMode = state.listMode || null;
            queryInput.value = state.queryValue || '';

            // 有內容才還原顯示
            if (searchResults.length > 0) {
                displayResult(searchResults[currentIndex]);
                updateNavigation();
                showState('result');

                if (listMode === 'search') {
                    renderSearchResultsList();
                } else if (listMode === 'file') {
                    renderFileList();
                }
                updateClearButton();
                return true;
            } else if (fileList.length > 0 && listMode === 'file') {
                renderFileList();
                updateClearButton();
                // 如果當前檔案有結果，顯示它
                const currentFile = fileList[currentFileIndex];
                if (currentFile && currentFile.searchResults && currentFile.searchResults.length > 0) {
                    searchResults = currentFile.searchResults;
                    hasMoreResults = currentFile.hasMoreResults || false;
                    displayResult(searchResults[currentIndex]);
                    updateNavigation();
                    showState('result');
                    return true;
                }
            }
        } catch (e) {
            console.error('還原狀態失敗:', e);
            sessionStorage.removeItem(STATE_KEY);
        }
        return false;
    }

    function clearState() {
        sessionStorage.removeItem(STATE_KEY);
    }

    function clearAll() {
        searchResults = [];
        currentIndex = 0;
        currentQuery = '';
        currentOffset = 0;
        hasMoreResults = false;
        fileList = [];
        currentFileIndex = 0;
        listMode = null;
        queryInput.value = '';

        showState('empty');
        fileListSection.classList.add('d-none');
        updateClearButton();
        clearState();
    }

    function updateClearButton() {
        const hasContent = searchResults.length > 0 || fileList.length > 0;
        btnClear.classList.toggle('d-none', !hasContent);
    }

    // 離開頁面前保存狀態
    window.addEventListener('beforeunload', saveState);

    function showState(state) {
        emptyState.classList.add('d-none');
        loadingState.classList.add('d-none');
        resultCard.classList.add('d-none');
        errorState.classList.add('d-none');

        if (state === 'empty') emptyState.classList.remove('d-none');
        else if (state === 'loading') loadingState.classList.remove('d-none');
        else if (state === 'result') resultCard.classList.remove('d-none');
        else if (state === 'error') errorState.classList.remove('d-none');
    }

    function displayResult(data) {
        document.getElementById('resultNumber').textContent = data.number || '-';
        document.getElementById('resultTitle').textContent = data.title || '-';
        document.getElementById('resultActors').textContent = (data.actors || []).join(', ') || '-';
        document.getElementById('resultDate').textContent = data.date || '-';
        document.getElementById('resultMaker').textContent = data.maker || '-';

        // 更新日文標題編輯按鈕狀態
        updateEditButtonState('editTitleBtn', data._titleEdited || false);

        // 取得當前檔案資訊（如果是檔案模式）
        const currentFile = (listMode === 'file' && fileList[currentFileIndex]) ? fileList[currentFileIndex] : null;
        const hasSubtitle = currentFile ? currentFile.hasSubtitle : false;
        const chineseTitle = currentFile ? currentFile.chineseTitle : null;

        // 標籤（全部顯示）+ 字幕標籤
        const tagsContainer = document.getElementById('resultTags');
        const tags = data.tags || [];
        let tagsHtml = '';

        // 優先顯示字幕標籤（綠色）
        if (hasSubtitle) {
            tagsHtml += '<span class="badge tag-badge subtitle">中文字幕</span>';
        }

        // 其他標籤
        if (tags.length > 0) {
            tagsHtml += tags.map(tag =>
                `<span class="badge tag-badge">${tag}</span>`
            ).join('');
        }

        if (tagsHtml) {
            tagsContainer.innerHTML = tagsHtml;
        } else {
            tagsContainer.textContent = '-';
        }

        // 中文標題（優先順序：AI 翻譯 > 檔名提取）
        const chineseTitleRow = document.getElementById('chineseTitleRow');
        const chineseTitleLabel = document.getElementById('chineseTitleLabel');
        const chineseTitleEl = document.getElementById('resultChineseTitle');

        // 檢查是否有 AI 翻譯結果
        const translatedTitle = data.translated_title || null;

        if (translatedTitle) {
            // 優先顯示 AI 翻譯
            chineseTitleLabel.textContent = '中文片名 (AI)';
            chineseTitleEl.textContent = translatedTitle;
            chineseTitleRow.classList.remove('d-none');
            updateEditButtonState('editChineseTitleBtn', data._chineseTitleEdited || false);
        } else if (chineseTitle) {
            // 其次顯示檔名提取的中文
            chineseTitleLabel.textContent = '中文片名';
            chineseTitleEl.textContent = chineseTitle;
            chineseTitleRow.classList.remove('d-none');
            updateEditButtonState('editChineseTitleBtn', false);
        } else {
            chineseTitleLabel.textContent = '中文片名';
            chineseTitleRow.classList.add('d-none');
        }

        // 封面
        const coverImg = document.getElementById('resultCover');
        if (data.cover) {
            coverImg.src = `/api/proxy-image?url=${encodeURIComponent(data.cover)}`;
            coverImg.style.display = 'block';
        } else {
            coverImg.src = '';
            coverImg.style.display = 'none';
        }

        // AI 翻譯按鈕：只在沒有中文片名 + 沒有翻譯結果 + 翻譯啟用 + 日文標題時顯示
        const translateBtn = document.getElementById('translateBtn');
        const translateSpinner = document.getElementById('translateSpinner');
        translateSpinner.classList.add('d-none');  // 重置 spinner

        const shouldShowTranslateBtn = appConfig?.translate?.enabled &&
            !chineseTitle &&
            !translatedTitle &&
            data.title &&
            hasJapanese(data.title);

        if (shouldShowTranslateBtn) {
            translateBtn.classList.remove('d-none');
            translateBtn.dataset.title = data.title;
            translateBtn.dataset.actors = JSON.stringify(data.actors || []);
            translateBtn.dataset.number = data.number || '';
            // 翻譯中則 disabled（灰色）
            translateBtn.disabled = isTranslating;
        } else {
            translateBtn.classList.add('d-none');
            translateBtn.disabled = false;
        }
    }

    // 顯示封面區錯誤（用 SVG 佔位圖）
    function displayCoverError(message) {
        const coverImg = document.getElementById('resultCover');

        // 生成 SVG 錯誤圖片
        const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="800" height="538" viewBox="0 0 800 538">
                <rect fill="#f8f9fa" width="800" height="538"/>
                <text x="400" y="230" text-anchor="middle" fill="#ffc107" font-size="80">⚠</text>
                <text x="400" y="300" text-anchor="middle" fill="#dc3545" font-size="20" font-family="sans-serif">${message.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</text>
                <text x="400" y="330" text-anchor="middle" fill="#6c757d" font-size="14" font-family="sans-serif">請檢查番號格式或稍後再試</text>
            </svg>
        `;
        coverImg.src = 'data:image/svg+xml,' + encodeURIComponent(svg);
        coverImg.style.display = 'block';

        // 清空資訊區
        document.getElementById('resultNumber').textContent = '-';
        document.getElementById('resultTitle').textContent = '-';
        document.getElementById('resultActors').textContent = '-';
        document.getElementById('resultDate').textContent = '-';
        document.getElementById('resultMaker').textContent = '-';
        document.getElementById('resultTags').textContent = '-';

        // 隱藏中文片名
        document.getElementById('chineseTitleRow').classList.add('d-none');
        document.getElementById('chineseTitleLabel').textContent = '中文片名';

        // 隱藏 AI 翻譯按鈕
        document.getElementById('translateBtn').classList.add('d-none');
        document.getElementById('translateSpinner').classList.add('d-none');

        // 重置編輯按鈕狀態
        updateEditButtonState('editTitleBtn', false);
        updateEditButtonState('editChineseTitleBtn', false);
    }

    // ========== 標題編輯功能 ==========

    // HTML 跳脫
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 更新編輯按鈕的圖示狀態
    function updateEditButtonState(btnId, isEdited) {
        const btn = document.getElementById(btnId);
        if (!btn) return;
        const icon = btn.querySelector('i');
        if (icon) {
            if (isEdited) {
                icon.className = 'bi bi-pencil-fill text-success';
            } else {
                icon.className = 'bi bi-pencil text-muted';
            }
        }
    }

    // 開始編輯日文標題
    function startEditTitle() {
        const container = document.getElementById('titleContainer');
        const span = document.getElementById('resultTitle');
        const currentText = span.textContent;

        // 隱藏翻譯按鈕和 spinner
        const translateBtn = document.getElementById('translateBtn');
        const translateSpinner = document.getElementById('translateSpinner');
        translateBtn.classList.add('d-none');
        translateSpinner.classList.add('d-none');

        // 替換成編輯模式
        container.innerHTML = `
            <input type="text" id="editTitleInput" class="form-control form-control-sm" value="${escapeHtml(currentText)}" style="flex:1;" />
            <button class="btn btn-sm btn-link p-0 ms-1 text-success" onclick="confirmEditTitle()" title="確認">
                <i class="bi bi-check-lg"></i>
            </button>
            <button class="btn btn-sm btn-link p-0 ms-1 text-danger" onclick="cancelEditTitle()" title="取消">
                <i class="bi bi-x-lg"></i>
            </button>
        `;
        const input = document.getElementById('editTitleInput');
        input.focus();
        input.select();

        // Enter 確認, Escape 取消
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') confirmEditTitle();
            else if (e.key === 'Escape') cancelEditTitle();
        });
    }

    // 確認編輯日文標題
    function confirmEditTitle() {
        const input = document.getElementById('editTitleInput');
        const newValue = input.value.trim();

        // 更新 searchResults
        const file = fileList[currentFileIndex];
        if (file?.searchResults?.[currentIndex]) {
            file.searchResults[currentIndex].title = newValue;
            file.searchResults[currentIndex]._titleEdited = true;
        }

        restoreTitleDisplay(newValue, true);
        saveState();
    }

    // 取消編輯日文標題
    function cancelEditTitle() {
        const file = fileList[currentFileIndex];
        const result = file?.searchResults?.[currentIndex];
        const originalText = result?.title || '-';
        const isEdited = result?._titleEdited || false;
        restoreTitleDisplay(originalText, isEdited);
    }

    // 還原日文標題顯示
    function restoreTitleDisplay(text, edited) {
        const container = document.getElementById('titleContainer');
        const file = fileList[currentFileIndex];
        const result = file?.searchResults?.[currentIndex];
        const chineseTitle = file?.chineseTitle;
        const translatedTitle = result?.translated_title;

        // 決定是否顯示翻譯按鈕
        const shouldShowTranslateBtn = appConfig?.translate?.enabled &&
            !chineseTitle && !translatedTitle && text && text !== '-' && hasJapanese(text);

        container.innerHTML = `
            <span id="resultTitle" style="flex:1;">${escapeHtml(text)}</span>
            <button id="editTitleBtn" class="btn btn-sm btn-link p-0 ms-1" onclick="startEditTitle()" title="編輯標題">
                <i class="bi ${edited ? 'bi-pencil-fill text-success' : 'bi-pencil text-muted'}"></i>
            </button>
            <button id="translateBtn" class="btn btn-sm btn-link p-0 ms-1 ${shouldShowTranslateBtn ? '' : 'd-none'}"
                    onclick="translateWithAI()" title="AI 翻譯">
                <i class="bi bi-translate"></i>
            </button>
            <span id="translateSpinner" class="spinner-border spinner-border-sm ms-1 d-none"></span>
        `;

        if (shouldShowTranslateBtn) {
            const btn = document.getElementById('translateBtn');
            btn.dataset.title = text;
            btn.dataset.actors = JSON.stringify(result?.actors || []);
            btn.dataset.number = result?.number || '';
        }
    }

    // 開始編輯中文標題
    function startEditChineseTitle() {
        const container = document.getElementById('chineseTitleContainer');
        const span = document.getElementById('resultChineseTitle');
        const currentText = span.textContent;

        container.innerHTML = `
            <input type="text" id="editChineseTitleInput" class="form-control form-control-sm text-success" value="${escapeHtml(currentText)}" style="flex:1;" />
            <button class="btn btn-sm btn-link p-0 ms-1 text-success" onclick="confirmEditChineseTitle()" title="確認">
                <i class="bi bi-check-lg"></i>
            </button>
            <button class="btn btn-sm btn-link p-0 ms-1 text-danger" onclick="cancelEditChineseTitle()" title="取消">
                <i class="bi bi-x-lg"></i>
            </button>
        `;
        const input = document.getElementById('editChineseTitleInput');
        input.focus();
        input.select();

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') confirmEditChineseTitle();
            else if (e.key === 'Escape') cancelEditChineseTitle();
        });
    }

    // 確認編輯中文標題
    function confirmEditChineseTitle() {
        const input = document.getElementById('editChineseTitleInput');
        const newValue = input.value.trim();

        // 更新 searchResults（存入 translated_title）
        const file = fileList[currentFileIndex];
        if (file?.searchResults?.[currentIndex]) {
            file.searchResults[currentIndex].translated_title = newValue;
            file.searchResults[currentIndex]._chineseTitleEdited = true;
        }

        restoreChineseTitleDisplay(newValue, true);
        saveState();
    }

    // 取消編輯中文標題
    function cancelEditChineseTitle() {
        const file = fileList[currentFileIndex];
        const result = file?.searchResults?.[currentIndex];
        const translatedTitle = result?.translated_title;
        const chineseTitle = file?.chineseTitle;
        const originalText = translatedTitle || chineseTitle || '-';
        const isEdited = result?._chineseTitleEdited || false;
        restoreChineseTitleDisplay(originalText, isEdited);
    }

    // 還原中文標題顯示
    function restoreChineseTitleDisplay(text, edited) {
        const container = document.getElementById('chineseTitleContainer');
        container.innerHTML = `
            <span id="resultChineseTitle" class="text-success" style="flex:1;">${escapeHtml(text)}</span>
            <button id="editChineseTitleBtn" class="btn btn-sm btn-link p-0 ms-1" onclick="startEditChineseTitle()" title="編輯中文片名">
                <i class="bi ${edited ? 'bi-pencil-fill text-success' : 'bi-pencil text-muted'}"></i>
            </button>
        `;
    }

    // 暴露編輯函數到全域（供 onclick 調用）
    window.startEditTitle = startEditTitle;
    window.confirmEditTitle = confirmEditTitle;
    window.cancelEditTitle = cancelEditTitle;
    window.startEditChineseTitle = startEditChineseTitle;
    window.confirmEditChineseTitle = confirmEditChineseTitle;
    window.cancelEditChineseTitle = cancelEditChineseTitle;

    // ========== 結束標題編輯功能 ==========

    // ========== 手動輸入番號功能 ==========

    /**
     * 格式化番號（標準化格式）
     */
    function formatNumber(input) {
        if (!input) return null;
        // 嘗試標準化番號格式
        const match = input.match(/([A-Z]{1,5})-?(\d{3,7})/i);
        if (match) {
            return `${match[1].toUpperCase()}-${match[2]}`;
        }
        // FC2 特殊處理
        const fc2Match = input.match(/FC2-?PPV-?(\d{5,7})/i);
        if (fc2Match) {
            return `FC2-PPV-${fc2Match[1]}`;
        }
        return input.toUpperCase();
    }

    /**
     * 手動輸入番號
     */
    function enterNumber(index) {
        const file = fileList[index];
        if (!file) return;

        const number = prompt('請輸入番號（例如：T28-650）', '');
        if (!number || !number.trim()) return;

        // 格式化番號
        const formatted = formatNumber(number.trim());
        file.number = formatted;
        file.searched = false;  // 重置搜尋狀態
        file.searchResults = [];  // 清空舊結果

        // 切換到該檔案並搜尋
        switchToFile(index, 'first', true);
    }

    // 暴露到全域
    window.enterNumber = enterNumber;

    // ========== 結束手動輸入番號功能 ==========

    // 預加載圖片（避免切換時延遲）
    function preloadImages(startIndex, count = 5) {
        for (let i = startIndex; i < Math.min(startIndex + count, searchResults.length); i++) {
            if (searchResults[i] && searchResults[i].cover) {
                const img = new Image();
                img.src = `/api/proxy-image?url=${encodeURIComponent(searchResults[i].cover)}`;
            }
        }
    }

    function updateNavigation() {
        // 多檔案模式或多結果時都顯示導航
        const hasMultipleResults = searchResults.length > 1 || hasMoreResults;
        const hasMultipleFiles = fileList.length > 1;
        const showNav = hasMultipleResults || hasMultipleFiles;

        btnPrev.classList.toggle('d-none', !showNav);
        btnNext.classList.toggle('d-none', !showNav);
        navIndicator.classList.toggle('d-none', !showNav);

        // 判斷是否可往左（有前一個結果，或有前一個檔案）
        const canGoPrev = currentIndex > 0 || currentFileIndex > 0;
        // 判斷是否可往右（有後續結果、更多結果、或後續檔案）
        const canGoNext = currentIndex < searchResults.length - 1 || hasMoreResults || currentFileIndex < fileList.length - 1;

        if (showNav) {
            // 多檔案模式：顯示檔案索引
            if (fileList.length > 1) {
                currentIndexSpan.textContent = currentFileIndex + 1;
                totalCountSpan.textContent = fileList.length;
            } else {
                // 單檔案模式：顯示搜尋結果索引
                currentIndexSpan.textContent = currentIndex + 1;
                totalCountSpan.textContent = hasMoreResults
                    ? searchResults.length + '+'
                    : searchResults.length;
            }

            btnPrev.disabled = !canGoPrev;
            btnNext.disabled = !canGoNext;
        }

        // 更新 error 狀態的導航按鈕（多檔案模式）
        if (hasMultipleFiles) {
            errorNav.classList.remove('d-none');
            errorNavIndicator.textContent = `${currentFileIndex + 1}/${fileList.length}`;
            errorBtnPrev.disabled = !canGoPrev;
            errorBtnNext.disabled = !canGoNext;
        } else {
            errorNav.classList.add('d-none');
        }
    }

    function navigateResult(delta) {
        const newIndex = currentIndex + delta;

        // 往左且已在第一個 → 切換到上一個檔案
        if (delta < 0 && newIndex < 0) {
            if (currentFileIndex > 0) {
                switchToFile(currentFileIndex - 1, 'last');  // 切到上一個檔案的最後一個結果
            }
            return;
        }

        // 往右且到最後一個
        if (delta > 0 && newIndex >= searchResults.length) {
            // 先嘗試載入更多結果
            if (hasMoreResults && !isLoadingMore) {
                loadMoreResults();
                return;
            }
            // 沒有更多結果了，切換到下一個檔案
            if (currentFileIndex < fileList.length - 1) {
                switchToFile(currentFileIndex + 1, 'first');
                return;
            }
            return;
        }

        if (newIndex >= 0 && newIndex < searchResults.length) {
            currentIndex = newIndex;
            displayResult(searchResults[currentIndex]);
            updateNavigation();
            preloadImages(currentIndex + 1, 3);
            // 搜尋模式下更新列表高亮
            if (listMode === 'search') {
                renderSearchResultsList();
            }
        }
    }

    // 載入更多結果
    async function loadMoreResults() {
        if (isLoadingMore || !hasMoreResults || !currentQuery) return;

        isLoadingMore = true;
        const newOffset = currentOffset + PAGE_SIZE;

        // 顯示載入中狀態在 Next 按鈕
        btnNext.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        btnNext.disabled = true;

        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(currentQuery)}&offset=${newOffset}&limit=${PAGE_SIZE}`);
            const data = await response.json();

            if (response.ok && data.success && data.data && data.data.length > 0) {
                // 追加新結果
                searchResults = searchResults.concat(data.data);
                currentOffset = newOffset;
                hasMoreResults = data.has_more;

                // 自動移到下一個（新載入的第一個）
                currentIndex = searchResults.length - data.data.length;
                displayResult(searchResults[currentIndex]);
                updateNavigation();

                // 預加載新圖片
                preloadImages(currentIndex + 1, 5);

                // 更新搜尋結果列表
                if (listMode === 'search') {
                    renderSearchResultsList();
                }
            } else {
                // 沒有更多結果了
                hasMoreResults = false;
                updateNavigation();
            }
        } catch (err) {
            console.error('載入更多失敗:', err);
        } finally {
            isLoadingMore = false;
            btnNext.innerHTML = '<i class="bi bi-chevron-right"></i>';
            updateNavigation();
        }
    }

    // === 進度指示器控制 ===
    const progressQuery = document.getElementById('progressQuery');
    const progressLog = document.getElementById('progressLog');
    const detailProgress = document.getElementById('detailProgress');
    const detailBar = document.getElementById('detailBar');
    const detailText = document.getElementById('detailText');

    // 搜尋模式對照
    const MODE_TEXT = {
        'exact': '完整番號搜尋',
        'partial': '部分番號搜尋',
        'prefix': '系列搜尋',
        'actress': '女優搜尋',
        'keyword': '全文搜尋'
    };

    function initProgress(query) {
        progressQuery.textContent = `"${query}"`;
        progressLog.textContent = '搜尋中...';
        detailProgress.classList.remove('show');
    }

    function updateLog(text) {
        progressLog.textContent = text;
    }

    function updateDetailProgress(done, total) {
        if (total > 0) {
            detailProgress.classList.add('show');
            const percent = Math.round((done / total) * 100);
            detailBar.style.width = `${percent}%`;
            detailText.textContent = `${done} / ${total}`;
        }
    }

    // 當前模式
    let currentMode = '';

    function handleSearchStatus(source, status) {
        // 處理模式切換
        if (source === 'mode') {
            currentMode = status;
            updateLog(`${MODE_TEXT[status] || status}...`);
            return;
        }

        // 根據來源和狀態更新日誌
        if (source === 'javbus' || source === 'jav321') {
            if (status === 'searching') {
                updateLog(`${MODE_TEXT[currentMode] || '搜尋'}...`);
            }
            else if (status.startsWith('found:')) {
                const count = status.split(':')[1];
                if (count === '0') {
                    updateLog(`${MODE_TEXT[currentMode] || '搜尋'}：無結果`);
                } else {
                    updateLog(`${MODE_TEXT[currentMode] || '搜尋'}：找到 ${count} 筆`);
                }
            }
            else if (status === 'fetching_details') {
                updateLog('抓取詳情...');
            }
            else if (status.startsWith('details:')) {
                const parts = status.split(':')[1].split('/');
                if (parts.length === 2) {
                    const done = parseInt(parts[0]);
                    const total = parseInt(parts[1]);
                    updateLog(`抓取詳情 ${done}/${total}`);
                    updateDetailProgress(done, total);
                }
            }
            else if (status === 'failed') {
                updateLog(`${MODE_TEXT[currentMode] || '搜尋'}：失敗`);
            }
        }
    }

    // 搜尋表單
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const query = queryInput.value.trim();
        if (!query) return;

        showState('loading');
        initProgress(query);
        searchResults = [];
        currentIndex = 0;

        // 清空多檔案列表（文字搜尋與拖檔搜尋互斥）
        fileList = [];
        currentFileIndex = 0;
        listMode = null;
        fileListSection.classList.add('d-none');

        // 重設分頁狀態
        currentQuery = query;
        currentOffset = 0;
        hasMoreResults = false;

        // 使用 SSE 串流 API
        const eventSource = new EventSource(`/api/search/stream?q=${encodeURIComponent(query)}`);

        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);

                if (data.type === 'mode') {
                    // 設定當前模式並更新日誌
                    currentMode = data.mode;
                    updateLog(`${MODE_TEXT[data.mode] || '搜尋'}...`);
                }
                else if (data.type === 'status') {
                    // 更新進度狀態
                    handleSearchStatus(data.source, data.status);
                }
                else if (data.type === 'result') {
                    // 搜尋完成
                    eventSource.close();

                    if (data.success && data.data && data.data.length > 0) {
                        searchResults = data.data;
                        currentIndex = 0;
                        hasMoreResults = data.has_more || false;
                        displayResult(searchResults[0]);
                        updateNavigation();
                        showState('result');
                        // 預加載前 5 張圖片
                        preloadImages(1, 5);
                        // 顯示搜尋結果列表
                        listMode = 'search';
                        renderSearchResultsList();
                        updateClearButton();
                    } else {
                        document.getElementById('errorMessage').textContent = '找不到資料';
                        showState('error');
                    }
                }
                else if (data.type === 'error') {
                    // 錯誤
                    eventSource.close();
                    document.getElementById('errorMessage').textContent = data.message || '搜尋失敗';
                    showState('error');
                }
            } catch (err) {
                console.error('Parse error:', err);
            }
        };

        eventSource.onerror = function() {
            eventSource.close();
            // 如果 SSE 失敗，回退到傳統 API
            fallbackSearch(query);
        };
    });

    // 傳統 API 回退
    async function fallbackSearch(query) {
        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (response.ok && data.success && data.data && data.data.length > 0) {
                searchResults = data.data;
                currentIndex = 0;
                hasMoreResults = data.has_more || false;  // 設定是否還有更多
                displayResult(searchResults[0]);
                updateNavigation();
                showState('result');
                preloadImages(1, 5);
                // 顯示搜尋結果列表
                listMode = 'search';
                renderSearchResultsList();
                updateClearButton();
            } else {
                document.getElementById('errorMessage').textContent = data.error || '找不到資料';
                showState('error');
            }
        } catch (err) {
            document.getElementById('errorMessage').textContent = '網路錯誤: ' + err.message;
            showState('error');
        }
    }

    // 導航按鈕點擊
    btnPrev.addEventListener('click', () => navigateResult(-1));
    btnNext.addEventListener('click', () => navigateResult(1));

    // Error 狀態導航按鈕點擊（多檔案模式）
    errorBtnPrev.addEventListener('click', () => navigateResult(-1));
    errorBtnNext.addEventListener('click', () => navigateResult(1));

    // 鍵盤導航
    document.addEventListener('keydown', (e) => {
        // 如果正在輸入搜尋框，不處理
        if (document.activeElement === queryInput) return;

        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            navigateResult(-1);
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            navigateResult(1);
        }
    });

    // 清空按鈕點擊
    btnClear.addEventListener('click', clearAll);

    // 初始化：載入設定、還原狀態
    loadAppConfig();  // 背景載入設定（用於翻譯功能）

    if (!restoreState()) {
        queryInput.focus();
    }
    updateClearButton();

    // === 檔案列表功能 ===

    // 渲染檔案列表
    function renderFileList() {
        // 顯示/隱藏檔案列表區
        fileListSection.classList.toggle('d-none', fileList.length === 0);

        fileListContainer.innerHTML = '';
        fileCountText.textContent = `檔案 ${currentFileIndex + 1}/${fileList.length}`;

        // 顯示產生按鈕（拖檔模式）
        btnScrapeAll.classList.remove('d-none');

        fileList.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'file-item' + (index === currentFileIndex ? ' active' : '');

            // 狀態圖標：✓ 有結果、✗ 無結果、? 無番號（可輸入）、空白 未搜尋
            let statusIcon = '';
            let statusClass = 'file-status';
            let canScrape = false;
            let needsNumber = false;
            if (!file.number) {
                statusIcon = '?';
                statusClass += ' text-warning';
                needsNumber = true;
            } else if (file.searched) {
                if (file.searchResults && file.searchResults.length > 0) {
                    statusIcon = '✓';
                    canScrape = true;
                } else {
                    statusIcon = '✗';
                    statusClass += ' text-danger';
                }
            }

            // 按鈕：產生 或 輸入番號
            let actionBtn = '';
            if (canScrape) {
                actionBtn = `<button class="btn btn-outline-success btn-sm btn-scrape-single" data-index="${index}" title="產生此檔案">產生</button>`;
            } else if (needsNumber) {
                actionBtn = `<button class="btn btn-outline-warning btn-sm btn-enter-number" data-index="${index}" title="手動輸入番號"><i class="bi bi-pencil"></i></button>`;
            }

            item.innerHTML = `
                <i class="bi bi-file-earmark-play file-icon"></i>
                <span class="file-name" title="${file.path}">${file.filename}</span>
                <span class="${statusClass}">${statusIcon}</span>
                ${actionBtn}
            `;

            // 點擊檔名切換（排除按鈕區域）
            item.addEventListener('click', (e) => {
                if (!e.target.closest('.btn-scrape-single') && !e.target.closest('.btn-enter-number')) {
                    switchToFile(index, 'first');
                }
            });

            // 產生按鈕事件
            if (canScrape) {
                const btn = item.querySelector('.btn-scrape-single');
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    scrapeSingle(index);
                });
            }

            // 輸入番號按鈕事件
            if (needsNumber) {
                const btn = item.querySelector('.btn-enter-number');
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    enterNumber(index);
                });
            }

            fileListContainer.appendChild(item);
        });
    }

    // 渲染搜尋結果列表（文字搜尋模式）
    function renderSearchResultsList() {
        if (searchResults.length === 0) {
            fileListSection.classList.add('d-none');
            return;
        }

        fileListSection.classList.remove('d-none');
        fileListContainer.innerHTML = '';

        // 更新標題
        const countText = hasMoreResults ? `${searchResults.length}+` : searchResults.length;
        fileCountText.textContent = `搜尋結果 (${countText})`;

        // 隱藏產生按鈕（搜尋模式不需要）
        btnScrapeAll.classList.add('d-none');

        searchResults.forEach((result, index) => {
            const item = document.createElement('div');
            item.className = 'file-item' + (index === currentIndex ? ' active' : '');

            // 格式：番號 + 演員 + 片名（CSS 自動截斷）
            const number = result.number || '';
            const actors = (result.actors || []).slice(0, 2).join(', ') || '-';
            const title = result.title || '';

            item.innerHTML = `
                <span style="flex-shrink:0; font-weight:500; color:#0d6efd; min-width:90px;">${number}</span>
                <span style="flex-shrink:0; min-width:80px; color:#6c757d;">${actors}</span>
                <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${title}</span>
            `;
            item.addEventListener('click', () => switchToSearchResult(index));
            fileListContainer.appendChild(item);
        });
    }

    // 切換到搜尋結果（文字搜尋模式）
    function switchToSearchResult(index) {
        if (index < 0 || index >= searchResults.length) return;
        currentIndex = index;
        displayResult(searchResults[currentIndex]);
        updateNavigation();
        renderSearchResultsList();  // 更新高亮
    }

    // 切換到指定檔案（懶加載搜尋）
    // position: 'first' 顯示第一個結果, 'last' 顯示最後一個結果
    // showFullLoading: true 顯示全畫面 loading（首次拖入時）
    async function switchToFile(index, position = 'first', showFullLoading = false) {
        if (index < 0 || index >= fileList.length) return;

        currentFileIndex = index;
        const file = fileList[index];

        // 無番號檔案：在封面區顯示錯誤（保留列表）
        if (!file.number) {
            renderFileList();  // 更新列表高亮
            searchResults = [];
            hasMoreResults = false;
            currentIndex = 0;
            displayCoverError(`無法識別番號: ${file.filename}`);
            showState('result');  // 顯示 resultCard 以保留列表
            updateNavigation();
            return;
        }

        // 如果還沒搜尋過，執行搜尋
        // 注意：不在此處呼叫 renderFileList()，避免 race condition
        // searchForFile() 完成後會自行呼叫 renderFileList()
        if (!file.searched) {
            await searchForFile(file, position, showFullLoading);
        } else if (file.searchResults && file.searchResults.length > 0) {
            // 已有結果，直接顯示
            renderFileList();  // 更新列表高亮
            searchResults = file.searchResults;
            hasMoreResults = file.hasMoreResults || false;
            currentIndex = position === 'last' ? searchResults.length - 1 : 0;
            displayResult(searchResults[currentIndex]);
            updateNavigation();
            showState('result');
        } else {
            // 已搜尋但無結果：在封面區顯示錯誤（保留列表）
            renderFileList();  // 更新列表高亮
            searchResults = [];
            hasMoreResults = false;
            currentIndex = 0;
            displayCoverError(`找不到 ${file.number} 的資料`);
            showState('result');  // 顯示 resultCard 以保留列表
            updateNavigation();
        }
    }

    // 為檔案執行搜尋
    // position: 'first' 顯示第一個結果, 'last' 顯示最後一個結果
    // showFullLoading: true 顯示全畫面 loading（首次拖入時）, false 只顯示箭頭轉圈
    async function searchForFile(file, position = 'first', showFullLoading = false) {
        // 判斷是往左還是往右切換
        const isGoingNext = position === 'first';
        const targetBtn = isGoingNext ? btnNext : btnPrev;
        const originalBtnHtml = targetBtn.innerHTML;

        if (showFullLoading) {
            showState('loading');
            initProgress(file.number);
        } else {
            // 只在箭頭按鈕上顯示轉圈
            targetBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            targetBtn.disabled = true;
        }

        const eventSource = new EventSource(`/api/search/stream?q=${encodeURIComponent(file.number)}`);

        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);

                if (data.type === 'mode') {
                    currentMode = data.mode;
                    updateLog(`${MODE_TEXT[data.mode] || '搜尋'}...`);
                }
                else if (data.type === 'status') {
                    handleSearchStatus(data.source, data.status);
                }
                else if (data.type === 'result') {
                    eventSource.close();

                    // 恢復按鈕狀態
                    if (!showFullLoading) {
                        targetBtn.innerHTML = originalBtnHtml;
                        targetBtn.disabled = false;
                    }

                    // 確保維持檔案模式（防止被其他代碼覆蓋）
                    listMode = 'file';

                    if (data.success && data.data && data.data.length > 0) {
                        // 儲存完整結果到檔案物件
                        file.searchResults = data.data;
                        file.hasMoreResults = data.has_more || false;
                        file.searched = true;

                        searchResults = data.data;
                        hasMoreResults = file.hasMoreResults;
                        currentIndex = position === 'last' ? searchResults.length - 1 : 0;
                        displayResult(searchResults[currentIndex]);
                        updateNavigation();
                        showState('result');

                        // 更新列表顯示
                        renderFileList();
                    } else {
                        file.searched = true;
                        file.searchResults = [];
                        displayCoverError(`找不到 ${file.number} 的資料`);
                        showState('result');  // 保留列表
                        renderFileList();
                        updateNavigation();
                    }
                }
                else if (data.type === 'error') {
                    eventSource.close();
                    // 恢復按鈕狀態
                    if (!showFullLoading) {
                        targetBtn.innerHTML = originalBtnHtml;
                        targetBtn.disabled = false;
                    }
                    file.searched = true;
                    file.searchResults = [];
                    displayCoverError(data.message || '搜尋失敗');
                    showState('result');  // 保留列表
                    renderFileList();
                    updateNavigation();
                }
            } catch (err) {
                console.error('Parse error:', err);
            }
        };

        eventSource.onerror = function() {
            eventSource.close();
            // 恢復按鈕狀態
            if (!showFullLoading) {
                targetBtn.innerHTML = originalBtnHtml;
                targetBtn.disabled = false;
            }
            file.searched = true;
            file.searchResults = [];
            displayCoverError('連線錯誤，請稍後再試');
            showState('result');  // 保留列表
            renderFileList();
            updateNavigation();
        };
    }

    // 設定檔案列表（從 PyWebView 接收）
    function setFileList(paths) {
        fileList = paths.map(path => {
            const filename = path.split(/[/\\]/).pop();
            const number = extractNumber(path);
            return {
                path: path,
                filename: filename,
                number: number,
                hasSubtitle: checkSubtitle(filename),
                chineseTitle: extractChineseTitle(filename, number),
                searchResults: [],
                hasMoreResults: false,
                searched: false
            };
        });
        currentFileIndex = 0;
        listMode = 'file';

        renderFileList();
        updateClearButton();

        // 自動處理第一個檔案
        if (fileList.length > 0) {
            if (fileList[0].number) {
                queryInput.value = fileList[0].number;
            }
            switchToFile(0, 'first', true);  // showFullLoading = true
        }
    }

    // 監聽 PyWebView 檔案事件
    window.addEventListener('pywebview-files', (e) => {
        setFileList(e.detail.paths);
    });

    // 執行單檔 Scraper（核心函數）
    async function scrapeFile(file, metadata) {
        const response = await fetch('/api/scrape-single', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                file_path: file.path,
                number: metadata.number,
                metadata: metadata
            })
        });
        return await response.json();
    }

    // 產生單片（從列表按鈕觸發）
    async function scrapeSingle(index) {
        const file = fileList[index];
        if (!file || !file.searchResults || file.searchResults.length === 0) {
            alert('此檔案沒有搜尋結果');
            return;
        }

        // 使用第一個搜尋結果
        const metadata = { ...file.searchResults[0] };

        // 找到對應的按鈕並顯示 loading
        const btn = fileListContainer.querySelector(`[data-index="${index}"]`);
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        }

        try {
            // 翻譯邏輯：只有沒有中文標題時才需要翻譯
            const chineseFromFile = file.chineseTitle;
            if (appConfig?.translate?.enabled && !chineseFromFile && metadata.title && hasJapanese(metadata.title)) {
                // 檔名沒有中文 + 標題是日文 → 翻譯
                const tr = await translateWithOllama(metadata.title, 'translate', metadata);
                if (tr.success) metadata.translated_title = tr.result;
            }

            const result = await scrapeFile(file, metadata);
            if (result.success) {
                // 標記已處理
                file.scraped = true;
                if (btn) {
                    btn.innerHTML = '<i class="bi bi-check"></i>';
                    btn.classList.remove('btn-outline-success');
                    btn.classList.add('btn-success');
                    btn.disabled = true;
                }
            } else {
                alert(`${file.filename} 處理失敗: ${result.error || '未知錯誤'}`);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '產生';
                }
            }
        } catch (err) {
            alert(`${file.filename} 處理失敗: ${err.message}`);
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '產生';
            }
        }
    }

    // 產生全部（批次處理）
    async function scrapeAll() {
        // 過濾出可處理的檔案
        const scrapableFiles = fileList.filter(f =>
            f.searched && f.searchResults && f.searchResults.length > 0 && !f.scraped
        );

        if (scrapableFiles.length === 0) {
            alert('沒有可處理的檔案');
            return;
        }

        // 顯示處理中狀態
        btnScrapeAll.disabled = true;
        const originalHtml = btnScrapeAll.innerHTML;
        btnScrapeAll.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        let successCount = 0;
        let failCount = 0;

        for (const file of scrapableFiles) {
            const index = fileList.indexOf(file);
            const metadata = { ...file.searchResults[0] };

            // 更新列表按鈕狀態
            const btn = fileListContainer.querySelector(`[data-index="${index}"]`);
            if (btn) {
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                btn.disabled = true;
            }

            try {
                // 翻譯邏輯：只有沒有中文標題時才需要翻譯
                const chineseFromFile = file.chineseTitle;
                if (appConfig?.translate?.enabled && !chineseFromFile && metadata.title && hasJapanese(metadata.title)) {
                    // 檔名沒有中文 + 標題是日文 → 翻譯
                    const tr = await translateWithOllama(metadata.title, 'translate', metadata);
                    if (tr.success) metadata.translated_title = tr.result;
                }

                const result = await scrapeFile(file, metadata);
                if (result.success) {
                    file.scraped = true;
                    successCount++;
                    if (btn) {
                        btn.innerHTML = '<i class="bi bi-check"></i>';
                        btn.classList.remove('btn-outline-success');
                        btn.classList.add('btn-success');
                    }
                } else {
                    failCount++;
                    if (btn) {
                        btn.innerHTML = '失敗';
                        btn.classList.remove('btn-outline-success');
                        btn.classList.add('btn-outline-danger');
                    }
                }
            } catch (err) {
                failCount++;
                if (btn) {
                    btn.innerHTML = '失敗';
                    btn.classList.remove('btn-outline-success');
                    btn.classList.add('btn-outline-danger');
                }
            }
        }

        // 完成提示
        btnScrapeAll.innerHTML = '<i class="bi bi-check-circle"></i>';
        btnScrapeAll.classList.remove('btn-success');
        btnScrapeAll.classList.add('btn-outline-success');

        alert(`批次處理完成!\n成功: ${successCount}\n失敗: ${failCount}`);

        // 重置按鈕
        setTimeout(() => {
            btnScrapeAll.innerHTML = originalHtml;
            btnScrapeAll.classList.remove('btn-outline-success');
            btnScrapeAll.classList.add('btn-success');
            btnScrapeAll.disabled = false;
        }, 2000);
    }

    btnScrapeAll.addEventListener('click', scrapeAll);

    // === 加入檔案/資料夾按鈕 ===
    const btnAddFiles = document.getElementById('btnAddFiles');
    const btnAddFolder = document.getElementById('btnAddFolder');

    btnAddFiles.addEventListener('click', async () => {
        // 檢查是否在 PyWebView 環境
        if (typeof window.pywebview === 'undefined' || !window.pywebview.api) {
            alert('此功能需要在桌面應用程式中使用');
            return;
        }
        try {
            const paths = await window.pywebview.api.select_files();
            if (paths && paths.length > 0) {
                console.log('選取檔案:', paths.length, '個');
                window.handlePyWebViewDrop(paths);
            }
        } catch (e) {
            console.error('選取檔案失敗:', e);
        }
    });

    btnAddFolder.addEventListener('click', async () => {
        // 檢查是否在 PyWebView 環境
        if (typeof window.pywebview === 'undefined' || !window.pywebview.api) {
            alert('此功能需要在桌面應用程式中使用');
            return;
        }
        try {
            const paths = await window.pywebview.api.select_folder();
            if (paths && paths.length > 0) {
                console.log('資料夾內檔案:', paths.length, '個');
                window.handlePyWebViewDrop(paths);
            }
        } catch (e) {
            console.error('選取資料夾失敗:', e);
        }
    });

    // === 拖拽搜尋功能 ===
    const dragOverlay = document.getElementById('dragOverlay');
    let dragCounter = 0;

    /**
     * 檢查檔名是否包含字幕標記
     */
    function checkSubtitle(filename) {
        if (!filename) return false;
        const upper = filename.toUpperCase();

        // 英文標記（需確保不是番號的一部分）
        const patterns = ['-C', '_C'];
        for (const p of patterns) {
            const idx = upper.indexOf(p);
            if (idx !== -1) {
                const nextIdx = idx + p.length;
                // 後面不是字母數字才算
                if (nextIdx >= upper.length || !/[A-Z0-9]/i.test(upper[nextIdx])) {
                    return true;
                }
            }
        }

        // 中文標記
        const chinesePatterns = ['中文字幕', '字幕', '中字', '[中字]', '【中字】'];
        for (const p of chinesePatterns) {
            if (filename.includes(p)) return true;
        }

        return false;
    }

    /**
     * 檢查文字是否包含中文
     */
    function hasChinese(text) {
        if (!text) return false;
        return /[\u4e00-\u9fff]/.test(text);
    }

    /**
     * 清除無意義的來源後綴
     */
    function cleanSourceSuffix(text) {
        const patterns = [
            /\s*-\s*Jable\s*TV.*$/i,
            /\s*-\s*Jable.*$/i,
            /\s*-\s*Hayav\s*AV.*$/i,
            /\s*-\s*Hayav.*$/i,
            /\s*-\s*MissAV.*$/i,
            /\s*-\s*J片.*$/i,
            /\s*-\s*免費.*$/i,
            /\s*-\s*Netflav.*$/i,
            /\s*-\s*AV看到飽.*$/i,
            /\s*-\s*Free\s*Japan.*$/i,
            /\s*-\s*Streaming.*$/i,
            /\s*-\s*[A-Za-z]{1,3}\.?$/,
            /\s*-\s*$/,
            /\s+-\d+$/,
        ];
        for (const p of patterns) {
            text = text.replace(p, '');
        }
        return text.trim();
    }

    /**
     * 從檔名提取中文片名
     */
    function extractChineseTitle(filename, number, actors = []) {
        if (!filename) return null;

        // 移除副檔名
        let name = filename.replace(/\.[^.]+$/, '');

        // 移除番號（各種格式）
        if (number) {
            const escapedNum = number.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&');
            name = name.replace(new RegExp(`\\[?${escapedNum}\\]?\\s*`, 'gi'), '');
        }
        name = name.replace(/\[?[A-Za-z]{2,6}-?\d{3,5}\]?\s*/g, '');

        // 清除來源後綴
        name = cleanSourceSuffix(name);

        // 清理多餘空格
        name = name.replace(/\s+/g, ' ').trim();

        // 移除開頭的「中文字幕」標記
        name = name.replace(/^中文字幕\s*/, '');

        // 移除開頭和結尾的演員名
        if (actors && actors.length > 0) {
            for (const actor of actors) {
                const escapedActor = actor.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&');
                name = name.replace(new RegExp(`^${escapedActor}\\s*-\\s*`, ''), '');
                name = name.replace(new RegExp(`\\s+${escapedActor}$`, ''), '');
            }
        }

        // 移除結尾可能的 2-4 字中文名（演員名）
        name = name.replace(/\s+[\u4e00-\u9fff]{2,4}$/, '');

        name = name.trim();

        // 只有包含中文且不含日文假名才返回
        // （日文漢字也在中文 Unicode 範圍內，需要排除）
        if (name && hasChinese(name) && !hasJapanese(name)) {
            return name;
        }
        return null;
    }

    /**
     * 從檔名提取番號
     */
    function extractNumber(filename) {
        // 清洗：取檔名部分（去除路徑和副檔名）
        const basename = filename.split(/[/\\]/).pop().replace(/\.[^.]+$/, '');

        // 番號正則（優先順序：標準格式 > 無連字號 > FC2）
        const patterns = [
            /\b([A-Z]{1,5})-(\d{3,5})\b/i,   // T28-650, SONE-205（支援單字母）
            /\b([A-Z]{2,5})(\d{3,5})\b/i,     // IPTD927（無連字號需 2+ 字母避免誤判）
            /\b(FC2-PPV)-(\d{5,7})\b/i,       // FC2-PPV-1234567
        ];

        for (const pattern of patterns) {
            const match = basename.match(pattern);
            if (match) {
                const prefix = match[1].toUpperCase();
                // FC2 特殊處理
                if (prefix === 'FC2-PPV') {
                    return `FC2-PPV-${match[2]}`;
                }
                return `${prefix}-${match[2]}`;
            }
        }
        return null;
    }

    /**
     * 執行拖拽搜尋（瀏覽器環境，無法取得完整路徑）
     * PyWebView 環境會透過 handlePyWebViewDrop 處理
     */
    function handleFileDrop(files) {
        if (!files || files.length === 0) return;

        // 瀏覽器環境：只能搜尋番號，無法取得路徑
        // 只處理第一個檔案
        const file = files[0];
        const filename = file.name;
        const number = extractNumber(filename);

        if (!number) {
            document.getElementById('errorMessage').textContent = '無法從檔名識別番號';
            showState('error');
            return;
        }

        // 填入搜尋框並執行搜尋
        queryInput.value = number;
        form.dispatchEvent(new Event('submit'));
    }

    // 防止瀏覽器預設行為（開啟檔案）
    document.addEventListener('dragover', (e) => {
        e.preventDefault();
    });

    // 拖拽進入頁面
    document.addEventListener('dragenter', (e) => {
        e.preventDefault();
        dragCounter++;

        // 檢查是否為檔案拖拽
        if (e.dataTransfer.types.includes('Files')) {
            dragOverlay.classList.add('active');
        }
    });

    // 拖拽離開頁面
    document.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dragCounter--;

        if (dragCounter === 0) {
            dragOverlay.classList.remove('active');
        }
    });

    // 放開檔案
    document.addEventListener('drop', (e) => {
        e.preventDefault();
        dragCounter = 0;
        dragOverlay.classList.remove('active');

        // PyWebView 環境由 Python 端 on_drop 處理，這裡跳過
        if (typeof window.pywebview !== 'undefined') {
            return;
        }

        // 純瀏覽器環境：只能搜尋番號，無法取得完整路徑
        handleFileDrop(e.dataTransfer.files);
    });
});
</script>
{% endblock %}
