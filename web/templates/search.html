{% extends "base.html" %}

{% block title %}æœå°‹ - OpenAver{% endblock %}

{% block extra_css %}
<link href="/static/css/pages/search.css" rel="stylesheet">
<link href="/static/css/pages/showcase.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="search-container ds-page" x-data="searchPage()" @keydown.window="handleKeydown($event)">
    <!-- æ‹–æ‹½è¦†è“‹å±¤ï¼ˆå¿…é ˆåœ¨ x-data scope å…§ï¼‰ -->
    <div class="drag-overlay" id="dragOverlay" :class="{ active: dragActive }">
        <div class="drag-overlay-content">
            <i class="bi bi-file-earmark-play"></i>
            <p>æ”¾é–‹ä»¥æœå°‹ç•ªè™Ÿ</p>
        </div>
    </div>

    <!-- T2a: Lightboxï¼ˆGrid æ¨¡å¼ï¼‰ -->
    <div class="showcase-lightbox"
         :class="{ 'show': lightboxOpen }"
         @click="handleLightboxBackdropClick($event)">

        <div class="lightbox-content" @click.stop>
            <!-- Close Button -->
            <button class="lightbox-close"
                    @click="closeLightbox()"
                    title="é—œé–‰ (ESC)">
                <i class="bi bi-x-lg"></i>
            </button>

            <!-- Cover Image -->
            <div class="lightbox-cover">
                <img :src="currentLightboxVideo()?.cover ? `/api/proxy-image?url=${encodeURIComponent(currentLightboxVideo().cover)}` : ''"
                     :alt="currentLightboxVideo()?.number"
                     @error="$event.target.onerror=null; $event.target.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22 fill=%22%23666%22><rect width=%22400%22 height=%22300%22 fill=%22%23222%22/><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22>No Image</text></svg>'">
            </div>
        </div>

        <!-- Navigation Arrows -->
        <button class="lightbox-nav lightbox-nav-prev"
                @click.stop="prevLightboxVideo()"
                x-show="lightboxIndex > 0"
                title="ä¸Šä¸€éƒ¨ (â†)">
            <i class="bi bi-chevron-left"></i>
        </button>
        <button class="lightbox-nav lightbox-nav-next"
                @click.stop="nextLightboxVideo()"
                x-show="lightboxIndex < searchResults.length - 1"
                title="ä¸‹ä¸€éƒ¨ (â†’)">
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>

    <!-- æœå°‹æ¡† -->
    <div class="search-bar">
        <form id="searchForm" @submit.prevent="doSearch()">
            <div class="spotlight-search">
                <i class="bi bi-search search-icon-left"></i>
                <input type="text" id="searchQuery" name="q" placeholder="æœå°‹ç•ªè™Ÿã€å¥³å„ªæˆ–æ‹–å…¥æª”æ¡ˆ..." autocomplete="off">
                <div class="search-actions-right">
                    <!-- å–æ¶ˆæœå°‹æŒ‰éˆ•ï¼ˆloading ç‹€æ…‹é¡¯ç¤ºï¼‰ -->
                    <button type="button"
                            x-show="pageState === 'loading'"
                            @click="cancelSearch()"
                            class="btn-icon"
                            title="å–æ¶ˆæœå°‹">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <!-- T2a: Grid / Detail Toggle -->
                    <button type="button"
                            class="btn-icon rotating-border-spotlight active"
                            x-show="listMode === 'search'"
                            @click="toggleDisplayMode()"
                            :title="displayMode === 'detail' ? 'åˆ‡æ›åˆ°åœ–ç‰‡æ¨¡å¼' : 'åˆ‡æ›åˆ°è©³ç´°æ¨¡å¼'">
                        <i class="bi" :class="displayMode === 'detail' ? 'bi-grid-3x3' : 'bi-list-ul'"></i>
                    </button>
                    <button type="button" id="btnClear" class="btn-icon hidden" x-show="hasContent" @click="clearAll()" title="æ¸…ç©º">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <button type="submit" id="btnSubmit" class="btn-icon active" title="æœå°‹">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </form>
        <div class="search-hint">
            <i class="bi bi-lightbulb"></i>
            æç¤ºï¼šè¼¸å…¥å±€éƒ¨ç•ªè™Ÿå¦‚ <code>IPZZ-03</code> å¯æœå°‹ 030~039ï¼Œè¼¸å…¥å¥³å„ªåå¯æœå°‹å…¶ä½œå“
        </div>
    </div>

    <!-- çµæœå€åŸŸ -->
    <div class="result-area">
        <!-- åˆå§‹ç‹€æ…‹ -->
        <div id="emptyState" class="state-page w-full" x-show="pageState === 'empty'">
            <i class="bi bi-film state-page-icon"></i>
            <p class="state-page-text">è¼¸å…¥ç•ªè™Ÿæœå°‹ï¼Œæˆ–åŠ å…¥å½±ç‰‡æª”æ¡ˆ</p>
            <div class="empty-actions">
                <button class="btn btn-sm btn-outline btn-primary" id="btnAddFiles" @click="addFiles()">
                    <i class="bi bi-file-earmark-plus"></i> åŠ å…¥æª”æ¡ˆ
                </button>
                <button class="btn btn-sm btn-outline btn-primary" id="btnAddFolder" @click="addFolder()">
                    <i class="bi bi-folder-plus"></i> åŠ å…¥è³‡æ–™å¤¾
                </button>
                <button class="btn btn-sm btn-outline btn-warning" id="btnFavorite" @click="loadFavorite()" :disabled="isLoadingFavorite" title="è¼‰å…¥æˆ‘çš„æœ€æ„›è³‡æ–™å¤¾">
                    <template x-if="!isLoadingFavorite"><i class="bi bi-star-fill"></i></template>
                    <span x-show="isLoadingFavorite" class="loading loading-spinner loading-sm"></span>
                    <span x-text="isLoadingFavorite ? '' : 'æˆ‘çš„æœ€æ„›'">æˆ‘çš„æœ€æ„›</span>
                </button>
            </div>
            <small class="state-page-hint">ä¹Ÿå¯ç›´æ¥æ‹–å…¥æª”æ¡ˆæˆ–è³‡æ–™å¤¾</small>
        </div>

        <!-- è¼‰å…¥ä¸­ - é€²åº¦æŒ‡ç¤ºå™¨ -->
        <div id="loadingState" class="search-progress w-full hidden" x-show="pageState === 'loading'" x-cloak>
            <div class="progress-container">
                <!-- æœå°‹æ¨™é¡Œ -->
                <div class="progress-header">
                    <span class="progress-query" x-text="'&quot;' + currentQuery + '&quot;'"></span>
                </div>

                <!-- å–®è¡Œæ—¥èªŒ -->
                <div class="progress-log" x-text="progressLog">
                    æœå°‹ä¸­...
                </div>

                <!-- è©³æƒ…é€²åº¦æ¢ -->
                <div class="detail-progress" x-show="detailTotal > 0">
                    <div class="detail-bar" :style="'width:' + detailProgressPercent() + '%'"></div>
                    <span class="detail-text" x-text="detailDone + ' / ' + detailTotal">0 / 0</span>
                </div>
            </div>
        </div>

        <!-- éŒ¯èª¤ç‹€æ…‹ -->
        <div id="errorState" class="state-page error w-full hidden" x-show="pageState === 'error'" x-cloak>
            <i class="bi bi-exclamation-triangle state-page-icon"></i>
            <p class="state-page-text error-text" id="errorMessage">æœå°‹å¤±æ•—</p>
            <small class="state-page-hint">è«‹æª¢æŸ¥ç•ªè™Ÿæ ¼å¼æˆ–ç¨å¾Œå†è©¦</small>
            <!-- å¤šæª”æ¡ˆæ¨¡å¼å°èˆª -->
            <div class="error-nav" x-show="fileList.length > 1" id="errorNav">
                <button class="btn btn-sm btn-outline btn-neutral"
                        id="errorBtnPrev"
                        :disabled="!canGoPrev()"
                        @click="navigate(-1)"
                        title="ä¸Šä¸€å€‹ (â†)">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span class="error-nav-indicator" id="errorNavIndicator" x-text="navIndicatorText()">1/5</span>
                <button class="btn btn-sm btn-outline btn-neutral"
                        id="errorBtnNext"
                        :disabled="!canGoNext()"
                        @click="navigate(1)"
                        title="ä¸‹ä¸€å€‹ (â†’)">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- çµæœå¡ç‰‡ï¼ˆwrapperï¼šå¡ç‰‡ + æª”æ¡ˆåˆ—è¡¨å‚ç›´æ’åˆ—ï¼‰ -->
        <div id="resultCard" class="hidden" x-show="pageState === 'result'" x-cloak>
            <!-- AV Card Fullï¼šå°é¢ + è³‡è¨Šä¸¦æ’ï¼ˆDetail æ¨¡å¼ï¼‰ -->
            <div class="av-card-full" x-show="displayMode === 'detail'">
                <div class="av-card-full-cover">
                    <div class="av-card-full-cover-wrapper">
                        <img id="resultCover" class="av-card-full-cover-img"
                             x-show="!coverError && current().cover"
                             :src="coverUrl()"
                             @error="handleCoverError()"
                             @load="coverError = ''; _coverRetried = false"
                             alt="å°é¢">
                        <!-- å°é¢éŒ¯èª¤ -->
                        <div x-show="coverError" class="cover-error-placeholder">
                            <i class="bi bi-exclamation-triangle" style="font-size:3rem;color:var(--color-warning);"></i>
                            <p x-text="coverError" style="margin-top:0.5rem;"></p>
                            <small>è«‹æª¢æŸ¥ç•ªè™Ÿæ ¼å¼æˆ–ç¨å¾Œå†è©¦</small>
                        </div>
                        <!-- ç„¡å°é¢ -->
                        <div x-show="!coverError && !current().cover" class="cover-error-placeholder">
                            <i class="bi bi-image" style="font-size:3rem;"></i>
                        </div>
                        <button class="nav-btn prev" id="btnPrev"
                                x-show="showNavigation()"
                                :disabled="!canGoPrev() || (isSearchingFile && searchingFileDirection === 'prev')"
                                @click="navigate(-1)"
                                title="ä¸Šä¸€å€‹ (â†)">
                            <i x-show="!(isSearchingFile && searchingFileDirection === 'prev')" class="bi bi-chevron-left"></i>
                            <span x-show="isSearchingFile && searchingFileDirection === 'prev'" class="loading loading-spinner loading-sm"></span>
                        </button>
                        <button class="nav-btn next" id="btnNext"
                                x-show="showNavigation()"
                                :disabled="!canGoNext() || isLoadingMore || (isSearchingFile && searchingFileDirection === 'next')"
                                @click="navigate(1)"
                                title="ä¸‹ä¸€å€‹ (â†’)">
                            <i x-show="!isLoadingMore && !(isSearchingFile && searchingFileDirection === 'next')" class="bi bi-chevron-right"></i>
                            <span x-show="isLoadingMore || (isSearchingFile && searchingFileDirection === 'next')" class="loading loading-spinner loading-sm"></span>
                        </button>
                        <div class="nav-indicator" id="navIndicator"
                             x-show="showNavigation()">
                            <span id="currentIndex"
                                  x-text="fileList.length > 1 ? (currentFileIndex + 1) : (currentIndex + 1)">1</span> /
                            <span id="totalCount"
                                  x-text="fileList.length > 1 ? fileList.length : (hasMoreResults ? (searchResults.length + '+') : searchResults.length)">1</span>
                        </div>
                    </div>
                </div>
                <div class="av-card-full-info">
                <div class="av-card-full-header">
                    <h4 class="av-num" id="resultNumber" x-text="current().number || '-'">-</h4>
                    <span id="localBadge" class="local-badge"
                          x-show="hasLocalBadge()"
                          :title="localBadgeTitle()"
                          @click="copyLocalPath()">ğŸ“</span>
                    <button id="switchSourceBtn" class="info-icon-btn" onclick="switchSource()"
                            title="åˆ‡æ›ç‰ˆæœ¬"
                            :data-number="current().number || ''"
                            :data-all-variant-ids="JSON.stringify(current()._all_variant_ids || [])"
                            :data-current-variant-id="current()._variant_id || ''">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                </div>
                <div class="av-card-full-body">
                    <div class="info-row">
                        <span class="info-label">æ¼”å“¡</span>
                        <span class="info-value" id="resultActors" x-text="(current().actors || []).join(', ') || '-'">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ç™¼è¡Œæ—¥æœŸ</span>
                        <span class="info-value" id="resultDate" x-text="current().date || '-'">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ç‰‡å•†</span>
                        <span class="info-value" id="resultMaker" x-text="current().maker || '-'">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æ¨™ç±¤</span>
                        <span class="info-value" id="resultTags">
                            <!-- å­—å¹•æ¨™ç±¤ -->
                            <span x-show="hasSubtitle()" class="badge tag-badge subtitle">ä¸­æ–‡å­—å¹•</span>
                            <!-- ç³»çµ±æ¨™ç±¤ -->
                            <template x-for="tag in (current().tags || [])" :key="tag">
                                <span class="badge tag-badge" x-text="tag"></span>
                            </template>
                            <!-- ç”¨æˆ¶æ¨™ç±¤ -->
                            <template x-for="tag in (current().user_tags || [])" :key="'u_' + tag">
                                <span class="badge tag-badge user-tag">
                                    <span x-text="tag"></span>
                                    <span class="tag-remove" @click="removeUserTag(tag)">&times;</span>
                                </span>
                            </template>
                            <!-- æ–°å¢æ¨™ç±¤æŒ‰éˆ• -->
                            <button x-show="!addingTag" @click="showAddTagInput()" class="btn btn-sm tag-add-btn" title="æ–°å¢æ¨™ç±¤">+</button>
                            <!-- æ–°å¢æ¨™ç±¤è¼¸å…¥æ¡† -->
                            <span x-show="addingTag" class="tag-input-wrapper">
                                <input type="text" x-ref="tagInput" x-model="newTagValue"
                                       @keydown.enter="confirmAddTag()" @keydown.escape="cancelAddTag()"
                                       class="tag-input" placeholder="æ¨™ç±¤åç¨±" maxlength="20">
                                <button @click="confirmAddTag()" class="btn btn-sm tag-confirm">âœ“</button>
                                <button @click="cancelAddTag()" class="btn btn-sm tag-cancel">âœ•</button>
                            </span>
                        </span>
                    </div>
                </div>
                <div class="av-card-full-footer">
                    <div class="av-card-full-footer-content">
                        <span class="info-label">æ¨™é¡Œ</span>
                        <!-- é¡¯ç¤ºæ¨¡å¼ -->
                        <div class="info-value-with-actions" id="titleContainer" x-show="!editingTitle">
                            <span class="info-value" id="resultTitle" x-text="current().title || '-'">-</span>
                            <div class="av-card-full-footer-actions">
                                <button id="editTitleBtn" class="info-icon-btn" @click="startEditTitle()" title="ç·¨è¼¯æ¨™é¡Œ">
                                    <i :class="current()._titleEdited ? 'bi bi-pencil-fill text-success' : 'bi bi-pencil text-muted'"></i>
                                </button>
                                <button id="translateBtn" class="info-icon-btn"
                                        x-show="canTranslate() && !isTranslating"
                                        @click="translateWithAI()" title="AI ç¿»è­¯">
                                    <i class="bi bi-translate"></i>
                                </button>
                                <span id="translateSpinner" class="loading loading-spinner loading-sm"
                                      x-show="isTranslating"></span>
                            </div>
                        </div>
                        <!-- ç·¨è¼¯æ¨¡å¼ -->
                        <div class="info-value-with-actions" x-show="editingTitle" x-cloak>
                            <textarea x-ref="titleInput" x-model="editedTitleValue"
                                      @keydown.enter.prevent="confirmEditTitle()"
                                      @keydown.escape="cancelEditTitle()"
                                      class="textarea textarea-bordered info-value"
                                      rows="3" style="flex:1;min-width:0;resize:none;"></textarea>
                            <div class="av-card-full-footer-actions">
                                <button class="info-icon-btn text-success" @click="confirmEditTitle()" title="ç¢ºèª">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button class="info-icon-btn text-error" @click="cancelEditTitle()" title="å–æ¶ˆ">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- ä¸­æ–‡æ¨™é¡Œ -->
                    <div id="chineseTitleRow" class="av-card-full-footer-content mt-2"
                         x-show="hasChineseTitle()">
                        <span class="info-label" id="chineseTitleLabel" x-text="chineseTitleLabel()">ä¸­æ–‡ç‰‡å</span>
                        <!-- é¡¯ç¤ºæ¨¡å¼ -->
                        <div class="info-value-with-actions" id="chineseTitleContainer" x-show="!editingChineseTitle">
                            <span class="info-value text-success" id="resultChineseTitle" x-text="chineseTitleText()">-</span>
                            <div class="av-card-full-footer-actions">
                                <button id="editChineseTitleBtn" class="info-icon-btn" @click="startEditChineseTitle()" title="ç·¨è¼¯ä¸­æ–‡ç‰‡å">
                                    <i :class="current()._chineseTitleEdited ? 'bi bi-pencil-fill text-success' : 'bi bi-pencil text-muted'"></i>
                                </button>
                            </div>
                        </div>
                        <!-- ç·¨è¼¯æ¨¡å¼ -->
                        <div class="info-value-with-actions" x-show="editingChineseTitle" x-cloak>
                            <textarea x-ref="chineseTitleInput" x-model="editedChineseTitleValue"
                                      @keydown.enter.prevent="confirmEditChineseTitle()"
                                      @keydown.escape="cancelEditChineseTitle()"
                                      class="textarea textarea-bordered info-value text-success"
                                      rows="2" style="flex:1;min-width:0;resize:none;"></textarea>
                            <div class="av-card-full-footer-actions">
                                <button class="info-icon-btn text-success" @click="confirmEditChineseTitle()" title="ç¢ºèª">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button class="info-icon-btn text-error" @click="cancelEditChineseTitle()" title="å–æ¶ˆ">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- T2a: Grid Modeï¼ˆå°é¢ç‰†ï¼‰ -->
            <div class="search-grid ds-gallery-composition" x-show="displayMode === 'grid' && listMode === 'search'" x-cloak>
                <template x-for="(result, index) in searchResults" :key="result.number + '_' + index">
                    <div class="av-card-preview"
                         @click="openLightbox(index)"
                         :style="`--card-index: ${index}`">
                        <div class="av-card-preview-img">
                            <img :src="result.cover ? `/api/proxy-image?url=${encodeURIComponent(result.cover)}` : ''"
                                 :alt="result.number"
                                 loading="lazy"
                                 @error="$event.target.style.display='none'">
                            <!-- Local Badge -->
                            <div class="av-card-preview-badge local"
                                 x-show="result._localStatus?.exists"
                                 title="æœ¬åœ°æœ‰æ­¤å½±ç‰‡">
                                ğŸ“ æœ¬åœ°
                            </div>
                            <!-- Overlay Actions (Hover) -->
                            <div class="av-card-preview-overlay">
                                <button class="btn-glass-circle"
                                        @click.stop="switchToDetail(index)"
                                        title="æŸ¥çœ‹è©³æƒ…">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                                <button class="btn-glass-circle"
                                        @click.stop="copyPath(result._localStatus?.paths?.[0] || '')"
                                        x-show="result._localStatus?.exists"
                                        title="è¤‡è£½è·¯å¾‘">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        <div class="av-card-preview-footer">
                            <div class="footer-default">
                                <span class="av-num" x-text="result.number || '-'">-</span>
                                <span class="av-actress" x-text="(result.actors || []).slice(0, 2).join(', ') || 'æœªçŸ¥'">æœªçŸ¥</span>
                            </div>
                            <div class="footer-hover">
                                <div class="hover-title" x-text="result.title || 'æœªçŸ¥æ¨™é¡Œ'">æœªçŸ¥æ¨™é¡Œ</div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- æª”æ¡ˆåˆ—è¡¨ï¼ˆå¡ç‰‡å¤–ï¼Œä¸‹æ–¹ç¨ç«‹ï¼‰ -->
            <div class="file-list-section" id="fileListSection"
                 x-show="(listMode === 'file' && fileList.length > 0) || (listMode === 'search' && searchResults.length > 0)">
                <div class="file-list-header">
                    <span class="file-count" id="fileCountText" x-text="fileCountText()">0 å€‹æª”æ¡ˆ</span>
                    <div class="join">
                        <button class="btn btn-sm btn-outline btn-primary join-item" id="btnSearchAll" type="button"
                            @click="searchAll()"
                            :disabled="searchAllDisabled()"
                            title="æœå°‹æ‰€æœ‰æœªæœå°‹çš„æª”æ¡ˆ">
                            <i :class="searchAllButtonIcon()"></i>
                            <span x-text="searchAllButtonText()">æœå°‹å…¨éƒ¨</span>
                        </button>
                        <button class="btn btn-sm btn-success join-item" id="btnScrapeAll" type="button"
                            x-show="listMode === 'file'"
                            @click="scrapeAll()"
                            :disabled="isScrapeAllProcessing"
                            title="ç”¢ç”Ÿæ‰€æœ‰å·²æœå°‹çš„æª”æ¡ˆ">
                            <span x-show="!isScrapeAllProcessing"><i class="bi bi-folder-plus"></i> ç”¢ç”Ÿå…¨éƒ¨</span>
                            <span x-show="isScrapeAllProcessing" class="loading loading-spinner loading-sm"></span>
                        </button>
                    </div>
                </div>

                <!-- æ‰¹æ¬¡é€²åº¦æ¢ -->
                <div class="batch-progress" id="batchProgress"
                     x-show="batchState.isProcessing">
                    <div class="batch-progress-bar">
                        <div class="batch-progress-fill" id="batchProgressBar"
                             :style="'width:' + batchPercent() + '%'"></div>
                    </div>
                    <small class="batch-progress-text" id="batchProgressText"
                           x-text="'è™•ç†ä¸­ ' + batchState.processed + '/' + batchState.total">è™•ç†ä¸­ 0/0</small>
                </div>

                <!-- æª”æ¡ˆåˆ—è¡¨ -->
                <div x-show="listMode === 'file'" class="file-list" id="fileList">
                    <template x-for="(file, i) in fileList" :key="file.path">
                        <div @click="switchToFile(i, 'first')"
                             :class="i === currentFileIndex ? 'file-item active' : 'file-item'">
                            <!-- ç§»é™¤æŒ‰éˆ• -->
                            <button class="btn btn-link btn-sm p-0 btn-remove-file text-muted"
                                    @click.stop="removeFile(i)"
                                    title="ç§»é™¤æ­¤æª”æ¡ˆ">
                                <i class="bi bi-x"></i>
                            </button>

                            <!-- æª”æ¡ˆåœ–ç¤º -->
                            <i class="bi bi-file-earmark-play file-icon"></i>

                            <!-- æª”å -->
                            <span class="file-name" :title="file.path" x-text="file.filename">-</span>

                            <!-- ç‹€æ…‹åœ–ç¤º -->
                            <span :class="fileStatusClass(file)"
                                  x-text="fileStatusIcon(file)"></span>

                            <!-- å‹•ä½œæŒ‰éˆ•ï¼šç”¢ç”Ÿ NFO -->
                            <button x-show="canScrapeFile(file) && !file.isScraping && file.scrapeStatus !== 'done'"
                                    @click.stop="scrapeSingle(i)"
                                    class="btn btn-sm btn-outline btn-success btn-scrape-single"
                                    title="ç”¢ç”Ÿ NFO + å°é¢">
                                <i class="bi bi-folder-plus"></i>
                            </button>

                            <!-- Scraping spinner -->
                            <span x-show="file.isScraping" class="loading loading-spinner loading-sm"></span>

                            <!-- Scrape done -->
                            <button x-show="file.scrapeStatus === 'done'"
                                    class="btn btn-sm btn-success btn-scrape-single" disabled>
                                <i class="bi bi-check"></i>
                            </button>

                            <!-- Scrape failed -->
                            <button x-show="file.scrapeStatus === 'failed'"
                                    @click.stop="scrapeSingle(i)"
                                    class="btn btn-sm btn-error btn-scrape-single"
                                    title="é‡è©¦">
                                å¤±æ•—
                            </button>

                            <!-- å‹•ä½œæŒ‰éˆ•ï¼šæ‰‹å‹•è¼¸å…¥ç•ªè™Ÿ -->
                            <button x-show="needsNumberInput(file)"
                                    @click.stop="enterNumber(i)"
                                    class="btn btn-sm btn-outline btn-warning btn-enter-number"
                                    title="æ‰‹å‹•è¼¸å…¥ç•ªè™Ÿ">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    </template>
                </div>

                <!-- æœå°‹çµæœåˆ—è¡¨ -->
                <div x-show="listMode === 'search'" class="file-list">
                    <template x-for="(result, i) in searchResults" :key="(result.number || '') + '_' + i">
                        <div @click="switchToSearchResult(i)"
                             :class="i === currentIndex ? 'file-item active' : 'file-item'">
                            <span style="flex-shrink:0;font-weight:500;color:#0d6efd;min-width:90px;"
                                  x-text="result.number || '-'">-</span>
                            <span style="flex-shrink:0;min-width:80px;color:#6c757d;"
                                  x-text="(result.actors || []).slice(0,2).join(', ') || '-'">-</span>
                            <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                                  x-text="result.title || '-'">-</span>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // === å…¨åŸŸå‡½æ•¸ï¼šä¾› PyWebView Python ç«¯å‘¼å« ===

    /**
     * PyWebView æ‹–æ”¾å›èª¿ï¼ˆç”± Python ç«¯å‘¼å«ï¼‰
     * @param {string|string[]} paths - WSL æ ¼å¼çš„æª”æ¡ˆè·¯å¾‘ï¼ˆå–®ä¸€æˆ–é™£åˆ—ï¼‰
     */
    window.handlePyWebViewDrop = function (paths) {
        // çµ±ä¸€è½‰ç‚ºé™£åˆ—
        const pathList = Array.isArray(paths) ? paths : [paths];
        console.log('PyWebView drop:', pathList.length, 'å€‹æª”æ¡ˆ');

        // è§¸ç™¼è‡ªå®šç¾©äº‹ä»¶ï¼Œè®“ä¸»ç¨‹å¼è™•ç†
        window.dispatchEvent(new CustomEvent('pywebview-files', {
            detail: { paths: pathList }
        }));
    };

    // === ä¸»ç¨‹å¼å·²ç§»è‡³ /static/js/pages/search/ ===
</script>
<!-- Alpine State Modules (must load before other JS) -->
<script src="/static/js/pages/search/state/base.js"></script>
<script src="/static/js/pages/search/state/persistence.js"></script>
<script src="/static/js/pages/search/state/search-flow.js"></script>
<script src="/static/js/pages/search/state/navigation.js"></script>
<script src="/static/js/pages/search/state/result-card.js"></script>
<script src="/static/js/pages/search/state/file-list.js"></script>
<script src="/static/js/pages/search/state/batch.js"></script>
<script src="/static/js/pages/search/state/bridge.js"></script>
<script src="/static/js/pages/search/state/grid-mode.js"></script>
<script src="/static/js/pages/search/state/index.js"></script>
<!-- Existing JS modules -->
<script src="/static/js/pages/search/core.js"></script>
<script src="/static/js/pages/search/ui.js"></script>
<script src="/static/js/pages/search/file.js"></script>
<script src="/static/js/pages/search/init.js"></script>
{% endblock %}
