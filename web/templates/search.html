{% extends "base.html" %}

{% block title %}æœå°‹ - OpenAver{% endblock %}

{% block extra_css %}
<link href="/static/css/pages/search.css" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- æ‹–æ‹½è¦†è“‹å±¤ -->
<div class="drag-overlay" id="dragOverlay">
    <div class="drag-overlay-content">
        <i class="bi bi-file-earmark-play"></i>
        <p>æ”¾é–‹ä»¥æœå°‹ç•ªè™Ÿ</p>
    </div>
</div>

<div class="search-container ds-page" x-data="searchPage()" @keydown.window="handleKeydown($event)">
    <!-- Gallery è¦–åœ–å®¹å™¨ -->
    <div id="galleryView" class="hidden">
        <iframe id="galleryFrame" src="" sandbox="allow-same-origin allow-scripts"></iframe>
    </div>

    <!-- æœå°‹æ¡† -->
    <div class="search-bar">
        <form id="searchForm" @submit.prevent="doSearch()">
            <div class="spotlight-search">
                <i class="bi bi-search search-icon-left"></i>
                <input type="text" id="searchQuery" name="q" placeholder="æœå°‹ç•ªè™Ÿã€å¥³å„ªæˆ–æ‹–å…¥æª”æ¡ˆ..." autocomplete="off">
                <div class="search-actions-right">
                    <!-- å–æ¶ˆæœå°‹æŒ‰éˆ•ï¼ˆloading ç‹€æ…‹é¡¯ç¤ºï¼‰ -->
                    <button type="button"
                            x-show="pageState === 'loading'"
                            @click="cancelSearch()"
                            class="btn-icon"
                            title="å–æ¶ˆæœå°‹">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <button type="button" id="btnBackToDetail" class="btn-icon hidden" title="è¿”å›è©³ç´°è³‡æ–™">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    <button type="button" id="btnClear" class="btn-icon hidden" x-show="hasContent" title="æ¸…ç©º">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <button type="submit" id="btnSubmit" class="btn-icon active" title="æœå°‹">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </form>
        <div class="search-hint">
            <i class="bi bi-lightbulb"></i>
            æç¤ºï¼šè¼¸å…¥å±€éƒ¨ç•ªè™Ÿå¦‚ <code>IPZZ-03</code> å¯æœå°‹ 030~039ï¼Œè¼¸å…¥å¥³å„ªåå¯æœå°‹å…¶ä½œå“
        </div>
    </div>

    <!-- çµæœå€åŸŸ -->
    <div class="result-area">
        <!-- åˆå§‹ç‹€æ…‹ -->
        <div id="emptyState" class="state-page w-full" x-show="pageState === 'empty'">
            <i class="bi bi-film state-page-icon"></i>
            <p class="state-page-text">è¼¸å…¥ç•ªè™Ÿæœå°‹ï¼Œæˆ–åŠ å…¥å½±ç‰‡æª”æ¡ˆ</p>
            <div class="empty-actions">
                <button class="btn btn-sm btn-outline btn-primary" id="btnAddFiles">
                    <i class="bi bi-file-earmark-plus"></i> åŠ å…¥æª”æ¡ˆ
                </button>
                <button class="btn btn-sm btn-outline btn-primary" id="btnAddFolder">
                    <i class="bi bi-folder-plus"></i> åŠ å…¥è³‡æ–™å¤¾
                </button>
                <button class="btn btn-sm btn-outline btn-warning" id="btnFavorite" title="è¼‰å…¥æˆ‘çš„æœ€æ„›è³‡æ–™å¤¾">
                    <i class="bi bi-star-fill"></i> æˆ‘çš„æœ€æ„›
                </button>
            </div>
            <small class="state-page-hint">ä¹Ÿå¯ç›´æ¥æ‹–å…¥æª”æ¡ˆæˆ–è³‡æ–™å¤¾</small>
        </div>

        <!-- è¼‰å…¥ä¸­ - é€²åº¦æŒ‡ç¤ºå™¨ -->
        <div id="loadingState" class="search-progress w-full hidden" x-show="pageState === 'loading'" x-cloak>
            <div class="progress-container">
                <!-- æœå°‹æ¨™é¡Œ -->
                <div class="progress-header">
                    <span class="progress-query" x-text="'&quot;' + currentQuery + '&quot;'"></span>
                </div>

                <!-- å–®è¡Œæ—¥èªŒ -->
                <div class="progress-log" x-text="progressLog">
                    æœå°‹ä¸­...
                </div>

                <!-- è©³æƒ…é€²åº¦æ¢ -->
                <div class="detail-progress" x-show="detailTotal > 0">
                    <div class="detail-bar" :style="'width:' + detailProgressPercent + '%'"></div>
                    <span class="detail-text" x-text="detailDone + ' / ' + detailTotal">0 / 0</span>
                </div>
            </div>
        </div>

        <!-- éŒ¯èª¤ç‹€æ…‹ -->
        <div id="errorState" class="state-page error w-full hidden" x-show="pageState === 'error'" x-cloak>
            <i class="bi bi-exclamation-triangle state-page-icon"></i>
            <p class="state-page-text error-text" id="errorMessage">æœå°‹å¤±æ•—</p>
            <small class="state-page-hint">è«‹æª¢æŸ¥ç•ªè™Ÿæ ¼å¼æˆ–ç¨å¾Œå†è©¦</small>
            <!-- å¤šæª”æ¡ˆæ¨¡å¼å°èˆª -->
            <div class="error-nav" x-show="fileList.length > 1" id="errorNav">
                <button class="btn btn-sm btn-outline btn-neutral"
                        :disabled="!canGoPrev"
                        @click="navigate(-1)"
                        title="ä¸Šä¸€å€‹ (â†)">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span class="error-nav-indicator" x-text="navIndicatorText">1/5</span>
                <button class="btn btn-sm btn-outline btn-neutral"
                        :disabled="!canGoNext"
                        @click="navigate(1)"
                        title="ä¸‹ä¸€å€‹ (â†’)">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- çµæœå¡ç‰‡ï¼ˆwrapperï¼šå¡ç‰‡ + æª”æ¡ˆåˆ—è¡¨å‚ç›´æ’åˆ—ï¼‰ -->
        <div id="resultCard" class="hidden" x-show="pageState === 'result'" x-cloak>
            <!-- AV Card Fullï¼šå°é¢ + è³‡è¨Šä¸¦æ’ -->
            <div class="av-card-full">
                <div class="av-card-full-cover">
                    <div class="av-card-full-cover-wrapper">
                        <img id="resultCover" class="av-card-full-cover-img" src="" alt="å°é¢">
                        <button class="nav-btn prev" id="btnPrev"
                                x-show="showNavigation"
                                :disabled="!canGoPrev"
                                @click="navigate(-1)"
                                title="ä¸Šä¸€å€‹ (â†)">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="nav-btn next" id="btnNext"
                                x-show="showNavigation"
                                :disabled="!canGoNext"
                                @click="navigate(1)"
                                title="ä¸‹ä¸€å€‹ (â†’)">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                        <div class="nav-indicator" id="navIndicator"
                             x-show="showNavigation"
                             x-text="navIndicatorText">
                            1 / 1
                        </div>
                    </div>
                </div>
                <div class="av-card-full-info">
                <div class="av-card-full-header">
                    <h4 class="av-num" id="resultNumber">-</h4>
                    <span id="localBadge" class="local-badge hidden" title="æœ¬åœ°å·²æœ‰">ğŸ“</span>
                    <button id="switchSourceBtn" class="info-icon-btn" onclick="switchSource()" title="åˆ‡æ›ç‰ˆæœ¬">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                </div>
                <div class="av-card-full-body">
                    <div class="info-row">
                        <span class="info-label">æ¼”å“¡</span>
                        <span class="info-value" id="resultActors">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ç™¼è¡Œæ—¥æœŸ</span>
                        <span class="info-value" id="resultDate">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ç‰‡å•†</span>
                        <span class="info-value" id="resultMaker">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æ¨™ç±¤</span>
                        <span class="info-value" id="resultTags">-</span>
                    </div>
                </div>
                <div class="av-card-full-footer">
                    <div class="av-card-full-footer-content">
                        <span class="info-label">æ¨™é¡Œ</span>
                        <div class="info-value-with-actions" id="titleContainer">
                            <span class="info-value" id="resultTitle">-</span>
                            <div class="av-card-full-footer-actions">
                                <button id="editTitleBtn" class="info-icon-btn" onclick="startEditTitle()" title="ç·¨è¼¯æ¨™é¡Œ">
                                    <i class="bi bi-pencil text-muted"></i>
                                </button>
                                <button id="translateBtn" class="info-icon-btn hidden" onclick="translateWithAI()" title="AI ç¿»è­¯">
                                    <i class="bi bi-translate"></i>
                                </button>
                                <span id="translateSpinner" class="loading loading-spinner loading-sm hidden"></span>
                            </div>
                        </div>
                    </div>
                    <div id="chineseTitleRow" class="av-card-full-footer-content mt-2 hidden">
                        <span class="info-label" id="chineseTitleLabel">ä¸­æ–‡ç‰‡å</span>
                        <div class="info-value-with-actions" id="chineseTitleContainer">
                            <span class="info-value text-success" id="resultChineseTitle">-</span>
                            <div class="av-card-full-footer-actions">
                                <button id="editChineseTitleBtn" class="info-icon-btn" onclick="startEditChineseTitle()" title="ç·¨è¼¯ä¸­æ–‡ç‰‡å">
                                    <i class="bi bi-pencil text-muted"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- æª”æ¡ˆåˆ—è¡¨ï¼ˆå¡ç‰‡å¤–ï¼Œä¸‹æ–¹ç¨ç«‹ï¼‰ -->
            <div class="file-list-section hidden" id="fileListSection">
                <div class="file-list-header">
                    <span class="file-count" id="fileCountText">0 å€‹æª”æ¡ˆ</span>
                    <div class="join">
                        <button class="btn btn-sm btn-outline btn-primary join-item" id="btnSearchAll" type="button"
                            title="æœå°‹æ‰€æœ‰æœªæœå°‹çš„æª”æ¡ˆ">
                            <i class="bi bi-search"></i> æœå°‹å…¨éƒ¨
                        </button>
                        <button class="btn btn-sm btn-success join-item" id="btnScrapeAll" type="button" title="ç”¢ç”Ÿæ‰€æœ‰å·²æœå°‹çš„æª”æ¡ˆ">
                            <i class="bi bi-folder-plus"></i> ç”¢ç”Ÿå…¨éƒ¨
                        </button>
                    </div>
                </div>

                <!-- æ‰¹æ¬¡é€²åº¦æ¢ -->
                <div class="batch-progress hidden" id="batchProgress">
                    <div class="batch-progress-bar">
                        <div class="batch-progress-fill" id="batchProgressBar"></div>
                    </div>
                    <small class="batch-progress-text" id="batchProgressText">è™•ç†ä¸­ 0/0</small>
                </div>

                <div class="file-list" id="fileList">
                    <!-- å‹•æ…‹ç”Ÿæˆæª”æ¡ˆé …ç›® -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // === å…¨åŸŸå‡½æ•¸ï¼šä¾› PyWebView Python ç«¯å‘¼å« ===

    /**
     * PyWebView æ‹–æ”¾å›èª¿ï¼ˆç”± Python ç«¯å‘¼å«ï¼‰
     * @param {string|string[]} paths - WSL æ ¼å¼çš„æª”æ¡ˆè·¯å¾‘ï¼ˆå–®ä¸€æˆ–é™£åˆ—ï¼‰
     */
    window.handlePyWebViewDrop = function (paths) {
        // çµ±ä¸€è½‰ç‚ºé™£åˆ—
        const pathList = Array.isArray(paths) ? paths : [paths];
        console.log('PyWebView drop:', pathList.length, 'å€‹æª”æ¡ˆ');

        // è§¸ç™¼è‡ªå®šç¾©äº‹ä»¶ï¼Œè®“ä¸»ç¨‹å¼è™•ç†
        window.dispatchEvent(new CustomEvent('pywebview-files', {
            detail: { paths: pathList }
        }));
    };

    // === ä¸»ç¨‹å¼å·²ç§»è‡³ /static/js/pages/search/ ===
</script>
<!-- Alpine State (must load before other JS) -->
<script src="/static/js/pages/search/state.js"></script>
<!-- Existing JS modules -->
<script src="/static/js/pages/search/core.js"></script>
<script src="/static/js/pages/search/ui.js"></script>
<script src="/static/js/pages/search/file.js"></script>
<script src="/static/js/pages/search/init.js"></script>
{% endblock %}