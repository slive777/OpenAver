{% extends "base.html" %}

{% block title %}搜尋 - OpenAver{% endblock %}

{% block extra_css %}
<link href="/static/css/pages/search.css" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- 拖拽覆蓋層 -->
<div class="drag-overlay" id="dragOverlay">
    <div class="drag-overlay-content">
        <i class="bi bi-file-earmark-play"></i>
        <p>放開以搜尋番號</p>
    </div>
</div>

<div class="search-container">
    <!-- Gallery 視圖容器 -->
    <div id="galleryView" class="d-none">
        <iframe id="galleryFrame" src="" sandbox="allow-same-origin allow-scripts"></iframe>
    </div>

    <!-- 搜尋框 -->
    <div class="search-bar">
        <form id="searchForm">
            <div class="spotlight-search">
                <i class="bi bi-search search-icon-left"></i>
                <input type="text" id="searchQuery" name="q" placeholder="搜尋番號、女優或拖入檔案..." autocomplete="off">
                <div class="search-actions-right">
                    <button type="button" id="btnBackToDetail" class="btn-icon d-none" title="返回詳細資料">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    <button type="button" id="btnClear" class="btn-icon d-none" title="清空">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <button type="submit" id="btnSubmit" class="btn-icon active" title="搜尋">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </form>
        <div class="search-hint">
            <i class="bi bi-lightbulb"></i>
            提示：輸入局部番號如 <code>IPZZ-03</code> 可搜尋 030~039，輸入女優名可搜尋其作品
        </div>
    </div>

    <!-- 結果區域 -->
    <div class="result-area">
        <!-- 初始狀態 -->
        <div id="emptyState" class="state-page w-100">
            <i class="bi bi-film"></i>
            <p class="mb-2">輸入番號搜尋，或加入影片檔案</p>
            <div class="empty-actions">
                <button class="btn btn-outline-primary btn-sm" id="btnAddFiles">
                    <i class="bi bi-file-earmark-plus"></i> 加入檔案
                </button>
                <button class="btn btn-outline-primary btn-sm" id="btnAddFolder">
                    <i class="bi bi-folder-plus"></i> 加入資料夾
                </button>
                <button class="btn btn-outline-warning btn-sm" id="btnFavorite" title="載入我的最愛資料夾">
                    <i class="bi bi-star-fill"></i> 我的最愛
                </button>
            </div>
            <small class="mt-2 text-muted">也可直接拖入檔案或資料夾</small>
        </div>

        <!-- 載入中 - 進度指示器 -->
        <div id="loadingState" class="search-progress w-100 d-none">
            <div class="progress-container">
                <!-- 搜尋標題 -->
                <div class="progress-header">
                    <span class="progress-query" id="progressQuery">"搜尋中"</span>
                </div>

                <!-- 單行日誌 -->
                <div class="progress-log" id="progressLog">
                    搜尋中...
                </div>

                <!-- 詳情進度條 -->
                <div class="detail-progress" id="detailProgress">
                    <div class="detail-bar" id="detailBar"></div>
                    <span class="detail-text" id="detailText">0 / 0</span>
                </div>
            </div>
        </div>

        <!-- 錯誤狀態 -->
        <div id="errorState" class="state-page w-100 d-none">
            <i class="bi bi-exclamation-triangle text-danger"></i>
            <p class="text-danger mb-1" id="errorMessage">搜尋失敗</p>
            <small>請檢查番號格式或稍後再試</small>
            <!-- 多檔案模式導航 -->
            <div class="error-nav d-none mt-3" id="errorNav">
                <button class="btn btn-outline-secondary btn-sm" id="errorBtnPrev" title="上一個 (←)">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span class="mx-2" id="errorNavIndicator">1/5</span>
                <button class="btn btn-outline-secondary btn-sm" id="errorBtnNext" title="下一個 (→)">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- 結果卡片 -->
        <div id="resultCard" class="d-none w-100">
            <div class="result-area p-0">
                <!-- 封面區 70% -->
                <div class="cover-section">
                    <div class="cover-wrapper">
                        <img id="resultCover" src="" class="cover-img" alt="封面">
                        <button class="nav-btn prev d-none" id="btnPrev" title="上一個 (←)">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="nav-btn next d-none" id="btnNext" title="下一個 (→)">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                        <div class="nav-indicator d-none" id="navIndicator">
                            <span id="currentIndex">1</span> / <span id="totalCount">1</span>
                        </div>
                    </div>

                    <!-- 檔案/搜尋結果列表（緊貼在封面下方） -->
                    <div class="file-list-section d-none" id="fileListSection">
                        <div class="file-list-header">
                            <span class="file-count" id="fileCountText">0 個檔案</span>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" id="btnSearchAll" type="button"
                                    title="搜尋所有未搜尋的檔案">
                                    <i class="bi bi-search"></i> 搜尋全部
                                </button>
                                <button class="btn btn-success" id="btnScrapeAll" type="button" title="產生所有已搜尋的檔案">
                                    <i class="bi bi-folder-plus"></i> 產生全部
                                </button>
                            </div>
                        </div>

                        <!-- 批次進度條 -->
                        <div class="batch-progress d-none" id="batchProgress">
                            <div class="batch-progress-bar">
                                <div class="batch-progress-fill" id="batchProgressBar"></div>
                            </div>
                            <small class="batch-progress-text" id="batchProgressText">處理中 0/0</small>
                        </div>

                        <div class="file-list" id="fileList">
                            <!-- 動態生成檔案項目 -->
                        </div>
                    </div>
                </div>

                <!-- 資訊區 30% -->
                <div class="info-section">
                    <div class="info-header">
                        <h4 class="info-number" id="resultNumber">-</h4>
                    </div>
                    <div class="info-body">
                        <div class="info-row">
                            <div class="info-label">演員</div>
                            <div class="info-value" id="resultActors">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">發行日期</div>
                            <div class="info-value" id="resultDate">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">片商</div>
                            <div class="info-value" id="resultMaker">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">標籤</div>
                            <div class="info-value" id="resultTags">-</div>
                        </div>
                    </div>
                    <div class="info-footer">
                        <div class="info-label">標題</div>
                        <div class="info-title d-flex align-items-start" id="titleContainer">
                            <span id="resultTitle" style="flex:1;">-</span>
                            <button id="editTitleBtn" class="btn btn-sm btn-link p-0 ms-1" onclick="startEditTitle()"
                                title="編輯標題">
                                <i class="bi bi-pencil text-muted"></i>
                            </button>
                            <!-- AI 翻譯按鈕 -->
                            <button id="translateBtn" class="btn btn-sm btn-link p-0 ms-1 d-none"
                                onclick="translateWithAI()" title="AI 翻譯">
                                <i class="bi bi-translate"></i>
                            </button>
                            <span id="translateSpinner" class="spinner-border spinner-border-sm ms-1 d-none"></span>
                        </div>
                        <div id="chineseTitleRow" class="mt-2 d-none">
                            <div class="info-label" id="chineseTitleLabel">中文片名</div>
                            <div class="info-title d-flex align-items-start" id="chineseTitleContainer">
                                <span id="resultChineseTitle" class="text-success" style="flex:1;">-</span>
                                <button id="editChineseTitleBtn" class="btn btn-sm btn-link p-0 ms-1"
                                    onclick="startEditChineseTitle()" title="編輯中文片名">
                                    <i class="bi bi-pencil text-muted"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // === 全域函數：供 PyWebView Python 端呼叫 ===

    /**
     * 從檔名提取番號（全域版本）
     */
    function extractNumberGlobal(filename) {
        const basename = filename.split(/[/\\]/).pop().replace(/\.[^.]+$/, '');
        const patterns = [
            /\b([A-Z]{1,5})-(\d{3,5})\b/i,   // T28-650, SONE-205（支援單字母）
            /\b([A-Z]{2,5})(\d{3,5})\b/i,     // IPTD927（無連字號需 2+ 字母避免誤判）
            /\b(FC2-PPV)-(\d{5,7})\b/i,
        ];
        for (const pattern of patterns) {
            const match = basename.match(pattern);
            if (match) {
                const prefix = match[1].toUpperCase();
                if (prefix === 'FC2-PPV') return `FC2-PPV-${match[2]}`;
                return `${prefix}-${match[2]}`;
            }
        }
        return null;
    }

    /**
     * PyWebView 拖放回調（由 Python 端呼叫）
     * @param {string|string[]} paths - WSL 格式的檔案路徑（單一或陣列）
     */
    window.handlePyWebViewDrop = function (paths) {
        // 統一轉為陣列
        const pathList = Array.isArray(paths) ? paths : [paths];
        console.log('PyWebView drop:', pathList.length, '個檔案');

        // 觸發自定義事件，讓主程式處理
        window.dispatchEvent(new CustomEvent('pywebview-files', {
            detail: { paths: pathList }
        }));
    };

    // === 主程式已移至 /static/js/pages/search/ ===
</script>
<script src="/static/js/pages/search/core.js"></script>
<script src="/static/js/pages/search/ui.js"></script>
<script src="/static/js/pages/search/file.js"></script>
<script src="/static/js/pages/search/init.js"></script>
{% endblock %}