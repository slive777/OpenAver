{% extends "base.html" %}

{% block title %}æœå°‹ - OpenAver{% endblock %}

{% block extra_css %}
<link href="/static/css/pages/search.css" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- æ‹–æ‹½è¦†è“‹å±¤ -->
<div class="drag-overlay" id="dragOverlay">
    <div class="drag-overlay-content">
        <i class="bi bi-file-earmark-play"></i>
        <p>æ”¾é–‹ä»¥æœå°‹ç•ªè™Ÿ</p>
    </div>
</div>

<div class="search-container">
    <!-- Gallery è¦–åœ–å®¹å™¨ -->
    <div id="galleryView" class="hidden">
        <iframe id="galleryFrame" src="" sandbox="allow-same-origin allow-scripts"></iframe>
    </div>

    <!-- æœå°‹æ¡† -->
    <div class="search-bar">
        <form id="searchForm">
            <div class="spotlight-search">
                <i class="bi bi-search search-icon-left"></i>
                <input type="text" id="searchQuery" name="q" placeholder="æœå°‹ç•ªè™Ÿã€å¥³å„ªæˆ–æ‹–å…¥æª”æ¡ˆ..." autocomplete="off">
                <div class="search-actions-right">
                    <button type="button" id="btnBackToDetail" class="btn-icon hidden" title="è¿”å›è©³ç´°è³‡æ–™">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    <button type="button" id="btnClear" class="btn-icon hidden" title="æ¸…ç©º">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <button type="submit" id="btnSubmit" class="btn-icon active" title="æœå°‹">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </form>
        <div class="search-hint">
            <i class="bi bi-lightbulb"></i>
            æç¤ºï¼šè¼¸å…¥å±€éƒ¨ç•ªè™Ÿå¦‚ <code>IPZZ-03</code> å¯æœå°‹ 030~039ï¼Œè¼¸å…¥å¥³å„ªåå¯æœå°‹å…¶ä½œå“
        </div>
    </div>

    <!-- çµæœå€åŸŸ -->
    <div class="result-area">
        <!-- åˆå§‹ç‹€æ…‹ -->
        <div id="emptyState" class="state-page w-full">
            <i class="bi bi-film"></i>
            <p class="mb-2">è¼¸å…¥ç•ªè™Ÿæœå°‹ï¼Œæˆ–åŠ å…¥å½±ç‰‡æª”æ¡ˆ</p>
            <div class="empty-actions">
                <button class="btn btn-sm btn-outline btn-primary" id="btnAddFiles">
                    <i class="bi bi-file-earmark-plus"></i> åŠ å…¥æª”æ¡ˆ
                </button>
                <button class="btn btn-sm btn-outline btn-primary" id="btnAddFolder">
                    <i class="bi bi-folder-plus"></i> åŠ å…¥è³‡æ–™å¤¾
                </button>
                <button class="btn btn-sm btn-outline btn-warning" id="btnFavorite" title="è¼‰å…¥æˆ‘çš„æœ€æ„›è³‡æ–™å¤¾">
                    <i class="bi bi-star-fill"></i> æˆ‘çš„æœ€æ„›
                </button>
            </div>
            <small class="mt-2 text-muted">ä¹Ÿå¯ç›´æ¥æ‹–å…¥æª”æ¡ˆæˆ–è³‡æ–™å¤¾</small>
        </div>

        <!-- è¼‰å…¥ä¸­ - é€²åº¦æŒ‡ç¤ºå™¨ -->
        <div id="loadingState" class="search-progress w-full hidden">
            <div class="progress-container">
                <!-- æœå°‹æ¨™é¡Œ -->
                <div class="progress-header">
                    <span class="progress-query" id="progressQuery">"æœå°‹ä¸­"</span>
                </div>

                <!-- å–®è¡Œæ—¥èªŒ -->
                <div class="progress-log" id="progressLog">
                    æœå°‹ä¸­...
                </div>

                <!-- è©³æƒ…é€²åº¦æ¢ -->
                <div class="detail-progress" id="detailProgress">
                    <div class="detail-bar" id="detailBar"></div>
                    <span class="detail-text" id="detailText">0 / 0</span>
                </div>
            </div>
        </div>

        <!-- éŒ¯èª¤ç‹€æ…‹ -->
        <div id="errorState" class="state-page w-full hidden">
            <i class="bi bi-exclamation-triangle text-error"></i>
            <p class="text-error mb-1" id="errorMessage">æœå°‹å¤±æ•—</p>
            <small>è«‹æª¢æŸ¥ç•ªè™Ÿæ ¼å¼æˆ–ç¨å¾Œå†è©¦</small>
            <!-- å¤šæª”æ¡ˆæ¨¡å¼å°èˆª -->
            <div class="error-nav hidden mt-3" id="errorNav">
                <button class="btn btn-sm btn-outline btn-neutral" id="errorBtnPrev" title="ä¸Šä¸€å€‹ (â†)">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span class="mx-2" id="errorNavIndicator">1/5</span>
                <button class="btn btn-sm btn-outline btn-neutral" id="errorBtnNext" title="ä¸‹ä¸€å€‹ (â†’)">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- çµæœå¡ç‰‡ -->
        <div id="resultCard" class="hidden w-full">
            <div class="result-area p-0">
                <!-- å°é¢å€ 70% -->
                <div class="cover-section">
                    <div class="cover-wrapper">
                        <img id="resultCover" src="" class="cover-img" alt="å°é¢">
                        <button class="nav-btn prev hidden" id="btnPrev" title="ä¸Šä¸€å€‹ (â†)">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="nav-btn next hidden" id="btnNext" title="ä¸‹ä¸€å€‹ (â†’)">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                        <div class="nav-indicator hidden" id="navIndicator">
                            <span id="currentIndex">1</span> / <span id="totalCount">1</span>
                        </div>
                    </div>

                    <!-- æª”æ¡ˆ/æœå°‹çµæœåˆ—è¡¨ï¼ˆç·Šè²¼åœ¨å°é¢ä¸‹æ–¹ï¼‰ -->
                    <div class="file-list-section hidden" id="fileListSection">
                        <div class="file-list-header">
                            <span class="file-count" id="fileCountText">0 å€‹æª”æ¡ˆ</span>
                            <div class="join">
                                <button class="btn btn-sm btn-outline btn-primary join-item" id="btnSearchAll" type="button"
                                    title="æœå°‹æ‰€æœ‰æœªæœå°‹çš„æª”æ¡ˆ">
                                    <i class="bi bi-search"></i> æœå°‹å…¨éƒ¨
                                </button>
                                <button class="btn btn-sm btn-success join-item" id="btnScrapeAll" type="button" title="ç”¢ç”Ÿæ‰€æœ‰å·²æœå°‹çš„æª”æ¡ˆ">
                                    <i class="bi bi-folder-plus"></i> ç”¢ç”Ÿå…¨éƒ¨
                                </button>
                            </div>
                        </div>

                        <!-- æ‰¹æ¬¡é€²åº¦æ¢ -->
                        <div class="batch-progress hidden" id="batchProgress">
                            <div class="batch-progress-bar">
                                <div class="batch-progress-fill" id="batchProgressBar"></div>
                            </div>
                            <small class="batch-progress-text" id="batchProgressText">è™•ç†ä¸­ 0/0</small>
                        </div>

                        <div class="file-list" id="fileList">
                            <!-- å‹•æ…‹ç”Ÿæˆæª”æ¡ˆé …ç›® -->
                        </div>
                    </div>
                </div>

                <!-- è³‡è¨Šå€ 30% -->
                <div class="info-section">
                    <div class="info-header">
                        <h4 class="info-number" id="resultNumber">-</h4>
                        <span id="localBadge" class="local-badge hidden" title="æœ¬åœ°å·²æœ‰">ğŸ“</span>
                        <button id="switchSourceBtn" class="btn btn-link p-0"
                            onclick="switchSource()" title="åˆ‡æ›ç‰ˆæœ¬">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </div>
                    <div class="info-body">
                        <div class="info-row">
                            <div class="info-label">æ¼”å“¡</div>
                            <div class="info-value" id="resultActors">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">ç™¼è¡Œæ—¥æœŸ</div>
                            <div class="info-value" id="resultDate">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">ç‰‡å•†</div>
                            <div class="info-value" id="resultMaker">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">æ¨™ç±¤</div>
                            <div class="info-value" id="resultTags">-</div>
                        </div>
                    </div>
                    <div class="info-footer">
                        <div class="info-label">æ¨™é¡Œ</div>
                        <div class="info-title flex items-start" id="titleContainer">
                            <span id="resultTitle" style="flex:1;">-</span>
                            <button id="editTitleBtn" class="btn btn-sm btn-link p-0 ml-1" onclick="startEditTitle()"
                                title="ç·¨è¼¯æ¨™é¡Œ">
                                <i class="bi bi-pencil text-muted"></i>
                            </button>
                            <!-- AI ç¿»è­¯æŒ‰éˆ• -->
                            <button id="translateBtn" class="btn btn-sm btn-link p-0 ml-1 hidden"
                                onclick="translateWithAI()" title="æ‰¹æ¬¡ç¿»è­¯ 10 ç‰‡">
                                <i class="bi bi-translate"></i>
                            </button>
                            <span id="translateSpinner" class="loading loading-spinner loading-sm ml-1 hidden"></span>
                        </div>
                        <div id="chineseTitleRow" class="mt-2 hidden">
                            <div class="info-label" id="chineseTitleLabel">ä¸­æ–‡ç‰‡å</div>
                            <div class="info-title flex items-start" id="chineseTitleContainer">
                                <span id="resultChineseTitle" class="text-success" style="flex:1;">-</span>
                                <button id="editChineseTitleBtn" class="btn btn-sm btn-link p-0 ml-1"
                                    onclick="startEditChineseTitle()" title="ç·¨è¼¯ä¸­æ–‡ç‰‡å">
                                    <i class="bi bi-pencil text-muted"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // === å…¨åŸŸå‡½æ•¸ï¼šä¾› PyWebView Python ç«¯å‘¼å« ===

    /**
     * å¾æª”åæå–ç•ªè™Ÿï¼ˆå…¨åŸŸç‰ˆæœ¬ï¼‰
     */
    function extractNumberGlobal(filename) {
        const basename = filename.split(/[/\\]/).pop().replace(/\.[^.]+$/, '');
        const patterns = [
            /\b(FC2-PPV)-(\d{5,7})\b/i,          // FC2-PPV-1234567ï¼ˆå„ªå…ˆï¼‰
            /\b([A-Z]+\d+-\d+)\b/i,              // T28-103 æ··åˆæ ¼å¼ï¼ˆå­—æ¯+æ•¸å­—-æ•¸å­—ï¼‰
            /\b([A-Z]{1,5})-(\d{3,5})\b/i,       // SONE-205ï¼ˆæ”¯æ´å–®å­—æ¯ï¼‰
            /\b([A-Z]{2,5})(\d{3,5})\b/i,        // IPTD927ï¼ˆç„¡é€£å­—è™Ÿéœ€ 2+ å­—æ¯é¿å…èª¤åˆ¤ï¼‰
        ];
        for (const pattern of patterns) {
            const match = basename.match(pattern);
            if (match) {
                const prefix = match[1].toUpperCase();
                // FC2-PPV ç‰¹æ®Šè™•ç†
                if (prefix === 'FC2-PPV') return `FC2-PPV-${match[2]}`;
                // æ··åˆæ ¼å¼å·²åŒ…å«å®Œæ•´ç•ªè™Ÿ
                if (pattern === patterns[1]) return prefix;
                // å…¶ä»–æ ¼å¼éœ€çµ„åˆ
                return `${prefix}-${match[2]}`;
            }
        }
        return null;
    }

    /**
     * PyWebView æ‹–æ”¾å›èª¿ï¼ˆç”± Python ç«¯å‘¼å«ï¼‰
     * @param {string|string[]} paths - WSL æ ¼å¼çš„æª”æ¡ˆè·¯å¾‘ï¼ˆå–®ä¸€æˆ–é™£åˆ—ï¼‰
     */
    window.handlePyWebViewDrop = function (paths) {
        // çµ±ä¸€è½‰ç‚ºé™£åˆ—
        const pathList = Array.isArray(paths) ? paths : [paths];
        console.log('PyWebView drop:', pathList.length, 'å€‹æª”æ¡ˆ');

        // è§¸ç™¼è‡ªå®šç¾©äº‹ä»¶ï¼Œè®“ä¸»ç¨‹å¼è™•ç†
        window.dispatchEvent(new CustomEvent('pywebview-files', {
            detail: { paths: pathList }
        }));
    };

    // === ä¸»ç¨‹å¼å·²ç§»è‡³ /static/js/pages/search/ ===
</script>
<script src="/static/js/pages/search/core.js"></script>
<script src="/static/js/pages/search/ui.js"></script>
<script src="/static/js/pages/search/file.js"></script>
<script src="/static/js/pages/search/init.js"></script>
{% endblock %}