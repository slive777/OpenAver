{% extends "base.html" %}

{% block title %}搜尋 - JavHelper{% endblock %}

{% block extra_css %}
<link href="/static/css/pages/search.css" rel="stylesheet">
{% endblock %}

{% block content %}
{% include 'partials/search/drag_overlay.html' %}

<div class="search-container">
    {% include 'partials/search/header.html' %}
    {% include 'partials/search/results.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// === 全域函數：供 PyWebView Python 端呼叫 ===

/**
 * 從檔名提取番號（全域版本）
 */
function extractNumberGlobal(filename) {
    const basename = filename.split(/[/\]/).pop().replace(/\.[^.]+$/, '');
    const patterns = [
        /\b([A-Z]{1,5})-(\d{3,5})\b/i,   // T28-650, SONE-205（支援單字母）
        /\b([A-Z]{2,5})(\d{3,5})\b/i,     // IPTD927（無連字號需 2+ 字母避免誤判）
        /\b(FC2-PPV)-(\d{5,7})\b/i,
    ];
    for (const pattern of patterns) {
        const match = basename.match(pattern);
        if (match) {
            const prefix = match[1].toUpperCase();
            if (prefix === 'FC2-PPV') return `FC2-PPV-${match[2]}`;
            return `${prefix}-${match[2]}`;
        }
    }
    return null;
}

/**
 * PyWebView 拖放回調（由 Python 端呼叫）
 * @param {string|string[]} paths - WSL 格式的檔案路徑（單一或陣列）
 */
window.handlePyWebViewDrop = function(paths) {
    // 統一轉為陣列
    const pathList = Array.isArray(paths) ? paths : [paths];
    console.log('PyWebView drop:', pathList.length, '個檔案');

    // 觸發自定義事件，讓主程式處理
    window.dispatchEvent(new CustomEvent('pywebview-files', {
        detail: { paths: pathList }
    }));
};
</script>
<script src="/static/js/pages/search.js" defer></script>
{% endblock %}