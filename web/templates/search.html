{% extends "base.html" %}

{% block title %}ÊêúÂ∞ã - OpenAver{% endblock %}

{% block extra_css %}
<link href="/static/css/pages/search.css" rel="stylesheet">
<link href="/static/css/pages/showcase.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="search-container ds-page" x-data="searchPage()" @keydown.window="handleKeydown($event)">
    <!-- ÊãñÊãΩË¶ÜËìãÂ±§ÔºàÂøÖÈ†àÂú® x-data scope ÂÖßÔºâ -->
    <div class="drag-overlay" id="dragOverlay" :class="{ active: dragActive }">
        <div class="drag-overlay-content">
            <i class="bi bi-file-earmark-play"></i>
            <p>ÊîæÈñã‰ª•ÊêúÂ∞ãÁï™Ëôü</p>
        </div>
    </div>

    <!-- T2a: LightboxÔºàGrid Ê®°ÂºèÔºâ -->
    <div class="showcase-lightbox"
         :class="{ 'show': lightboxOpen }"
         @click="handleLightboxBackdropClick($event)">

        <div class="lightbox-content" @click.stop>
            <!-- Close Button -->
            <button class="lightbox-close"
                    @click="closeLightbox()"
                    title="ÈóúÈñâ (ESC)">
                <i class="bi bi-x-lg"></i>
            </button>

            <!-- Cover Image -->
            <div class="lightbox-cover">
                <img :src="actressLightboxMode
                         ? (actressProfile?.img ? `/api/proxy-image?url=${encodeURIComponent(actressProfile.img)}` : '')
                         : (currentLightboxVideo()?.cover ? `/api/proxy-image?url=${encodeURIComponent(currentLightboxVideo().cover)}` : '')"
                     :alt="actressLightboxMode ? actressProfile?.name : currentLightboxVideo()?.number"
                     @error="$event.target.onerror=null; $event.target.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22 fill=%22%23666%22><rect width=%22400%22 height=%22300%22 fill=%22%23222%22/><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22>No Image</text></svg>'">
            </div>
        </div>

        <!-- Navigation Arrows -->
        <button class="lightbox-nav lightbox-nav-prev"
                @click.stop="prevLightboxVideo()"
                x-show="!actressLightboxMode && lightboxIndex > 0"
                title="‰∏ä‰∏ÄÈÉ® (‚Üê)">
            <i class="bi bi-chevron-left"></i>
        </button>
        <button class="lightbox-nav lightbox-nav-next"
                @click.stop="nextLightboxVideo()"
                x-show="!actressLightboxMode && lightboxIndex < searchResults.length - 1"
                title="‰∏ã‰∏ÄÈÉ® (‚Üí)">
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>

    <!-- ÊêúÂ∞ãÊ°Ü -->
    <div class="search-bar">
        <form id="searchForm" @submit.prevent="doSearch()">
            <div class="spotlight-search">
                <i class="bi bi-search search-icon-left"></i>
                <input type="text" id="searchQuery" name="q" placeholder="ÊêúÂ∞ãÁï™Ëôü„ÄÅÂ•≥ÂÑ™ÊàñÊãñÂÖ•Ê™îÊ°à..." autocomplete="off" x-model="searchQuery">
                <div class="search-actions-right">
                    <!-- ÂèñÊ∂àÊêúÂ∞ãÊåâÈàïÔºàloading ÁãÄÊÖãÈ°ØÁ§∫Ôºâ -->
                    <button type="button"
                            x-show="pageState === 'loading'"
                            @click="cancelSearch()"
                            class="btn-icon"
                            title="ÂèñÊ∂àÊêúÂ∞ã">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <!-- T2a/T3a: Grid / Detail Toggle -->
                    <button type="button"
                            class="btn-icon rotating-border-spotlight active"
                            x-show="listMode === 'search' && appConfig?.search?.gallery_mode_enabled !== false && (currentMode === 'actress' || currentMode === 'prefix')"
                            @click="toggleDisplayMode()"
                            :title="displayMode === 'detail' ? 'ÂàáÊèõÂà∞ÂúñÁâáÊ®°Âºè' : 'ÂàáÊèõÂà∞Ë©≥Á¥∞Ê®°Âºè'">
                        <i class="bi" :class="displayMode === 'detail' ? 'bi-grid-3x3' : 'bi-list-ul'"></i>
                    </button>
                    <button type="button" id="btnClear" class="btn-icon" x-show="hasContent" x-cloak @click="clearAll()" title="Ê∏ÖÁ©∫">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <button type="submit" id="btnSubmit" class="btn-icon active" title="ÊêúÂ∞ã">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </form>
        <div class="search-hint">
            <i class="bi bi-lightbulb"></i>
            ÊèêÁ§∫ÔºöËº∏ÂÖ•Â±ÄÈÉ®Áï™ËôüÂ¶Ç <code>IPZZ-03</code> ÂèØÊêúÂ∞ã 030~039ÔºåËº∏ÂÖ•Â•≥ÂÑ™ÂêçÂèØÊêúÂ∞ãÂÖ∂‰ΩúÂìÅ
        </div>
    </div>

    <!-- ÁµêÊûúÂçÄÂüü -->
    <div class="result-area">
        <!-- ÂàùÂßãÁãÄÊÖã -->
        <div id="emptyState" class="state-page w-full" x-show="pageState === 'empty'">
            <i class="bi bi-film state-page-icon"></i>
            <p class="state-page-text">Ëº∏ÂÖ•Áï™ËôüÊêúÂ∞ãÔºåÊàñÂä†ÂÖ•ÂΩ±ÁâáÊ™îÊ°à</p>
            <div class="empty-actions">
                <button class="btn btn-sm btn-outline btn-primary" id="btnAddFiles" @click="addFiles()">
                    <i class="bi bi-file-earmark-plus"></i> Âä†ÂÖ•Ê™îÊ°à
                </button>
                <button class="btn btn-sm btn-outline btn-primary" id="btnAddFolder" @click="addFolder()">
                    <i class="bi bi-folder-plus"></i> Âä†ÂÖ•Ë≥áÊñôÂ§æ
                </button>
                <button class="btn btn-sm btn-outline btn-warning" id="btnFavorite" @click="loadFavorite()" :disabled="isLoadingFavorite" title="ËºâÂÖ•ÊàëÁöÑÊúÄÊÑõË≥áÊñôÂ§æ">
                    <template x-if="!isLoadingFavorite"><i class="bi bi-star-fill"></i></template>
                    <span x-show="isLoadingFavorite" class="loading loading-spinner loading-sm"></span>
                    <span x-text="isLoadingFavorite ? '' : 'ÊàëÁöÑÊúÄÊÑõ'">ÊàëÁöÑÊúÄÊÑõ</span>
                </button>
            </div>
            <small class="state-page-hint">‰πüÂèØÁõ¥Êé•ÊãñÂÖ•Ê™îÊ°àÊàñË≥áÊñôÂ§æ</small>
        </div>

        <!-- ËºâÂÖ•‰∏≠ - ÈÄ≤Â∫¶ÊåáÁ§∫Âô® -->
        <div id="loadingState" class="search-progress w-full" x-show="pageState === 'loading'" x-cloak>
            <div class="progress-container">
                <!-- ÊêúÂ∞ãÊ®ôÈ°å -->
                <div class="progress-header">
                    <span class="progress-query" x-text="'&quot;' + currentQuery + '&quot;'"></span>
                </div>

                <!-- ÂñÆË°åÊó•Ë™å -->
                <div class="progress-log" x-text="progressLog">
                    ÊêúÂ∞ã‰∏≠...
                </div>

                <!-- Ë©≥ÊÉÖÈÄ≤Â∫¶Ê¢ù -->
                <div class="detail-progress" x-show="detailTotal > 0">
                    <div class="detail-bar" :style="'width:' + detailProgressPercent() + '%'"></div>
                    <span class="detail-text" x-text="detailDone + ' / ' + detailTotal">0 / 0</span>
                </div>
            </div>
        </div>

        <!-- ÈåØË™§ÁãÄÊÖã -->
        <div id="errorState" class="state-page error w-full" x-show="pageState === 'error'" x-cloak>
            <i class="bi bi-exclamation-triangle state-page-icon"></i>
            <p class="state-page-text error-text" id="errorMessage" x-text="errorText || 'ÊêúÂ∞ãÂ§±Êïó'">ÊêúÂ∞ãÂ§±Êïó</p>
            <small class="state-page-hint">Ë´ãÊ™¢Êü•Áï™ËôüÊ†ºÂºèÊàñÁ®çÂæåÂÜçË©¶</small>
            <!-- Â§öÊ™îÊ°àÊ®°ÂºèÂ∞éËà™ -->
            <div class="error-nav" x-show="fileList.length > 1" id="errorNav">
                <button class="btn btn-sm btn-outline btn-neutral"
                        id="errorBtnPrev"
                        :disabled="!canGoPrev()"
                        @click="navigate(-1)"
                        title="‰∏ä‰∏ÄÂÄã (‚Üê)">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span class="error-nav-indicator" id="errorNavIndicator" x-text="navIndicatorText()">1/5</span>
                <button class="btn btn-sm btn-outline btn-neutral"
                        id="errorBtnNext"
                        :disabled="!canGoNext()"
                        @click="navigate(1)"
                        title="‰∏ã‰∏ÄÂÄã (‚Üí)">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- ÁµêÊûúÂç°ÁâáÔºàwrapperÔºöÂç°Áâá + Ê™îÊ°àÂàóË°®ÂûÇÁõ¥ÊéíÂàóÔºâ -->
        <div id="resultCard" x-show="pageState === 'result'" x-cloak>
            <!-- T5: Actress Banner ÂÆåÂÖ®ÁßªÈô§ÔºàDetail Ê®°Âºè‰∏çÈ°ØÁ§∫Â•≥ÂÑ™Ë≥áË®äÔºâ-->
            <!-- Hero Card ‰ªçÂú® Grid Ê®°ÂºèÈ°ØÁ§∫ÔºàL379-400ÔºåÂ∑≤Êúâ x-show="displayMode === 'grid'"Ôºâ -->

            <!-- AV Card FullÔºöÂ∞ÅÈù¢ + Ë≥áË®ä‰∏¶ÊéíÔºàDetail Ê®°ÂºèÔºâ -->
            <div class="av-card-full rotating-border-spotlight"
                 x-show="displayMode === 'detail'"
                 :class="{ 'active once': shouldShowLocalBorder(current()) }"
                 @animationend.self="markLocalBorderPlayed(current()?.number)">
                <div class="av-card-full-cover">
                    <div class="av-card-full-cover-wrapper">
                        <img id="resultCover" class="av-card-full-cover-img"
                             x-show="!coverError && current().cover"
                             :src="coverUrl()"
                             @error="handleCoverError()"
                             @load="coverError = ''; _coverRetried = false"
                             alt="Â∞ÅÈù¢">
                        <!-- Â∞ÅÈù¢ÈåØË™§ -->
                        <div x-show="coverError" class="cover-error-placeholder">
                            <i class="bi bi-exclamation-triangle text-5xl text-warning"></i>
                            <p x-text="coverError" class="mt-2"></p>
                            <small>Ë´ãÊ™¢Êü•Áï™ËôüÊ†ºÂºèÊàñÁ®çÂæåÂÜçË©¶</small>
                        </div>
                        <!-- ÁÑ°Â∞ÅÈù¢ -->
                        <div x-show="!coverError && !current().cover" class="cover-error-placeholder">
                            <i class="bi bi-image text-5xl"></i>
                        </div>
                        <button class="nav-btn prev" id="btnPrev"
                                x-show="showNavigation()"
                                :disabled="!canGoPrev() || (isSearchingFile && searchingFileDirection === 'prev')"
                                @click="navigate(-1)"
                                title="‰∏ä‰∏ÄÂÄã (‚Üê)">
                            <i x-show="!(isSearchingFile && searchingFileDirection === 'prev')" class="bi bi-chevron-left"></i>
                            <span x-show="isSearchingFile && searchingFileDirection === 'prev'" class="loading loading-spinner loading-sm"></span>
                        </button>
                        <button class="nav-btn next" id="btnNext"
                                x-show="showNavigation()"
                                :disabled="!canGoNext() || isLoadingMore || (isSearchingFile && searchingFileDirection === 'next')"
                                @click="navigate(1)"
                                title="‰∏ã‰∏ÄÂÄã (‚Üí)">
                            <i x-show="!isLoadingMore && !(isSearchingFile && searchingFileDirection === 'next')" class="bi bi-chevron-right"></i>
                            <span x-show="isLoadingMore || (isSearchingFile && searchingFileDirection === 'next')" class="loading loading-spinner loading-sm"></span>
                        </button>
                        <div class="nav-indicator" id="navIndicator"
                             x-show="showNavigation()">
                            <span id="currentIndex"
                                  x-text="fileList.length > 1 ? (currentFileIndex + 1) : (currentIndex + 1)">1</span> /
                            <span id="totalCount"
                                  x-text="fileList.length > 1 ? fileList.length : (hasMoreResults ? (searchResults.length + '+') : searchResults.length)">1</span>
                        </div>
                    </div>
                </div>
                <div class="av-card-full-info">
                <div class="av-card-full-header">
                    <h4 class="av-num" id="resultNumber" x-text="current().number || '-'">-</h4>
                    <span id="localBadge" class="local-badge"
                          x-show="hasLocalBadge()"
                          :title="localBadgeTitle()"
                          @click="copyLocalPath()">üìÅ</span>
                    <button id="switchSourceBtn" class="info-icon-btn"
                            @click="switchSource()"
                            title="ÂàáÊèõÁâàÊú¨"
                            :disabled="isSwitchingSource"
                            :class="{ 'shake': switchSourceShake }">
                        <i class="bi bi-arrow-repeat" x-show="!isSwitchingSource"></i>
                        <span x-show="isSwitchingSource" class="loading loading-spinner loading-sm"></span>
                    </button>
                </div>
                <div class="av-card-full-body">
                    <div class="info-row">
                        <span class="info-label">ÊºîÂì°</span>
                        <span class="info-value" id="resultActors" x-text="(current().actors || []).join(', ') || '-'">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ÁôºË°åÊó•Êúü</span>
                        <span class="info-value" id="resultDate" x-text="current().date || '-'">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ÁâáÂïÜ</span>
                        <span class="info-value" id="resultMaker" x-text="current().maker || '-'">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ê®ôÁ±§</span>
                        <span class="info-value" id="resultTags">
                            <!-- Â≠óÂπïÊ®ôÁ±§ -->
                            <span x-show="hasSubtitle()" class="badge tag-badge subtitle">‰∏≠ÊñáÂ≠óÂπï</span>
                            <!-- Á≥ªÁµ±Ê®ôÁ±§ -->
                            <template x-for="tag in (current().tags || [])" :key="tag">
                                <span class="badge tag-badge" x-text="tag"></span>
                            </template>
                            <!-- Áî®Êà∂Ê®ôÁ±§ -->
                            <template x-for="tag in (current().user_tags || [])" :key="'u_' + tag">
                                <span class="badge tag-badge user-tag">
                                    <span x-text="tag"></span>
                                    <span class="tag-remove" @click="removeUserTag(tag)">&times;</span>
                                </span>
                            </template>
                            <!-- Êñ∞Â¢ûÊ®ôÁ±§ÊåâÈàï -->
                            <button x-show="!addingTag" @click="showAddTagInput()" class="btn btn-sm tag-add-btn" title="Êñ∞Â¢ûÊ®ôÁ±§">+</button>
                            <!-- Êñ∞Â¢ûÊ®ôÁ±§Ëº∏ÂÖ•Ê°Ü -->
                            <span x-show="addingTag" class="tag-input-wrapper">
                                <input type="text" x-ref="tagInput" x-model="newTagValue"
                                       @keydown.enter="confirmAddTag()" @keydown.escape="cancelAddTag()"
                                       class="tag-input" placeholder="Ê®ôÁ±§ÂêçÁ®±" maxlength="20">
                                <button @click="confirmAddTag()" class="btn btn-sm tag-confirm">‚úì</button>
                                <button @click="cancelAddTag()" class="btn btn-sm tag-cancel">‚úï</button>
                            </span>
                        </span>
                    </div>
                </div>
                <div class="av-card-full-footer">
                    <div class="av-card-full-footer-content">
                        <span class="info-label">Ê®ôÈ°å</span>
                        <!-- È°ØÁ§∫Ê®°Âºè -->
                        <div class="info-value-with-actions" id="titleContainer" x-show="!editingTitle">
                            <span class="info-value" id="resultTitle" x-text="current().title || '-'">-</span>
                            <div class="av-card-full-footer-actions">
                                <button id="editTitleBtn" class="info-icon-btn" @click="startEditTitle()" title="Á∑®ËºØÊ®ôÈ°å">
                                    <i :class="current()._titleEdited ? 'bi bi-pencil-fill text-success' : 'bi bi-pencil text-muted'"></i>
                                </button>
                                <button id="translateBtn" class="info-icon-btn"
                                        x-show="canTranslate() && !isTranslating"
                                        @click="translateWithAI()" title="AI ÁøªË≠Ø">
                                    <i class="bi bi-translate"></i>
                                </button>
                                <span id="translateSpinner" class="loading loading-spinner loading-sm"
                                      x-show="isTranslating"></span>
                            </div>
                        </div>
                        <!-- Á∑®ËºØÊ®°Âºè -->
                        <div class="info-value-with-actions" x-show="editingTitle" x-cloak>
                            <textarea x-ref="titleInput" x-model="editedTitleValue"
                                      @keydown.enter.prevent="confirmEditTitle()"
                                      @keydown.escape="cancelEditTitle()"
                                      class="textarea textarea-bordered info-value flex-1 min-w-0 resize-none"
                                      rows="3"></textarea>
                            <div class="av-card-full-footer-actions">
                                <button class="info-icon-btn text-success" @click="confirmEditTitle()" title="Á¢∫Ë™ç">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button class="info-icon-btn text-error" @click="cancelEditTitle()" title="ÂèñÊ∂à">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- ‰∏≠ÊñáÊ®ôÈ°å -->
                    <div id="chineseTitleRow" class="av-card-full-footer-content mt-2"
                         x-show="hasChineseTitle()">
                        <span class="info-label" id="chineseTitleLabel" x-text="chineseTitleLabel()">‰∏≠ÊñáÁâáÂêç</span>
                        <!-- È°ØÁ§∫Ê®°Âºè -->
                        <div class="info-value-with-actions" id="chineseTitleContainer" x-show="!editingChineseTitle">
                            <span class="info-value text-success" id="resultChineseTitle" x-text="chineseTitleText()">-</span>
                            <div class="av-card-full-footer-actions">
                                <button id="editChineseTitleBtn" class="info-icon-btn" @click="startEditChineseTitle()" title="Á∑®ËºØ‰∏≠ÊñáÁâáÂêç">
                                    <i :class="current()._chineseTitleEdited ? 'bi bi-pencil-fill text-success' : 'bi bi-pencil text-muted'"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Á∑®ËºØÊ®°Âºè -->
                        <div class="info-value-with-actions" x-show="editingChineseTitle" x-cloak>
                            <textarea x-ref="chineseTitleInput" x-model="editedChineseTitleValue"
                                      @keydown.enter.prevent="confirmEditChineseTitle()"
                                      @keydown.escape="cancelEditChineseTitle()"
                                      class="textarea textarea-bordered info-value text-success flex-1 min-w-0 resize-none"
                                      rows="2"></textarea>
                            <div class="av-card-full-footer-actions">
                                <button class="info-icon-btn text-success" @click="confirmEditChineseTitle()" title="Á¢∫Ë™ç">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button class="info-icon-btn text-error" @click="cancelEditChineseTitle()" title="ÂèñÊ∂à">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- T2a: Grid ModeÔºàÂ∞ÅÈù¢ÁâÜÔºâ -->
            <div class="search-grid ds-gallery-composition" x-show="displayMode === 'grid' && listMode === 'search'" x-cloak>
                <!-- T2d: Hero CardÔºàÁ¨¨‰∏ÄÊ†ºÔºâ-->
                <div class="av-card-preview hero-card"
                     x-show="actressProfile"
                     x-cloak
                     @click="openActressLightbox()">
                    <div class="av-card-preview-img">
                        <img :src="actressProfile?.img ? `/api/proxy-image?url=${encodeURIComponent(actressProfile.img)}` : ''"
                             :alt="actressProfile?.name"
                             loading="lazy"
                             @error="$event.target.onerror=null; $event.target.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22360%22 height=%22508%22 fill=%22%23666%22><rect width=%22360%22 height=%22508%22 fill=%22%23222%22/><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22>No Image</text></svg>'">
                    </div>
                    <div class="av-card-preview-footer">
                        <div class="footer-default">
                            <span class="av-num" x-text="actressProfile?.birth || '-'">-</span>
                            <span class="av-actress" x-text="actressProfile?.height || ''"></span>
                        </div>
                        <div class="footer-hover">
                            <div class="hover-title" x-text="[actressProfile?.name || '', actressProfile?.age ? actressProfile?.age + 'Ê≠≤' : '', actressProfile?.cup ? actressProfile?.cup + 'ÁΩ©ÊùØ' : '', actressProfile?.bust || '', actressProfile?.waist || '', actressProfile?.hip || '', actressProfile?.hometown || '', actressProfile?.hobby || ''].filter(Boolean).join(' ¬∑ ') || '-'"></div>
                        </div>
                    </div>
                </div>

                <!-- Ê≠£Â∏∏ÊêúÂ∞ãÁµêÊûúÂç°Áâá -->
                <template x-for="(result, index) in searchResults" :key="result.number + '_' + index">
                    <div class="av-card-preview"
                         @click="openLightbox(index)"
                         :class="{ 'rotating-border-spotlight active once': shouldShowLocalBorder(result) }"
                         @animationend.self="markLocalBorderPlayed(result?.number)">
                        <div class="av-card-preview-img">
                            <img :src="result.cover ? `/api/proxy-image?url=${encodeURIComponent(result.cover)}` : ''"
                                 :alt="result.number"
                                 loading="lazy"
                                 x-show="!_gridImageErrors.has(index)"
                                 @error="markImageError(index)">
                            <!-- Overlay Actions (Hover) -->
                            <div class="av-card-preview-overlay">
                                <button class="btn-glass-circle"
                                        @click.stop="switchToDetail(index)"
                                        title="Êü•ÁúãË©≥ÊÉÖ">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                                <button class="btn-glass-circle"
                                        @click.stop="copyPath(result._localStatus?.paths?.[0] || '')"
                                        x-show="result._localStatus?.exists"
                                        title="Ë§áË£ΩË∑ØÂæë">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        <div class="av-card-preview-footer">
                            <div class="footer-default">
                                <span class="av-num" x-text="result.number || '-'">-</span>
                                <span class="av-actress" x-text="(result.actors || []).slice(0, 2).join(', ') || 'Êú™Áü•'">Êú™Áü•</span>
                            </div>
                            <div class="footer-hover">
                                <div class="hover-title" x-text="result.title || 'Êú™Áü•Ê®ôÈ°å'">Êú™Áü•Ê®ôÈ°å</div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Ê™îÊ°àÂàóË°®ÔºàÂç°ÁâáÂ§ñÔºå‰∏ãÊñπÁç®Á´ãÔºâ -->
            <div class="file-list-section" id="fileListSection"
                 x-show="(listMode === 'file' && fileList.length > 0) || (listMode === 'search' && searchResults.length > 0)">
                <div class="file-list-header">
                    <span class="file-count" id="fileCountText" x-text="fileCountText()">0 ÂÄãÊ™îÊ°à</span>
                    <div class="join">
                        <button class="btn btn-sm btn-outline btn-primary join-item" id="btnSearchAll" type="button"
                            @click="searchAll()"
                            :disabled="searchAllDisabled()"
                            title="ÊêúÂ∞ãÊâÄÊúâÊú™ÊêúÂ∞ãÁöÑÊ™îÊ°à">
                            <i :class="searchAllButtonIcon()"></i>
                            <span x-text="searchAllButtonText()">ÊêúÂ∞ãÂÖ®ÈÉ®</span>
                        </button>
                        <button class="btn btn-sm btn-success join-item" id="btnScrapeAll" type="button"
                            x-show="listMode === 'file'"
                            @click="scrapeAll()"
                            :disabled="isScrapeAllProcessing"
                            title="Áî¢ÁîüÊâÄÊúâÂ∑≤ÊêúÂ∞ãÁöÑÊ™îÊ°à">
                            <span x-show="!isScrapeAllProcessing"><i class="bi bi-folder-plus"></i> Áî¢ÁîüÂÖ®ÈÉ®</span>
                            <span x-show="isScrapeAllProcessing" class="loading loading-spinner loading-sm"></span>
                        </button>
                    </div>
                </div>

                <!-- ÊâπÊ¨°ÈÄ≤Â∫¶Ê¢ù -->
                <div class="batch-progress" id="batchProgress"
                     x-show="batchState.isProcessing">
                    <div class="batch-progress-bar">
                        <div class="batch-progress-fill" id="batchProgressBar"
                             :style="'width:' + batchPercent() + '%'"></div>
                    </div>
                    <small class="batch-progress-text" id="batchProgressText"
                           x-text="'ËôïÁêÜ‰∏≠ ' + batchState.processed + '/' + batchState.total">ËôïÁêÜ‰∏≠ 0/0</small>
                </div>

                <!-- Ê™îÊ°àÂàóË°® -->
                <div x-show="listMode === 'file'" class="file-list" id="fileList">
                    <template x-for="(file, i) in fileList" :key="file.path">
                        <div @click="switchToFile(i, 'first')"
                             :class="i === currentFileIndex ? 'file-item active' : 'file-item'">
                            <!-- ÁßªÈô§ÊåâÈàï -->
                            <button class="btn btn-link btn-sm p-0 btn-remove-file text-muted"
                                    @click.stop="removeFile(i)"
                                    title="ÁßªÈô§Ê≠§Ê™îÊ°à">
                                <i class="bi bi-x"></i>
                            </button>

                            <!-- Ê™îÊ°àÂúñÁ§∫ -->
                            <i class="bi bi-file-earmark-play file-icon"></i>

                            <!-- Ê™îÂêç -->
                            <span class="file-name" :title="file.path" x-text="file.filename">-</span>

                            <!-- ÁãÄÊÖãÂúñÁ§∫ -->
                            <span :class="fileStatusClass(file)"
                                  x-text="fileStatusIcon(file)"></span>

                            <!-- Âãï‰ΩúÊåâÈàïÔºöÁî¢Áîü NFO -->
                            <button x-show="canScrapeFile(file) && !file.isScraping && file.scrapeStatus !== 'done'"
                                    @click.stop="scrapeSingle(i)"
                                    class="btn btn-sm btn-outline btn-success btn-scrape-single"
                                    title="Áî¢Áîü NFO + Â∞ÅÈù¢">
                                <i class="bi bi-folder-plus"></i>
                            </button>

                            <!-- Scraping spinner -->
                            <span x-show="file.isScraping" class="loading loading-spinner loading-sm"></span>

                            <!-- Scrape done -->
                            <button x-show="file.scrapeStatus === 'done'"
                                    class="btn btn-sm btn-success btn-scrape-single" disabled>
                                <i class="bi bi-check"></i>
                            </button>

                            <!-- Scrape failed -->
                            <button x-show="file.scrapeStatus === 'failed'"
                                    @click.stop="scrapeSingle(i)"
                                    class="btn btn-sm btn-error btn-scrape-single"
                                    title="ÈáçË©¶">
                                Â§±Êïó
                            </button>

                            <!-- Âãï‰ΩúÊåâÈàïÔºöÊâãÂãïËº∏ÂÖ•Áï™Ëôü -->
                            <button x-show="needsNumberInput(file)"
                                    @click.stop="enterNumber(i)"
                                    class="btn btn-sm btn-outline btn-warning btn-enter-number"
                                    title="ÊâãÂãïËº∏ÂÖ•Áï™Ëôü">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    </template>
                </div>

                <!-- ÊêúÂ∞ãÁµêÊûúÂàóË°® -->
                <div x-show="listMode === 'search'" class="file-list">
                    <template x-for="(result, i) in searchResults" :key="(result.number || '') + '_' + i">
                        <div @click="switchToSearchResult(i)"
                             :class="i === currentIndex ? 'file-item active' : 'file-item'">
                            <span class="flex-shrink-0 font-medium text-primary min-w-[90px]"
                                  x-text="result.number || '-'">-</span>
                            <span class="flex-shrink-0 min-w-[80px] text-base-content/70"
                                  x-text="(result.actors || []).slice(0,2).join(', ') || '-'">-</span>
                            <span class="flex-1 overflow-hidden text-ellipsis whitespace-nowrap"
                                  x-text="result.title || '-'">-</span>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- T6b: Áµ±‰∏Ä Toast ÁµÑ‰ª∂ÔºàÂõ∫ÂÆö‰ΩçÁΩÆÔºåAlpine ÁÆ°ÁêÜÔºâ -->
    <div class="search-toast-container"
         x-show="_toast.visible"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 translate-y-4">
        <div class="alert"
             :class="{
                 'alert-success': _toast.type === 'success',
                 'alert-error': _toast.type === 'error',
                 'alert-warning': _toast.type === 'warning',
                 'alert-info': _toast.type === 'info'
             }">
            <i class="bi"
               :class="{
                   'bi-check-circle-fill': _toast.type === 'success',
                   'bi-exclamation-circle-fill': _toast.type === 'error',
                   'bi-exclamation-triangle-fill': _toast.type === 'warning',
                   'bi-info-circle-fill': _toast.type === 'info'
               }"></i>
            <span x-text="_toast.message"></span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // === ÂÖ®ÂüüÂáΩÊï∏Ôºö‰æõ PyWebView Python Á´ØÂëºÂè´ ===

    /**
     * PyWebView ÊãñÊîæÂõûË™øÔºàÁî± Python Á´ØÂëºÂè´Ôºâ
     * @param {string|string[]} paths - WSL Ê†ºÂºèÁöÑÊ™îÊ°àË∑ØÂæëÔºàÂñÆ‰∏ÄÊàñÈô£ÂàóÔºâ
     */
    window.handlePyWebViewDrop = function (paths) {
        // Áµ±‰∏ÄËΩâÁÇ∫Èô£Âàó
        const pathList = Array.isArray(paths) ? paths : [paths];
        console.log('PyWebView drop:', pathList.length, 'ÂÄãÊ™îÊ°à');

        // Ëß∏ÁôºËá™ÂÆöÁæ©‰∫ã‰ª∂ÔºåËÆì‰∏ªÁ®ãÂºèËôïÁêÜ
        window.dispatchEvent(new CustomEvent('pywebview-files', {
            detail: { paths: pathList }
        }));
    };

    // === ‰∏ªÁ®ãÂºèÂ∑≤ÁßªËá≥ /static/js/pages/search/ ===
</script>
<!-- Alpine State Modules (must load before other JS) -->
<script src="/static/js/pages/search/state/base.js"></script>
<script src="/static/js/pages/search/state/persistence.js"></script>
<script src="/static/js/pages/search/state/search-flow.js"></script>
<script src="/static/js/pages/search/state/navigation.js"></script>
<script src="/static/js/pages/search/state/result-card.js"></script>
<script src="/static/js/pages/search/state/file-list.js"></script>
<script src="/static/js/pages/search/state/batch.js"></script>
<script src="/static/js/pages/search/state/bridge.js"></script>
<script src="/static/js/pages/search/state/grid-mode.js"></script>
<script src="/static/js/pages/search/state/index.js"></script>
<!-- Existing JS modules -->
<script src="/static/js/pages/search/core.js"></script>
<script src="/static/js/pages/search/ui.js"></script>
<script src="/static/js/pages/search/file.js"></script>
<script src="/static/js/pages/search/init.js"></script>
{% endblock %}
