{% extends "base.html" %}

{% block title %}列表生成 - JavHelper{% endblock %}

{% block extra_css %}
<style>
    .avlist-container {
        max-width: 800px;
        margin: 0 auto;
    }

    /* Toast 提示 */
    .toast-msg {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        padding: 0.75rem 1.25rem;
        background: #212529;
        color: #fff;
        font-size: 0.875rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 2000;
        max-width: 90vw;
        word-break: break-all;
    }

    .toast-msg.show {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
    }

    .directory-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-light);
        border-radius: 0.375rem;
        background: var(--bg-card);
    }

    .directory-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--border-light);
        gap: 0.5rem;
    }

    .directory-item:last-child {
        border-bottom: none;
    }

    .directory-item .path {
        flex: 1;
        font-family: monospace;
        font-size: 0.875rem;
        word-break: break-all;
    }

    .directory-item .btn-remove {
        flex-shrink: 0;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    .empty-list {
        padding: 2rem;
        text-align: center;
        color: var(--text-secondary);
    }

    .output-section {
        background: var(--bg-card);
        padding: 1rem;
        border-radius: 0.375rem;
        margin-top: 1rem;
    }

    .progress-section {
        display: none;
        margin-top: 1rem;
    }

    .progress-section.show {
        display: block;
    }

    .log-output {
        max-height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 0.8rem;
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 0.75rem;
        border-radius: 0.375rem;
        margin-top: 0.5rem;
    }

    .log-output .log-info {
        color: #6a9955;
    }

    .log-output .log-warn {
        color: #dcdcaa;
    }

    .log-output .log-error {
        color: #f14c4c;
    }

    /* 手動輸入區 */
    .manual-input {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    /* 拖曳遮罩 */
    .drag-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        z-index: 9999;
        pointer-events: none;
    }

    .drag-overlay.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .drag-overlay-content {
        background: transparent;
        padding: 2rem;
        text-align: center;
        color: #fff;
    }

    .drag-overlay-content i {
        font-size: 4rem;
        color: #fff;
        text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<!-- 拖曳遮罩 -->
<div class="drag-overlay" id="dragOverlay">
    <div class="drag-overlay-content">
        <i class="bi bi-folder-plus"></i>
        <p class="mt-2 mb-0 fw-bold">放開以加入資料夾</p>
    </div>
</div>

<div class="avlist-container">
    <h4 class="mb-4"><i class="bi bi-list-ul"></i> 列表生成</h4>

    <!-- 資料夾列表 -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-folder"></i> 掃描資料夾</span>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="selectFolder()" title="選擇資料夾">
                    <i class="bi bi-folder-plus"></i> 選擇
                </button>
                <button class="btn btn-outline-secondary" onclick="toggleManualInput()" title="手動輸入">
                    <i class="bi bi-keyboard"></i>
                </button>
            </div>
        </div>
        <div class="card-body p-2">
            <!-- 手動輸入 -->
            <div class="manual-input" id="manualInput" style="display: none;">
                <input type="text" class="form-control form-control-sm" id="manualPath"
                    placeholder="輸入資料夾路徑，例如: /mnt/c/Videos 或 \\\\NAS\\share">
                <button class="btn btn-sm btn-primary" onclick="addManualPath()">
                    <i class="bi bi-plus"></i> 加入
                </button>
            </div>

            <!-- 資料夾列表 -->
            <div class="directory-list" id="directoryList"></div>
        </div>
        <div class="card-footer text-end" id="dirFooter" style="display: none;">
            <button class="btn btn-sm btn-primary" onclick="saveConfig()">
                <i class="bi bi-save"></i> 儲存
            </button>
        </div>
    </div>

    <!-- 輸出設定 -->
    <div class="output-section">
        <div class="row align-items-end">
            <div class="col-md-6 mb-2 mb-md-0">
                <label class="form-label small"><i class="bi bi-file-earmark-code"></i> 輸出檔案</label>
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" id="outputDir" placeholder="output">
                    <span class="input-group-text">/</span>
                    <input type="text" class="form-control" id="outputFilename" placeholder="avlist_output.html">
                </div>
            </div>
            <div class="col-md-6 text-md-end">
                <button class="btn btn-primary" id="btnGenerate" onclick="generate()">
                    <i class="bi bi-play-fill"></i> 產生網頁
                </button>
                <button class="btn btn-outline-secondary" id="btnCopyPath" onclick="copyOutputPath()"
                    style="display: none;">
                    <i class="bi bi-clipboard"></i> 複製路徑
                </button>
            </div>
        </div>
    </div>

    <!-- 進度區 -->
    <div class="progress-section" id="progressSection">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span id="progressStatus">準備中...</span>
            <span id="progressCount" class="badge bg-secondary">0 / 0</span>
        </div>
        <div class="progress" style="height: 6px;">
            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
        </div>
        <div class="log-output" id="logOutput"></div>
    </div>

    <!-- 結果區 -->
    <div class="alert alert-success mt-3" id="resultAlert" style="display: none;">
        <i class="bi bi-check-circle"></i>
        <span id="resultMessage"></span>
    </div>

    <!-- 統計資訊 -->
    <div class="card mt-3" id="statsCard" style="display: none;">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center text-muted small">
                <span>
                    <i class="bi bi-collection-play"></i> 快取影片: <strong id="statTotal">0</strong> 部
                    <span id="statNeedUpdate" style="display: none;">
                        | 需補全: <strong id="updateCount">0</strong> 部
                        <button class="btn btn-sm btn-outline-primary ms-1 py-0 px-1" onclick="runNfoUpdate()"
                            id="btnUpdate" title="補全 NFO 資訊">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </span>
                </span>
                <span id="statLastRun"></span>
            </div>
        </div>
    </div>
</div>

<!-- Toast 提示 -->
<div id="toastMsg" class="toast-msg"></div>
{% endblock %}

{% block extra_js %}
<script>
    let directories = [];
    let config = {};
    let configDirty = false;
    let isGenerating = false;  // 追蹤是否正在生成

    // localStorage keys
    const STORAGE_KEYS = {
        logs: 'avlist_logs',
        isGenerating: 'avlist_generating',
        lastStatus: 'avlist_last_status'
    };

    // 儲存 logs 到 localStorage
    function saveLogs() {
        const logOutput = document.getElementById('logOutput');
        localStorage.setItem(STORAGE_KEYS.logs, logOutput.innerHTML);
    }

    // 從 localStorage 恢復 logs
    function restoreLogs() {
        const savedLogs = localStorage.getItem(STORAGE_KEYS.logs);
        const wasGenerating = localStorage.getItem(STORAGE_KEYS.isGenerating) === 'true';

        if (savedLogs) {
            const logOutput = document.getElementById('logOutput');
            const progressSection = document.getElementById('progressSection');

            logOutput.innerHTML = savedLogs;
            progressSection.classList.add('show');

            // 如果之前正在生成但被中斷
            if (wasGenerating) {
                logOutput.innerHTML += '<div class="log-warn">⚠ 生成被中斷（離開頁面）</div>';
                localStorage.setItem(STORAGE_KEYS.isGenerating, 'false');
            }

            // 恢復狀態文字
            const lastStatus = localStorage.getItem(STORAGE_KEYS.lastStatus);
            if (lastStatus) {
                document.getElementById('progressStatus').textContent = lastStatus;
            }
        }
    }

    // 清除 logs
    function clearLogs() {
        localStorage.removeItem(STORAGE_KEYS.logs);
        localStorage.removeItem(STORAGE_KEYS.isGenerating);
        localStorage.removeItem(STORAGE_KEYS.lastStatus);
    }

    // 離開頁面警告
    window.addEventListener('beforeunload', function (e) {
        if (isGenerating) {
            e.preventDefault();
            e.returnValue = '生成正在進行中，離開將會中斷操作！';
            return e.returnValue;
        }
    });

    // 監聽側邊欄點擊（PyWebView 中 beforeunload 可能不觸發）
    document.addEventListener('click', function (e) {
        if (isGenerating) {
            const link = e.target.closest('a[href]');
            if (link && !link.href.includes('/avlist')) {
                if (!confirm('生成正在進行中，離開將會中斷操作！確定要離開嗎？')) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }
        }
    });

    // 載入設定
    async function loadConfig() {
        try {
            const resp = await fetch('/api/config');
            const result = await resp.json();
            if (result.success) {
                config = result.data;
                directories = config.avlist?.directories || [];
                document.getElementById('outputDir').value = config.avlist?.output_dir || 'output';
                document.getElementById('outputFilename').value = config.avlist?.output_filename || 'avlist_output.html';
                renderDirectories();
            }
        } catch (e) {
            console.error('載入設定失敗:', e);
        }
    }

    // 渲染資料夾列表
    function renderDirectories() {
        const list = document.getElementById('directoryList');
        const footer = document.getElementById('dirFooter');

        if (directories.length === 0) {
            list.innerHTML = `
            <div class="empty-list">
                <i class="bi bi-folder-plus fs-1 text-muted"></i>
                <p class="mt-2 mb-0">尚未加入任何資料夾</p>
                <small class="text-muted">點擊上方按鈕或拖曳資料夾至此</small>
            </div>
        `;
            footer.style.display = 'none';
            return;
        }

        footer.style.display = 'block';
        list.innerHTML = directories.map((dir, idx) => `
        <div class="directory-item">
            <i class="bi bi-folder text-warning"></i>
            <span class="path">${escapeHtml(dir)}</span>
            <button class="btn btn-outline-danger btn-remove" onclick="removeDirectory(${idx})" title="移除">
                <i class="bi bi-x"></i>
            </button>
        </div>
    `).join('');
    }

    // 選擇資料夾 (PyWebView)
    async function selectFolder() {
        console.log('[AVList] selectFolder called');

        if (typeof window.pywebview === 'undefined' || !window.pywebview.api) {
            console.log('[AVList] PyWebView not available');
            toggleManualInput();
            alert('此功能需要在桌面應用程式中使用');
            return;
        }

        try {
            console.log('[AVList] Calling select_folder...');
            // select_folder() 返回格式: { folder: "路徑", files: [...] }
            const result = await window.pywebview.api.select_folder();
            console.log('[AVList] select_folder result:', result);

            // 新格式：result 是物件 { folder, files }
            if (result && result.folder) {
                addFolderPath(result.folder);
            }
            // 舊格式兼容：result 是陣列
            else if (Array.isArray(result) && result.length > 0) {
                const firstFile = result[0];
                const lastSep = Math.max(firstFile.lastIndexOf('\\'), firstFile.lastIndexOf('/'));
                const folderPath = lastSep > 0 ? firstFile.substring(0, lastSep) : null;
                if (folderPath) {
                    addFolderPath(folderPath);
                }
            } else {
                console.log('[AVList] No folder selected');
            }
        } catch (e) {
            console.error('[AVList] 選取資料夾失敗:', e);
        }
    }

    // 加入資料夾路徑（避免重複）
    function addFolderPath(folderPath) {
        console.log('[AVList] addFolderPath called with:', folderPath);
        if (!directories.includes(folderPath)) {
            directories.push(folderPath);
            configDirty = true;
            renderDirectories();
            console.log('[AVList] Folder added successfully');
        } else {
            console.log('[AVList] Folder already in list');
            alert('此資料夾已在列表中');
        }
    }

    // 切換手動輸入區
    function toggleManualInput() {
        const el = document.getElementById('manualInput');
        el.style.display = el.style.display === 'none' ? 'flex' : 'none';
        if (el.style.display === 'flex') {
            document.getElementById('manualPath').focus();
        }
    }

    // 加入手動輸入的路徑
    function addManualPath() {
        const input = document.getElementById('manualPath');
        const path = input.value.trim();
        if (!path) return;

        if (directories.includes(path)) {
            alert('此資料夾已在列表中');
            return;
        }

        directories.push(path);
        configDirty = true;
        renderDirectories();
        input.value = '';
    }

    // Enter 鍵加入
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('manualPath')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addManualPath();
            }
        });
    });

    // 移除資料夾
    function removeDirectory(idx) {
        directories.splice(idx, 1);
        configDirty = true;
        renderDirectories();
    }

    // 儲存設定
    async function saveConfig() {
        try {
            config.avlist = config.avlist || {};
            config.avlist.directories = directories;
            config.avlist.output_dir = document.getElementById('outputDir').value || 'output';
            config.avlist.output_filename = document.getElementById('outputFilename').value || 'avlist_output.html';

            const resp = await fetch('/api/config', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
            const result = await resp.json();
            if (result.success) {
                configDirty = false;
                alert('設定已儲存');
            } else {
                alert('儲存失敗: ' + (result.error || '未知錯誤'));
            }
        } catch (e) {
            console.error('儲存失敗:', e);
            alert('儲存失敗: ' + e.message);
        }
    }

    // 產生網頁
    async function generate() {
        if (directories.length === 0) {
            alert('請先加入至少一個資料夾');
            return;
        }

        // 自動儲存設定
        if (configDirty) {
            await saveConfig();
        } else {
            // 確保 output 設定也儲存
            config.avlist = config.avlist || {};
            config.avlist.directories = directories;
            config.avlist.output_dir = document.getElementById('outputDir').value || 'output';
            config.avlist.output_filename = document.getElementById('outputFilename').value || 'avlist_output.html';
            await fetch('/api/config', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
        }

        const btn = document.getElementById('btnGenerate');
        const progressSection = document.getElementById('progressSection');
        const logOutput = document.getElementById('logOutput');
        const resultAlert = document.getElementById('resultAlert');
        const btnCopyPath = document.getElementById('btnCopyPath');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 產生中...';
        progressSection.classList.add('show');
        resultAlert.style.display = 'none';
        btnCopyPath.style.display = 'none';
        logOutput.innerHTML = '';

        // 設置生成狀態
        isGenerating = true;
        localStorage.setItem(STORAGE_KEYS.isGenerating, 'true');
        clearLogs();  // 清除舊 logs

        try {
            const eventSource = new EventSource('/api/avlist/generate');

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);

                if (data.type === 'progress') {
                    document.getElementById('progressStatus').textContent = data.status;
                    document.getElementById('progressCount').textContent = `${data.current} / ${data.total}`;
                    const pct = data.total > 0 ? (data.current / data.total) * 100 : 0;
                    document.getElementById('progressBar').style.width = `${pct}%`;
                    // 儲存狀態
                    localStorage.setItem(STORAGE_KEYS.lastStatus, data.status);
                } else if (data.type === 'log') {
                    const cls = data.level === 'error' ? 'log-error' :
                        data.level === 'warn' ? 'log-warn' : 'log-info';
                    logOutput.innerHTML += `<div class="${cls}">${escapeHtml(data.message)}</div>`;
                    logOutput.scrollTop = logOutput.scrollHeight;
                    // 每次 log 都儲存
                    saveLogs();
                } else if (data.type === 'done') {
                    eventSource.close();
                    isGenerating = false;
                    localStorage.setItem(STORAGE_KEYS.isGenerating, 'false');
                    // 清除 viewer 狀態，下次開啟會重新載入
                    localStorage.removeItem('avlist_state');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-play-fill"></i> 產生網頁';
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressStatus').textContent = '完成';
                    localStorage.setItem(STORAGE_KEYS.lastStatus, '完成');

                    resultAlert.style.display = 'block';
                    document.getElementById('resultMessage').textContent =
                        `成功產生 ${data.video_count} 部影片列表`;
                    btnCopyPath.style.display = 'inline-block';
                    btnCopyPath.dataset.path = data.output_path;

                    // 儲存最終 logs
                    saveLogs();

                    // 刷新統計資訊
                    loadStats();
                } else if (data.type === 'error') {
                    eventSource.close();
                    isGenerating = false;
                    localStorage.setItem(STORAGE_KEYS.isGenerating, 'false');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-play-fill"></i> 產生網頁';
                    logOutput.innerHTML += `<div class="log-error">錯誤: ${escapeHtml(data.message)}</div>`;
                    saveLogs();
                }
            };

            eventSource.onerror = function () {
                eventSource.close();
                isGenerating = false;
                localStorage.setItem(STORAGE_KEYS.isGenerating, 'false');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-play-fill"></i> 產生網頁';
                logOutput.innerHTML += '<div class="log-error">連線中斷</div>';
                saveLogs();
            };
        } catch (e) {
            isGenerating = false;
            localStorage.setItem(STORAGE_KEYS.isGenerating, 'false');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-fill"></i> 產生網頁';
            alert('發生錯誤: ' + e.message);
        }
    }

    // Toast 提示
    function showToast(msg) {
        const toast = document.getElementById('toastMsg');
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // 複製輸出路徑到剪貼簿
    function copyOutputPath() {
        const btn = document.getElementById('btnCopyPath');
        const path = btn.dataset.path;
        if (path) {
            navigator.clipboard.writeText(path).then(() => {
                showToast('已複製: ' + path);
            }).catch(() => {
                alert('複製失敗，路徑：' + path);
            });
        }
    }

    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    }

    // === 拖曳功能 ===
    const dragOverlay = document.getElementById('dragOverlay');
    let dragCounter = 0;

    // PyWebView 拖曳處理 - 接收資料夾路徑（由 standalone.py 呼叫）
    window.handleFolderDrop = function (folderPaths) {
        console.log('[AVList] handleFolderDrop called with:', folderPaths);

        if (!folderPaths || folderPaths.length === 0) {
            console.log('[AVList] handleFolderDrop: empty or null folderPaths');
            return;
        }

        let added = 0;
        for (const folderPath of folderPaths) {
            console.log('[AVList] Processing folder:', folderPath);
            if (!directories.includes(folderPath)) {
                directories.push(folderPath);
                added++;
                console.log('[AVList] Added folder:', folderPath);
            } else {
                console.log('[AVList] Folder already exists:', folderPath);
            }
        }

        if (added > 0) {
            configDirty = true;
            renderDirectories();
            console.log('[AVList] Rendered', added, 'new folders');
        }
    };

    // 拖曳進入
    document.addEventListener('dragenter', (e) => {
        e.preventDefault();
        dragCounter++;
        console.log('[AVList] dragenter, counter:', dragCounter);
        if (dragCounter === 1) {
            dragOverlay.classList.add('show');
        }
    });

    // 拖曳離開
    document.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dragCounter--;
        console.log('[AVList] dragleave, counter:', dragCounter);
        if (dragCounter === 0) {
            dragOverlay.classList.remove('show');
        }
    });

    // 拖曳經過
    document.addEventListener('dragover', (e) => {
        e.preventDefault();
    });

    // 放開
    document.addEventListener('drop', (e) => {
        e.preventDefault();
        dragCounter = 0;
        dragOverlay.classList.remove('show');
        console.log('[AVList] drop event fired');
        // PyWebView 會自動處理並呼叫 handleFolderDrop
    });

    // 載入統計資訊
    async function loadStats() {
        try {
            const resp = await fetch('/api/avlist/stats');
            const result = await resp.json();
            if (result.success && result.data) {
                const stats = result.data;
                const statsCard = document.getElementById('statsCard');
                const statTotal = document.getElementById('statTotal');
                const statLastRun = document.getElementById('statLastRun');

                if (stats.total > 0) {
                    statsCard.style.display = 'block';
                    statTotal.textContent = stats.total;

                    if (stats.last_run) {
                        const lastRun = new Date(stats.last_run);
                        const timeStr = lastRun.toLocaleString('zh-TW', {
                            month: 'numeric',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        let runInfo = `上次執行: ${timeStr}`;
                        if (stats.last_added !== null && stats.last_added !== undefined) {
                            runInfo += ` (新增 ${stats.last_added} 部)`;
                        }
                        statLastRun.textContent = runInfo;
                    }

                    // 檢查需要更新的數量
                    checkNeedUpdate();
                }
            }
        } catch (e) {
            console.error('載入統計失敗:', e);
        }
    }

    // 檢查需要更新的影片數量
    async function checkNeedUpdate() {
        try {
            const resp = await fetch('/api/avlist/update-check');
            const result = await resp.json();
            if (result.success && result.data && result.data.need_update > 0) {
                document.getElementById('updateCount').textContent = result.data.need_update;
                document.getElementById('statNeedUpdate').style.display = '';
            } else {
                document.getElementById('statNeedUpdate').style.display = 'none';
            }
        } catch (e) {
            console.error('檢查更新失敗:', e);
        }
    }

    // 執行 NFO 更新
    async function runNfoUpdate() {
        const btn = document.getElementById('btnUpdate');
        const progressSection = document.getElementById('progressSection');
        const logOutput = document.getElementById('logOutput');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" style="width:0.75rem;height:0.75rem"></span>';
        progressSection.classList.add('show');
        logOutput.innerHTML = '';

        // 設置生成狀態
        isGenerating = true;
        localStorage.setItem(STORAGE_KEYS.isGenerating, 'true');
        clearLogs();

        try {
            const eventSource = new EventSource('/api/avlist/update');

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);

                if (data.type === 'progress') {
                    document.getElementById('progressStatus').textContent = data.status;
                    document.getElementById('progressCount').textContent = `${data.current} / ${data.total}`;
                    const pct = data.total > 0 ? (data.current / data.total) * 100 : 0;
                    document.getElementById('progressBar').style.width = `${pct}%`;
                    localStorage.setItem(STORAGE_KEYS.lastStatus, data.status);
                } else if (data.type === 'log') {
                    const cls = data.level === 'error' ? 'log-error' :
                        data.level === 'warn' ? 'log-warn' : 'log-info';
                    logOutput.innerHTML += `<div class="${cls}">${escapeHtml(data.message)}</div>`;
                    logOutput.scrollTop = logOutput.scrollHeight;
                    saveLogs();
                } else if (data.type === 'done') {
                    eventSource.close();
                    isGenerating = false;
                    localStorage.setItem(STORAGE_KEYS.isGenerating, 'false');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressStatus').textContent = data.message || '完成';
                    localStorage.setItem(STORAGE_KEYS.lastStatus, data.message || '完成');

                    // 提示重新產生列表
                    if (data.message) {
                        logOutput.innerHTML += `<div class="log-info">${escapeHtml(data.message)}</div>`;
                    }
                    saveLogs();

                    // 重新檢查更新數量
                    checkNeedUpdate();
                } else if (data.type === 'error') {
                    eventSource.close();
                    isGenerating = false;
                    localStorage.setItem(STORAGE_KEYS.isGenerating, 'false');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
                    logOutput.innerHTML += `<div class="log-error">錯誤: ${escapeHtml(data.message)}</div>`;
                    saveLogs();
                }
            };

            eventSource.onerror = function () {
                eventSource.close();
                isGenerating = false;
                localStorage.setItem(STORAGE_KEYS.isGenerating, 'false');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
                logOutput.innerHTML += '<div class="log-error">連線中斷</div>';
                saveLogs();
            };
        } catch (e) {
            isGenerating = false;
            localStorage.setItem(STORAGE_KEYS.isGenerating, 'false');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
            alert('發生錯誤: ' + e.message);
        }
    }

    // 初始化
    renderDirectories();  // 先渲染空狀態
    loadConfig();
    loadStats();
    restoreLogs();  // 恢復上次的 logs
</script>
{% endblock %}