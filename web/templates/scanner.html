{% extends "base.html" %}

{% block title %}列表生成 - OpenAver{% endblock %}

{% block extra_css %}
<link href="/static/css/pages/scanner.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="avlist-container ds-gallery-composition" x-data="scannerPage()"
     @dragenter.document="handleDragEnter($event)"
     @dragleave.document="handleDragLeave($event)"
     @dragover.document.prevent
     @drop.document.prevent="handleDrop($event)">
    <!-- Drag Overlay (must be inside x-data scope) -->
    <div class="drag-overlay" id="dragOverlay" x-show="showDragOverlay" x-transition.opacity>
        <div class="drag-overlay-content">
            <i class="bi bi-folder-plus"></i>
            <p>放開以加入資料夾</p>
        </div>
    </div>
    <!-- Header -->
    <div class="avlist-header">
        <h4><i class="bi bi-list-ul"></i> 列表生成</h4>
        <div class="stats" id="headerStats"></div>
    </div>

    <!-- Main Card: Folder List -->
    <div class="avlist-card">
        <div class="avlist-card-header">
            <div class="title">
                <i class="bi bi-folder"></i> <span>掃描資料夾</span>
            </div>
            <div class="actions">
                <button class="btn-icon" @click="selectFolder()" title="選擇資料夾">
                    <i class="bi bi-folder-plus"></i>
                </button>
                <button class="btn-icon" @click="toggleManualInput()" title="手動輸入">
                    <i class="bi bi-keyboard"></i>
                </button>
            </div>
        </div>

        <div class="avlist-card-body">
            <!-- Manual Input (hidden by default) -->
            <div class="manual-input" x-show="manualInputVisible"
                style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-light);">
                <input type="text" class="input input-bordered input-sm" id="manualPath"
                       x-model="manualPath" placeholder="輸入資料夾路徑..."
                       @keypress.enter="addManualPath()">
                <button class="btn btn-sm btn-primary" @click="addManualPath()">
                    <i class="bi bi-plus"></i>
                </button>
            </div>

            <!-- Folder List -->
            <div class="folder-list">
                <!-- Empty State -->
                <div x-show="directories.length === 0" class="folder-empty">
                    <i class="bi bi-folder-plus"></i>
                    <p>尚未加入任何資料夾</p>
                    <p>點擊上方按鈕或拖曳資料夾至此</p>
                </div>

                <!-- Folder Items -->
                <template x-for="(dir, idx) in directories" :key="idx">
                    <div class="folder-item">
                        <i class="bi bi-folder folder-icon"></i>
                        <span class="folder-path" x-text="dir"></span>
                        <button class="btn btn-sm btn-outline btn-error btn-remove"
                                @click="removeDirectory(idx)" title="移除">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Output Info -->
        <div class="output-info">
            <div class="path">
                <i class="bi bi-file-earmark-code"></i>
                輸出: <code id="outputPathDisplay" x-text="outputPathDisplay"></code>
            </div>
            <a href="/settings" class="settings-link">
                <i class="bi bi-gear"></i> 設定
            </a>
        </div>

        <!-- Action Buttons -->
        <div class="action-section">
            <button class="btn-hero btn-hero-primary" id="btnGenerate"
                    @click="generate()"
                    x-bind:disabled="isBusy"
                    x-html="generateButtonText">
            </button>
            <!-- Done Actions (hidden until complete) -->
            <div id="doneActions" class="done-actions" x-show="doneActionsVisible">
                <button class="btn-hero btn-hero-secondary" id="btnCopyPath"
                        @click="copyOutputPath()" title="複製路徑">
                    <i class="bi bi-clipboard"></i> 複製路徑
                </button>
            </div>
        </div>
    </div>

    <!-- Mini Terminal (hidden by default) -->
    <div class="mini-terminal" id="progressSection" x-show="progressSectionVisible">
        <div class="mini-terminal-header">
            <span class="title" id="progressStatus" x-text="progressStatus"></span>
        </div>
        <div class="progress-mini">
            <div class="bar" id="progressBar" x-bind:style="{ width: progressPercent + '%' }"></div>
        </div>
        <div class="mini-terminal-body" id="logOutput"></div>
    </div>

    <!-- Stats Card -->
    <div class="stats-card" id="statsCard" x-show="statsVisible">
        <div class="stats-row">
            <div class="stat-item">
                <i class="bi bi-collection-play"></i>
                <span>快取影片: <span class="stat-value" id="statTotal" x-text="statTotal"></span> 部</span>
            </div>
            <div class="stat-item" id="statLastRun" x-text="statLastRun"></div>
        </div>
        <!-- NFO Update Section (separate row) -->
        <div class="nfo-update-row" id="statNeedUpdate" x-show="nfoUpdateVisible">
            <span class="nfo-badge">
                <i class="bi bi-exclamation-circle"></i>
                需補全: <strong id="updateCount" x-text="nfoNeedUpdateCount"></strong> 部
            </span>
            <button class="btn-nfo-update" @click="runNfoUpdate()" id="btnUpdate"
                    x-bind:disabled="nfoUpdateButtonDisabled"
                    x-html="nfoUpdateButtonText"
                    title="補全 NFO 資訊">
            </button>
        </div>
    </div>

    <!-- Actress Alias Management -->
    <div class="actress-alias-card" id="actressAliasCard">
        <div class="actress-alias-header">
            <div class="title">
                <i class="bi bi-person-badge"></i> <span>女優名稱管理</span>
            </div>
            <button class="btn-icon btn-collapse" onclick="toggleAliasCard()" title="展開/收起">
                <i class="bi bi-chevron-down" id="aliasCollapseIcon"></i>
            </button>
        </div>

        <div class="actress-alias-body" id="aliasCardBody" style="display: none;">
            <!-- Add New Alias Form -->
            <div class="alias-form">
                <div class="alias-form-row">
                    <div class="alias-input-group">
                        <label>舊名稱</label>
                        <input type="text" id="aliasOldName" placeholder="例：miru" oninput="previewAliasCount()">
                        <span class="alias-count" id="oldNameCount"></span>
                    </div>
                    <span class="alias-arrow"><i class="bi bi-arrow-right"></i></span>
                    <div class="alias-input-group">
                        <label>新名稱</label>
                        <input type="text" id="aliasNewName" placeholder="例：坂道みる" oninput="previewAliasCount()">
                        <span class="alias-count" id="newNameCount"></span>
                    </div>
                    <button class="btn-alias-add" onclick="addActressAlias()" id="btnAddAlias">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div class="alias-preview" id="aliasPreview"></div>
            </div>

            <!-- Alias List -->
            <div class="alias-list" id="aliasList">
                <div class="alias-list-loading">
                    <span class="loading loading-spinner loading-sm"></span> 載入中...
                </div>
            </div>

        </div>
    </div>

    <!-- Dirty Check Modal (must be inside x-data scope for @click) -->
    <dialog id="scannerDirtyCheckModal" class="modal fluent-modal">
        <div class="modal-box fluent-modal-box">
            <h3 class="fluent-modal-title">
                <i class="bi bi-exclamation-triangle"></i> 尚未儲存的變更
            </h3>
            <p class="fluent-modal-body">
                您有修改資料夾清單但未產生網頁，要如何處理？
            </p>
            <div class="modal-action fluent-modal-actions">
                <button type="button" class="btn btn-ghost" @click="dirtyCheckCancel()">
                    取消
                </button>
                <button type="button" class="btn btn-error" @click="dirtyCheckDiscard()">
                    放棄變更
                </button>
                <button type="button" class="btn btn-primary" @click="dirtyCheckSave()">
                    儲存並離開
                </button>
            </div>
        </div>
    </dialog>
</div>

<!-- Toast (outside x-data — showToast uses getElementById, no Alpine binding needed) -->
<div id="toastMsg" class="toast toast-bottom toast-center fluent-toast-container">
    <div class="alert fluent-toast alert-info" role="alert">
        <i class="bi bi-info-circle"></i>
        <span id="toastText"></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/pages/scanner/alias.js"></script>
<script>
function scannerPage() {
  return {
    // ===== Data State =====
    directories: [],
    config: {},
    configDirty: false,

    // ===== Folder Dirty Check =====
    folderSnapshot: null,
    pendingNavigationUrl: '',

    // ===== Drag-drop State =====
    dragCounter: 0,
    showDragOverlay: false,

    // ===== Stats State =====
    statsVisible: false,
    statTotal: 0,
    statLastRun: '',

    // ===== Manual Input State =====
    manualInputVisible: false,
    manualPath: '',

    // ===== T7b: State Machine =====
    state: 'idle',  // 'idle' | 'generating' | 'nfoUpdating' | 'done' | 'error'

    // ===== T7b: Progress =====
    progressStatus: '準備中...',
    progressCurrent: 0,
    progressTotal: 0,

    // ===== T7b: Log System =====
    logHtml: '',           // 日誌 HTML（用於 restoreLogs）
    logBatch: [],          // 批次佇列
    logTimer: null,        // 批次計時器

    // ===== T7b: Done Actions =====
    outputPath: '',        // 輸出路徑（供複製）

    // ===== T7b: NFO Update =====
    nfoNeedUpdateCount: 0,
    nfoUpdatePaths: [],
    nfoUpdateVisible: false,

    // ===== T7b: EventSource 管理 =====
    eventSource: null,

    // ===== Computed Properties =====
    get isFolderDirty() {
        if (!this.folderSnapshot) return false;
        return JSON.stringify(this.directories) !== this.folderSnapshot;
    },

    get outputPathDisplay() {
        const outputDir = this.config.gallery?.output_dir || 'output';
        const outputFilename = this.config.gallery?.output_filename || 'gallery_output.html';
        return `${outputDir}/${outputFilename}`;
    },

    // ===== T7b: Computed Properties =====
    get progressPercent() {
        if (this.progressTotal === 0) return 0;
        return (this.progressCurrent / this.progressTotal) * 100;
    },

    get isGenerating() {
        return this.state === 'generating' || this.state === 'nfoUpdating';
    },

    get isBusy() {
        // 用於按鈕 disabled：generating/nfoUpdating 時鎖定
        return this.isGenerating;
    },

    get progressSectionVisible() {
        // state 非 idle 時顯示，或有恢復的 logs 時也顯示
        return this.state !== 'idle' || this.logHtml !== '';
    },

    get doneActionsVisible() {
        return this.state === 'done' && this.outputPath !== '';
    },

    get generateButtonText() {
        if (this.state === 'generating') {
            return '<span class="loading loading-spinner loading-sm"></span> 產生中...';
        }
        return '<i class="bi bi-play-fill"></i> 產生網頁';
    },

    get nfoUpdateButtonText() {
        if (this.state === 'nfoUpdating') {
            return '<span class="loading loading-spinner loading-sm"></span> 補全中...';
        }
        if (this.nfoNeedUpdateCount > 0) {
            return `<i class="bi bi-magic"></i> 補全 NFO`;
        }
        return '<i class="bi bi-check-lg"></i> 已完成';
    },

    get nfoUpdateButtonDisabled() {
        // generating/nfoUpdating 時鎖定；idle/done/error 時看 nfoNeedUpdateCount
        return this.isGenerating || this.nfoNeedUpdateCount === 0;
    },

    // ===== Lifecycle =====
    async init() {
        // 覆蓋全域函數為 Alpine 版本
        const self = this;
        window.renderDirectories = () => {};
        window.loadConfig = () => self.loadConfig();
        window.loadStats = () => self.loadStats();
        window.saveConfig = () => self.saveConfig();

        // 暴露 PyWebView 回調
        window.addScannerFolder = (path) => self.addFolderPath(path);

        // T7b: 暴露全域函數給 alias.js（T7c 遷移前過渡期）
        window.showToast = (msg) => self.showToast(msg);
        window.escapeHtml = (str) => self.escapeHtml ? self.escapeHtml(str) : str;

        // 初始載入
        await this.loadConfig();
        this.loadStats();

        // T7b: 恢復日誌（確保 DOM 已渲染）
        await this.$nextTick();
        this.restoreLogs();

        // 暴露全域檢查函式
        window.confirmLeavingScanner = (targetUrl) => {
            const guard = this.shouldWarnBeforeLeave();
            if (guard.shouldWarn) {
                if (guard.useModal) {
                    this.pendingNavigationUrl = targetUrl;
                    document.getElementById('scannerDirtyCheckModal').showModal();
                    return false;
                } else {
                    return confirm(guard.message + '確定要離開嗎？');
                }
            }
            return true;
        };

        // beforeunload 警告
        window.addEventListener('beforeunload', (e) => {
            const guard = this.shouldWarnBeforeLeave();
            if (guard.shouldWarn) {
                e.preventDefault();
                e.returnValue = guard.message;
                return e.returnValue;
            }
        });
    },

    // ===== Leave Guard =====
    shouldWarnBeforeLeave() {
        // T7b: 改為讀取 Alpine state，而非全域變數
        if (this.isGenerating) {
            return {
                shouldWarn: true,
                message: '生成正在進行中，離開將會中斷操作！',
                useModal: false
            };
        }
        if (this.isFolderDirty) {
            return {
                shouldWarn: true,
                message: '您有未儲存的資料夾變更',
                useModal: true
            };
        }
        return { shouldWarn: false };
    },

    // ===== Config Methods =====
    async loadConfig() {
        this.folderSnapshot = null;

        try {
            const resp = await fetch('/api/config');
            const result = await resp.json();
            if (result.success) {
                this.config = result.data;
                this.directories = this.config.gallery?.directories || [];

                // T7b: 不再需要同步全域變數（core.js 已刪除）

                // 建立快照
                this.folderSnapshot = JSON.stringify(this.directories);
            }
        } catch (e) {
            console.error('載入設定失敗:', e);
        }
    },

    async saveConfig() {
        try {
            this.config.gallery = this.config.gallery || {};
            this.config.gallery.directories = this.directories;

            const resp = await fetch('/api/config', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.config)
            });
            const result = await resp.json();
            if (result.success) {
                this.configDirty = false;
                this.folderSnapshot = JSON.stringify(this.directories);
                this.showToast('設定已儲存');
            } else {
                this.showToast('儲存失敗: ' + (result.error || '未知錯誤'));
            }
        } catch (e) {
            console.error('儲存失敗:', e);
            this.showToast('儲存失敗: ' + e.message);
        }
    },

    // ===== Stats Methods =====
    async loadStats() {
        try {
            const resp = await fetch('/api/gallery/stats');
            const result = await resp.json();
            if (result.success && result.data) {
                const stats = result.data;
                if (stats.total > 0) {
                    this.statsVisible = true;
                    this.statTotal = stats.total;

                    if (stats.last_run) {
                        const lastRun = new Date(stats.last_run);
                        const timeStr = lastRun.toLocaleString('zh-TW', {
                            month: 'numeric',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        let runInfo = `上次執行: ${timeStr}`;
                        if (stats.last_added !== null && stats.last_added !== undefined) {
                            runInfo += ` (新增 ${stats.last_added} 部)`;
                        }
                        this.statLastRun = runInfo;
                    }
                }
            }
        } catch (e) {
            console.error('載入統計失敗:', e);
        }
    },

    // ===== Folder Management =====
    async selectFolder() {
        console.log('[AVList] selectFolder called');

        if (typeof window.pywebview === 'undefined' || !window.pywebview.api) {
            console.log('[AVList] PyWebView not available');
            this.toggleManualInput();
            alert('此功能需要在桌面應用程式中使用');
            return;
        }

        try {
            console.log('[AVList] Calling select_folder...');
            const result = await window.pywebview.api.select_folder();
            console.log('[AVList] select_folder result:', result);

            if (result && result.folder) {
                this.addFolderPath(result.folder);
            } else if (Array.isArray(result) && result.length > 0) {
                const firstFile = result[0];
                const lastSep = Math.max(firstFile.lastIndexOf('\\'), firstFile.lastIndexOf('/'));
                const folderPath = lastSep > 0 ? firstFile.substring(0, lastSep) : null;
                if (folderPath) {
                    this.addFolderPath(folderPath);
                }
            } else {
                console.log('[AVList] No folder selected');
            }
        } catch (e) {
            console.error('[AVList] 選取資料夾失敗:', e);
        }
    },

    addFolderPath(folderPath) {
        console.log('[AVList] addFolderPath called with:', folderPath);
        if (!this.directories.includes(folderPath)) {
            this.directories.push(folderPath);
            this.configDirty = true;
            console.log('[AVList] Folder added successfully');
        } else {
            console.log('[AVList] Folder already in list');
            alert('此資料夾已在列表中');
        }
    },

    toggleManualInput() {
        this.manualInputVisible = !this.manualInputVisible;
        if (this.manualInputVisible) {
            this.$nextTick(() => {
                document.getElementById('manualPath').focus();
            });
        }
    },

    addManualPath() {
        const path = this.manualPath.trim();
        if (!path) return;

        if (this.directories.includes(path)) {
            alert('此資料夾已在列表中');
            return;
        }

        this.directories.push(path);
        this.configDirty = true;
        this.manualPath = '';
    },

    removeDirectory(idx) {
        this.directories.splice(idx, 1);
        this.configDirty = true;
    },

    // ===== Drag-drop Methods =====
    handleDragEnter(e) {
        e.preventDefault();
        this.dragCounter++;
        console.log('[AVList] dragenter, counter:', this.dragCounter);
        if (this.dragCounter === 1) {
            this.showDragOverlay = true;
        }
    },

    handleDragLeave(e) {
        e.preventDefault();
        this.dragCounter--;
        console.log('[AVList] dragleave, counter:', this.dragCounter);
        if (this.dragCounter === 0) {
            this.showDragOverlay = false;
        }
    },

    handleDrop(e) {
        e.preventDefault();
        this.dragCounter = 0;
        this.showDragOverlay = false;
        console.log('[AVList] drop event fired');
    },

    // ===== Dirty Check Modal Actions =====
    dirtyCheckCancel() {
        document.getElementById('scannerDirtyCheckModal').close();
        this.pendingNavigationUrl = '';
    },

    async dirtyCheckDiscard() {
        await this.loadConfig();
        document.getElementById('scannerDirtyCheckModal').close();
        if (this.pendingNavigationUrl) {
            window.location.href = this.pendingNavigationUrl;
        }
    },

    async dirtyCheckSave() {
        await this.saveConfig();
        document.getElementById('scannerDirtyCheckModal').close();
        if (this.pendingNavigationUrl) {
            window.location.href = this.pendingNavigationUrl;
        }
    },

    // ===== Utility Methods =====
    showToast(msg) {
        const toast = document.getElementById('toastMsg');
        const text  = document.getElementById('toastText');
        text.textContent = msg;

        toast.classList.remove('toast-hiding');
        toast.classList.add('toast-active');

        clearTimeout(this._toastTimer);
        this._toastTimer = setTimeout(() => {
            toast.classList.add('toast-hiding');
            toast.addEventListener('transitionend', function onEnd() {
                toast.removeEventListener('transitionend', onEnd);
                toast.classList.remove('toast-active', 'toast-hiding');
            }, { once: true });
        }, 2500);
    },

    escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    },

    // ===== T7b: Log System =====
    addLog(level, message) {
        const cls = level === 'error' ? 'log-error' :
                    level === 'warn' ? 'log-warn' : 'log-info';
        const escaped = this.escapeHtml(message);
        this.logBatch.push(`<div class="${cls}">${escaped}</div>`);

        if (!this.logTimer) {
            this.logTimer = setTimeout(() => this.flushLogs(), 100);
        }
    },

    flushLogs() {
        if (this.logBatch.length === 0) {
            this.logTimer = null;
            return;
        }

        const logOutput = document.getElementById('logOutput');
        logOutput.insertAdjacentHTML('beforeend', this.logBatch.join(''));
        logOutput.scrollTop = logOutput.scrollHeight;

        // 更新 Alpine state（供 restoreLogs 使用）
        this.logHtml = logOutput.innerHTML;

        // 儲存到 localStorage
        localStorage.setItem('avlist_logs', this.logHtml);

        this.logBatch = [];
        this.logTimer = null;
    },

    restoreLogs() {
        const savedLogs = localStorage.getItem('avlist_logs');
        const wasGenerating = localStorage.getItem('avlist_generating') === 'true';

        if (savedLogs) {
            const logOutput = document.getElementById('logOutput');
            logOutput.innerHTML = savedLogs;
            this.logHtml = savedLogs;

            if (wasGenerating) {
                this.addLog('warn', '⚠ 生成被中斷（離開頁面）');
                this.flushLogs();
                localStorage.setItem('avlist_generating', 'false');
            }

            const lastStatus = localStorage.getItem('avlist_last_status');
            if (lastStatus) {
                this.progressStatus = lastStatus;
            }

            // 如果有未完成的任務，顯示 progress section
            if (wasGenerating || savedLogs) {
                this.state = 'idle';  // 重置狀態為 idle（已中斷）
            }
        }
    },

    clearLogs() {
        localStorage.removeItem('avlist_logs');
        localStorage.removeItem('avlist_generating');
        localStorage.removeItem('avlist_last_status');
        this.logHtml = '';
        const logOutput = document.getElementById('logOutput');
        if (logOutput) logOutput.innerHTML = '';
    },

    // ===== T7b: Generate Flow =====
    async generate() {
        // 互斥鎖定：generating/nfoUpdating 時不可再次執行
        if (this.isGenerating) return;

        if (this.directories.length === 0) {
            this.showToast('請先加入至少一個資料夾');
            return;
        }

        // 自動儲存設定
        if (this.configDirty) {
            await this.saveConfig();
        }

        // 重置狀態
        this.state = 'generating';
        this.progressStatus = '準備中...';
        this.progressCurrent = 0;
        this.progressTotal = 0;
        this.outputPath = '';
        this.nfoUpdateVisible = false;
        this.clearLogs();

        // 設置 localStorage 標記
        localStorage.setItem('avlist_generating', 'true');

        // 同步全域變數（過渡期）
        window.isGenerating = true;

        try {
            this.eventSource = new EventSource('/api/gallery/generate');

            this.eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'progress') {
                    this.progressStatus = data.status;
                    this.progressCurrent = data.current;
                    this.progressTotal = data.total;
                    localStorage.setItem('avlist_last_status', data.status);
                } else if (data.type === 'log') {
                    this.addLog(data.level, data.message);
                } else if (data.type === 'done') {
                    this.eventSource.close();
                    this.eventSource = null;
                    this.state = 'done';
                    this.progressStatus = `完成！${data.video_count} 部影片`;
                    this.progressCurrent = this.progressTotal;
                    this.outputPath = data.output_path;

                    localStorage.setItem('avlist_generating', 'false');
                    localStorage.setItem('avlist_last_status', '完成');
                    localStorage.removeItem('avlist_state');  // 清除 viewer 狀態

                    window.isGenerating = false;

                    // 處理 NFO 更新提示
                    if (data.session_update && data.session_update.count > 0) {
                        this.nfoNeedUpdateCount = data.session_update.count;
                        this.nfoUpdatePaths = data.session_update.paths;
                        this.nfoUpdateVisible = true;
                    } else {
                        this.nfoNeedUpdateCount = 0;
                        this.nfoUpdatePaths = [];
                        this.nfoUpdateVisible = false;
                    }

                    this.showToast(`成功產生 ${data.video_count} 部影片列表`);
                    this.flushLogs();

                    // 刷新統計（不含 NFO 檢查）
                    this.loadStats();

                    // 更新資料夾快照（generate 成功視為儲存）
                    this.folderSnapshot = JSON.stringify(this.directories);
                } else if (data.type === 'error') {
                    this.eventSource.close();
                    this.eventSource = null;
                    this.state = 'error';
                    this.addLog('error', '錯誤: ' + data.message);
                    this.flushLogs();
                    localStorage.setItem('avlist_generating', 'false');
                    window.isGenerating = false;
                }
            };

            this.eventSource.onerror = () => {
                this.eventSource.close();
                this.eventSource = null;
                this.state = 'error';
                this.addLog('error', '連線中斷');
                this.flushLogs();
                localStorage.setItem('avlist_generating', 'false');
                window.isGenerating = false;
            };
        } catch (e) {
            this.state = 'error';
            localStorage.setItem('avlist_generating', 'false');
            window.isGenerating = false;
            alert('發生錯誤: ' + e.message);
        }
    },

    // ===== T7b: NFO Update Flow =====
    async runNfoUpdate() {
        // 互斥鎖定
        if (this.isGenerating) return;

        if (this.nfoNeedUpdateCount === 0) {
            this.showToast('沒有需要更新的影片');
            return;
        }

        // 重置狀態
        this.state = 'nfoUpdating';
        this.progressStatus = '準備中...';
        this.progressCurrent = 0;
        this.progressTotal = 0;
        this.clearLogs();

        localStorage.setItem('avlist_generating', 'true');
        window.isGenerating = true;

        try {
            this.eventSource = new EventSource('/api/gallery/update');

            this.eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'progress') {
                    this.progressStatus = data.status;
                    this.progressCurrent = data.current;
                    this.progressTotal = data.total;
                    localStorage.setItem('avlist_last_status', data.status);
                } else if (data.type === 'log') {
                    this.addLog(data.level, data.message);
                } else if (data.type === 'done') {
                    this.eventSource.close();
                    this.eventSource = null;
                    this.state = 'done';
                    this.progressStatus = data.message || '完成';
                    this.progressCurrent = this.progressTotal;

                    localStorage.setItem('avlist_generating', 'false');
                    localStorage.setItem('avlist_last_status', data.message || '完成');
                    window.isGenerating = false;

                    this.showToast('補全完成！請重新產生列表以更新');
                    if (data.message) {
                        this.addLog('info', data.message);
                    }
                    this.flushLogs();

                    // 隱藏 NFO 更新按鈕（已完成）
                    this.nfoNeedUpdateCount = 0;
                    this.nfoUpdateVisible = false;
                } else if (data.type === 'error') {
                    this.eventSource.close();
                    this.eventSource = null;
                    this.state = 'error';
                    this.addLog('error', '錯誤: ' + data.message);
                    this.flushLogs();
                    localStorage.setItem('avlist_generating', 'false');
                    window.isGenerating = false;
                }
            };

            this.eventSource.onerror = () => {
                this.eventSource.close();
                this.eventSource = null;
                this.state = 'error';
                this.addLog('error', '連線中斷');
                this.flushLogs();
                localStorage.setItem('avlist_generating', 'false');
                window.isGenerating = false;
            };
        } catch (e) {
            this.state = 'error';
            localStorage.setItem('avlist_generating', 'false');
            window.isGenerating = false;
            alert('發生錯誤: ' + e.message);
        }
    },

    // ===== T7b: Utility =====
    copyOutputPath() {
        if (!this.outputPath) return;

        navigator.clipboard.writeText(this.outputPath).then(() => {
            this.showToast('已複製: ' + this.outputPath);
        }).catch(() => {
            alert('複製失敗，路徑：' + this.outputPath);
        });
    },

  };
}

// PyWebView 拖曳處理
window.handleFolderDrop = function (folderPaths) {
    console.log('[AVList] handleFolderDrop called with:', folderPaths);

    if (!folderPaths || folderPaths.length === 0) {
        console.log('[AVList] handleFolderDrop: empty or null folderPaths');
        return;
    }

    if (typeof window.addScannerFolder !== 'function') {
        console.error('[AVList] Alpine not ready, addScannerFolder not available');
        return;
    }

    for (const folderPath of folderPaths) {
        console.log('[AVList] Processing folder:', folderPath);
        window.addScannerFolder(folderPath);
    }
};
</script>
{% endblock %}