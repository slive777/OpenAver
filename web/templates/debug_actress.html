<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - å¥³å„ªçˆ¬èŸ²</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            padding-top: 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #6c63ff;
            color: #fff;
            box-shadow: 0 0 0 0.25rem rgba(108, 99, 255, 0.25);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6c63ff, #4834d4);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #7f78ff, #5a4ee0);
        }

        pre {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            color: #a8e6cf;
            max-height: 400px;
            overflow: auto;
            white-space: pre-wrap;
        }

        .avatar-preview {
            max-width: 200px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .loading {
            display: none;
        }

        .loading.show {
            display: inline-block;
        }

        .error-text {
            color: #ff6b6b;
        }

        .success-text {
            color: #51cf66;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mb-4">ğŸ”§ Debug - å¥³å„ªçˆ¬èŸ²</h1>

        <!-- æœå°‹è¡¨å–® -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">æœå°‹å¥³å„ª</h5>
            </div>
            <div class="card-body">
                <form id="searchForm" class="d-flex gap-2">
                    <input type="text" id="actressName" class="form-control" placeholder="è¼¸å…¥å¥³å„ªåå­—ï¼ˆå¦‚ï¼šä¸‰ä¸Šæ‚ äºœï¼‰" required>
                    <button type="submit" class="btn btn-primary" id="searchBtn">
                        <span class="loading spinner-border spinner-border-sm me-1"></span>
                        æœå°‹
                    </button>
                </form>
            </div>
        </div>

        <!-- çµæœå€åŸŸ -->
        <div class="row">
            <!-- åœ–ç‰‡é è¦½ -->
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“· é ­åƒ</h5>
                    </div>
                    <div class="card-body text-center" id="imagePreview">
                        <p class="text-muted">æœå°‹å¾Œé¡¯ç¤ºé ­åƒ</p>
                    </div>
                </div>
            </div>

            <!-- JSON çµæœ -->
            <div class="col-md-8 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ğŸ“‹ JSON çµæœ</h5>
                        <span id="statusBadge"></span>
                    </div>
                    <div class="card-body">
                        <pre id="jsonResult">ç­‰å¾…æœå°‹...</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ¸¬è©¦ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">âš¡ å¿«é€Ÿæ¸¬è©¦</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-light btn-sm quick-test" data-name="ä¸‰ä¸Šæ‚ äºœ">ä¸‰ä¸Šæ‚ äºœ</button>
                    <button class="btn btn-outline-light btn-sm quick-test" data-name="æ²³åŒ—å½©èŠ±">æ²³åŒ—å½©èŠ±</button>
                    <button class="btn btn-outline-light btn-sm quick-test" data-name="æ¡œç©ºã‚‚ã‚‚">æ¡œç©ºã‚‚ã‚‚</button>
                    <button class="btn btn-outline-light btn-sm quick-test" data-name="ä¸å­˜åœ¨çš„åå­—">âŒ ä¸å­˜åœ¨çš„åå­—</button>
                </div>
            </div>
        </div>

        <!-- Gallery é è¦½ -->
        <div class="card mt-4" id="galleryCard" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ğŸ–¼ï¸ Gallery é è¦½</h5>
                <span id="galleryStatus" class="text-muted"></span>
            </div>
            <div class="card-body p-0">
                <iframe id="galleryPreview"
                    style="width:100%; height:600px; border:none; border-radius: 0 0 12px 12px;"></iframe>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('searchForm');
        const input = document.getElementById('actressName');
        const searchBtn = document.getElementById('searchBtn');
        const loading = searchBtn.querySelector('.loading');
        const jsonResult = document.getElementById('jsonResult');
        const imagePreview = document.getElementById('imagePreview');
        const statusBadge = document.getElementById('statusBadge');

        // æœå°‹å‡½æ•¸
        async function search(name) {
            // é¡¯ç¤º loading
            loading.classList.add('show');
            searchBtn.disabled = true;
            jsonResult.textContent = 'æœå°‹ä¸­...';
            imagePreview.innerHTML = '<p class="text-muted">è¼‰å…¥ä¸­...</p>';
            statusBadge.innerHTML = '';

            try {
                const response = await fetch('/api/debug/scrape-actress', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: name }),
                });

                const result = await response.json();

                // é¡¯ç¤º JSON
                jsonResult.textContent = JSON.stringify(result, null, 2);

                if (result.success) {
                    // æˆåŠŸ
                    statusBadge.innerHTML = '<span class="badge bg-success">æˆåŠŸ</span>';

                    // é¡¯ç¤ºé ­åƒ
                    if (result.data && result.data.img) {
                        // ä½¿ç”¨åœ–ç‰‡ä»£ç†è§£æ±ºé˜²ç›œéˆå•é¡Œ
                        const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(result.data.img)}`;
                        imagePreview.innerHTML = `
                            <img src="${proxyUrl}" 
                                 alt="${result.data.name}" 
                                 class="avatar-preview"
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22280%22><rect fill=%22%23333%22 width=%22200%22 height=%22280%22/><text fill=%22%23999%22 font-size=%2214%22 x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22>åœ–ç‰‡è¼‰å…¥å¤±æ•—</text></svg>'">
                            <p class="mt-2 mb-0">${result.data.name || 'æœªçŸ¥'}</p>
                        `;
                    } else {
                        imagePreview.innerHTML = '<p class="text-muted">ç„¡é ­åƒ</p>';
                    }

                    // è‡ªå‹•è¼‰å…¥ Gallery é è¦½
                    loadGallery(name);
                } else {
                    // å¤±æ•—
                    statusBadge.innerHTML = '<span class="badge bg-danger">å¤±æ•—</span>';
                    imagePreview.innerHTML = `<p class="error-text">${result.error || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
                    hideGallery();
                }
            } catch (error) {
                jsonResult.textContent = JSON.stringify({ error: error.message }, null, 2);
                statusBadge.innerHTML = '<span class="badge bg-danger">éŒ¯èª¤</span>';
                imagePreview.innerHTML = `<p class="error-text">${error.message}</p>`;
                hideGallery();
            } finally {
                loading.classList.remove('show');
                searchBtn.disabled = false;
            }
        }

        // Gallery é è¦½ç›¸é—œ
        const galleryCard = document.getElementById('galleryCard');
        const galleryPreview = document.getElementById('galleryPreview');
        const galleryStatus = document.getElementById('galleryStatus');

        async function loadGallery(query) {
            galleryCard.style.display = 'block';
            galleryStatus.textContent = 'è¼‰å…¥ä¸­...';
            galleryPreview.src = 'about:blank';

            try {
                const response = await fetch('/api/debug/search-gallery', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, theme: 'dark' }),
                });

                const result = await response.json();

                if (result.success && result.url) {
                    galleryPreview.src = result.url;
                    galleryStatus.textContent = 'è¼‰å…¥å®Œæˆ';
                } else {
                    galleryStatus.textContent = result.error || 'è¼‰å…¥å¤±æ•—';
                }
            } catch (error) {
                galleryStatus.textContent = 'è¼‰å…¥å¤±æ•—: ' + error.message;
            }
        }

        function hideGallery() {
            galleryCard.style.display = 'none';
        }

        // ç›£è½ postMessage
        window.addEventListener('message', function (event) {
            if (event.data && event.data.type === 'video_click') {
                console.log('Video clicked:', event.data.path);
                // å¯ä»¥åœ¨é€™è£¡è™•ç†é»æ“Šäº‹ä»¶
            }
        });

        // è¡¨å–®æäº¤
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = input.value.trim();
            if (name) {
                search(name);
            }
        });

        // å¿«é€Ÿæ¸¬è©¦æŒ‰éˆ•
        document.querySelectorAll('.quick-test').forEach(btn => {
            btn.addEventListener('click', () => {
                const name = btn.dataset.name;
                input.value = name;
                search(name);
            });
        });
    </script>
</body>

</html>