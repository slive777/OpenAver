{% extends "base.html" %}

{% block title %}設定 - OpenAver{% endblock %}

{% block extra_css %}
<style>
    .settings-container {
        max-width: 900px;
        margin: 0 auto;
    }

    /* 轉動動畫 */
    .spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .settings-header {
        margin-bottom: 1.5rem;
    }

    .settings-header h4 {
        margin: 0;
        color: var(--text-primary);
    }

    /* Modern Card Styling */
    .card {
        border: none;
        border-radius: 16px;
        box-shadow: var(--shadow-sm);
        /* overflow: hidden 會導致下拉選單被截斷，改用 visible */
        overflow: visible;
    }

    .card-header {
        background: transparent;
        border-bottom: 1px solid var(--border-light);
        font-weight: 600;
        padding: 1rem 1.25rem;
    }

    .card-header i {
        color: var(--accent);
        margin-right: 0.5rem;
    }

    .card-body {
        padding: 1.25rem;
    }

    /* Form Row Styling */
    .row.mb-3 .col-md-6:first-child {
        display: flex;
        align-items: center;
    }

    .form-label {
        margin-bottom: 0;
        font-size: 0.875rem;
    }

    /* Divider */
    hr {
        border-color: var(--border-light);
        opacity: 0.5;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    /* Collapse Toggle Link */
    .collapse-toggle {
        color: var(--text-secondary);
        font-size: 0.875rem;
        cursor: pointer;
    }

    .collapse-toggle:hover {
        color: var(--accent);
    }

    .collapse-toggle i {
        transition: transform 0.2s;
    }

    .collapse-toggle[aria-expanded="true"] i {
        transform: rotate(180deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h4 class="mb-4">
        <i class="bi bi-gear"></i> 設定
    </h4>

    <form id="settingsForm">
        <!-- 1. 搜尋與刮削設定 (Search & Scraper) -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-search"></i> 搜尋與刮削
            </div>
            <div class="card-body">

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="galleryModeEnabled"
                                data-section="search" data-key="gallery_mode_enabled">
                            <label class="form-check-label" for="galleryModeEnabled">
                                女優畫廊模式 <span class="badge bg-danger">Beta</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="uncensoredModeEnabled"
                                data-section="search" data-key="uncensored_mode_enabled">
                            <label class="form-check-label" for="uncensoredModeEnabled">
                                無碼模式
                            </label>
                        </div>
                        <small class="text-muted">啟用時只搜尋 AVSOX / FC2，適合無碼作品</small>
                    </div>
                </div>

                <!-- 我的最愛資料夾 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">我的最愛資料夾</label>
                        <small class="text-muted d-block">一鍵載入常用資料夾</small>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control form-control-sm" id="searchFavoriteFolder"
                            placeholder="留空 = 系統下載資料夾">
                        <small class="text-muted">範例：C:\Users\&lt;你的使用者名稱&gt;\下載</small>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="translateEnabled">
                            <label class="form-check-label" for="translateEnabled">啟用標題翻譯</label>
                        </div>
                    </div>
                </div>

                <!-- 翻譯選項 (動態顯示) -->
                <div id="translateOptions">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">翻譯服務</label>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select form-select-sm" id="translateProvider">
                                <option value="ollama">Ollama（本地）</option>
                                <option value="gemini">Gemini（Google 雲端）</option>
                            </select>
                        </div>
                    </div>

                    <!-- Ollama 設定 -->
                    <div id="ollamaFields">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Ollama URL</label>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="ollamaUrl"
                                        value="http://localhost:11434">
                                    <button class="btn btn-outline-secondary" type="button" id="testOllamaBtn">
                                        <i class="bi bi-plug"></i> 測試
                                    </button>
                                </div>
                                <small class="text-muted" id="ollamaStatus"></small>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">模型</label>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <select class="form-select form-select-sm" id="ollamaModel">
                                        <option value="">-- 請先測試連線 --</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" id="testModelBtn"
                                        title="測試模型">
                                        <i class="bi bi-chat-dots"></i> 測試
                                    </button>
                                </div>
                                <small class="text-muted" id="modelStatus"></small>
                            </div>
                        </div>
                    </div>

                    <!-- Gemini 設定 (初始隱藏) -->
                    <div id="geminiFields" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">API Key</label>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <input type="password" class="form-control" id="geminiApiKey" placeholder="AIza...">
                                    <button class="btn btn-outline-secondary" type="button" id="testGeminiBtn">
                                        <i class="bi bi-plug"></i> 測試
                                    </button>
                                </div>
                                <small class="text-muted" id="geminiStatus"></small>
                                <small class="form-text text-muted d-block mt-1">
                                    <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a>
                                    可免費申請
                                </small>

                                <!-- 安全警告 -->
                                <div class="alert alert-warning mt-2 py-2" role="alert" style="font-size: 0.8rem;">
                                    <strong>⚠️ 安全提示：</strong>
                                    <ul class="mb-0 ps-3">
                                        <li>API Key 將以明文存儲在 config.json</li>
                                        <li>請勿將 config.json 分享給他人</li>
                                        <li>如需撤銷，請前往 <a href="https://aistudio.google.com/apikey" target="_blank">Google
                                                AI Studio</a> 重新生成</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">模型</label>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <select class="form-select form-select-sm" id="geminiModel" disabled>
                                        <option value="">-- 請先測試 API Key --</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" id="testGeminiTranslateBtn"
                                        title="測試翻譯功能" disabled>
                                        <i class="bi bi-chat-dots"></i> 測試
                                    </button>
                                </div>
                                <small class="text-muted" id="geminiModelStatus"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 進階刮削設定 (Collapsed) -->
                <hr class="my-3">
                <div class="mb-2">
                    <a class="collapse-toggle text-decoration-none" data-bs-toggle="collapse" href="#scraperAdvanced"
                        role="button" aria-expanded="false">
                        <i class="bi bi-chevron-down"></i> 進階刮削設定
                    </a>
                </div>
                <div class="collapse" id="scraperAdvanced">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="createFolder" checked
                                    onchange="updateFolderLayers()">
                                <label class="form-check-label" for="createFolder">建立資料夾</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- 第一行：外層 / 中層 -->
                            <div class="d-flex align-items-center gap-1 mb-2">
                                <div class="input-group input-group-sm" style="flex: 1;">
                                    <input type="text" class="form-control" id="folderLayer1" placeholder="外層"
                                        oninput="updateFolderLayers()" disabled>
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                        id="folderLayer1Btn" data-bs-toggle="dropdown" disabled>變數</button>
                                    <ul class="dropdown-menu dropdown-menu-end folder-layer-vars"
                                        data-target="folderLayer1"></ul>
                                </div>
                                <span class="text-muted">/</span>
                                <div class="input-group input-group-sm" style="flex: 1;">
                                    <input type="text" class="form-control" id="folderLayer2" placeholder="中層"
                                        oninput="updateFolderLayers()" disabled>
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                        id="folderLayer2Btn" data-bs-toggle="dropdown" disabled>變數</button>
                                    <ul class="dropdown-menu dropdown-menu-end folder-layer-vars"
                                        data-target="folderLayer2"></ul>
                                </div>
                            </div>
                            <!-- 第二行：內層（佔整行） -->
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">內層</span>
                                <input type="text" class="form-control" id="folderLayer3" value="{num}"
                                    placeholder="{num}" oninput="updateFolderLayers()">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                    id="folderLayer3Btn" data-bs-toggle="dropdown">變數</button>
                                <ul class="dropdown-menu dropdown-menu-end folder-layer-vars"
                                    data-target="folderLayer3"></ul>
                            </div>
                            <div class="mt-1">
                                <small class="text-muted">
                                    <i class="bi bi-file-earmark-play"></i> 預覽: <span
                                        id="folderPreview">SSNI-618/[SSNI-618][SOD] 絕對領域.mp4</span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">檔案命名格式</label>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filenameFormat"
                                    value="[{num}][{maker}] {title}" placeholder="[{num}][{maker}] {title}"
                                    oninput="updateFolderPreview()">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">變數</button>
                                <ul class="dropdown-menu dropdown-menu-end format-vars" data-target="filenameFormat">
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">標題長度限制</label>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="maxTitleLength" value="80" min="20"
                                    max="200">
                                <span class="input-group-text">字元</span>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">檔名長度限制</label>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="maxFilenameLength" value="200" min="50"
                                    max="255">
                                <span class="input-group-text">字元</span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">影片副檔名</label>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control form-control-sm" id="videoExtensions"
                                value=".mp4, .avi, .mkv, .wmv, .rmvb, .flv, .mov, .m4v, .ts">
                            <small class="text-muted">以逗號分隔</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. 列表生成設定 (Gallery) -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> 列表生成
            </div>
            <div class="card-body">
                <!-- 常用設定 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">輸出目錄</label>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="avlistOutputDir" value="output"
                                placeholder="output">
                            <button class="btn btn-outline-secondary" type="button" onclick="selectOutputFolder()"
                                title="選擇資料夾">
                                <i class="bi bi-folder"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">輸出檔名</label>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control form-control-sm" id="avlistOutputFilename"
                            value="gallery_output.html" placeholder="gallery_output.html">
                    </div>
                </div>

                <!-- 進階顯示選項 (Collapsed) -->
                <hr class="my-3">
                <div class="mb-2">
                    <a class="collapse-toggle text-decoration-none" data-bs-toggle="collapse" href="#galleryAdvanced"
                        role="button" aria-expanded="false">
                        <i class="bi bi-chevron-down"></i> 進階顯示選項
                    </a>
                </div>
                <div class="collapse" id="galleryAdvanced">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">預設顯示模式</label>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select form-select-sm" id="avlistMode">
                                <option value="image">圖片模式</option>
                                <option value="detail">詳細模式</option>
                                <option value="text">文字模式</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">預設排序</label>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group input-group-sm">
                                <select class="form-select" id="avlistSort">
                                    <option value="date">發售日期</option>
                                    <option value="mdate">修改日期</option>
                                    <option value="num">番號</option>
                                    <option value="title">片名</option>
                                    <option value="actor">演員</option>
                                    <option value="maker">片商</option>
                                    <option value="size">檔案大小</option>
                                </select>
                                <select class="form-select" id="avlistOrder">
                                    <option value="descending">遞減</option>
                                    <option value="ascending">遞增</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">每頁顯示數量</label>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select form-select-sm" id="avlistItemsPerPage">
                                <option value="30">30</option>
                                <option value="45">45</option>
                                <option value="60">60</option>
                                <option value="90">90</option>
                                <option value="120">120</option>
                                <option value="0">全部</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">最小影片尺寸</label>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="avlistMinSize" value="0" min="0">
                                <span class="input-group-text">MB</span>
                            </div>
                            <small class="text-muted">0 = 不過濾</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 瀏覽與播放 (Showcase) -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-collection-play"></i> 瀏覽與播放
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">影片播放器</label>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control form-control-sm" id="viewerPlayer"
                            placeholder="留空使用系統預設">
                        <small class="text-muted">例如: C:\Program Files\DAUM\PotPlayer\PotPlayerMini64.exe</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. 系統設定 (System) -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-sliders"></i> 系統設定
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">主題模式</label>
                    </div>
                    <div class="col-md-6">
                        <select class="form-select form-select-sm" id="themeMode">
                            <option value="light">淺色模式 (Light)</option>
                            <option value="dark">深色模式 (Dark)</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">啟動時開啟頁面</label>
                    </div>
                    <div class="col-md-6">
                        <select class="form-select form-select-sm" id="defaultPage">
                            <option value="search">搜尋</option>
                            <option value="gallery">列表生成</option>
                            <option value="showcase">瀏覽</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="sidebarCollapsed">
                            <label class="form-check-label" for="sidebarCollapsed">啟動時收合側邊欄</label>
                        </div>
                        <small class="text-muted">僅影響桌面版</small>
                    </div>
                </div>

                <hr class="my-3">

                <!-- 重置按鈕 -->
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label text-danger">重置所有設定</label>
                        <small class="text-muted d-block">刪除所有自訂設定，恢復預設值</small>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-danger btn-sm" id="resetBtn">
                            <i class="bi bi-arrow-counterclockwise"></i> 重置為預設值
                        </button>
                    </div>
                </div>

                <hr class="my-3">

                <!-- 重看新手引導 -->
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">新手引導</label>
                        <small class="text-muted d-block">觀看功能介紹教學</small>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="btnRestartTutorial">
                            <i class="bi bi-play-circle"></i> 重看新手引導
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <hr class="my-3">

        <!-- 版本資訊 -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">版本資訊</label>
            </div>
            <div class="col-md-6">
                <span id="appVersion" class="text-muted">載入中...</span>
            </div>
        </div>

        <!-- 檢查更新 -->
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">軟體更新</label>
                <div class="form-text">手動檢查 GitHub 是否有新版本</div>
            </div>
            <div class="col-md-6 d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="btnCheckUpdate">
                    <i class="bi bi-cloud-download"></i> 檢查更新
                </button>
                <span id="updateStatus" class="small"></span>
            </div>
        </div>
</div>
</div>

<!-- 儲存按鈕 -->
<div class="d-flex justify-content-end gap-2">
    <button type="submit" class="btn btn-primary" id="saveBtn">
        <i class="bi bi-save"></i> 儲存設定
    </button>
</div>
</form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 格式變數清單
    const formatVariables = [
        { name: '{num}', description: '番號', example: 'SONE-205' },
        { name: '{title}', description: '標題', example: '新人出道...' },
        { name: '{actor}', description: '演員（第一位）', example: '三上悠亜' },
        { name: '{actors}', description: '所有演員', example: '三上悠亜, 明日花' },
        { name: '{maker}', description: '片商', example: 'S1' },
        { name: '{date}', description: '發行日期', example: '2024-01-15' },
        { name: '{year}', description: '年份', example: '2024' }
    ];

    // 初始化格式變數下拉選單
    document.querySelectorAll('.format-vars').forEach(menu => {
        formatVariables.forEach(v => {
            const li = document.createElement('li');
            li.innerHTML = `<a class="dropdown-item" href="#" data-var="${v.name}">
            <code>${v.name}</code> - ${v.description}
            <small class="text-muted d-block">${v.example}</small>
        </a>`;
            menu.appendChild(li);
        });

        menu.addEventListener('click', (e) => {
            e.preventDefault();
            const item = e.target.closest('[data-var]');
            if (item) {
                const targetId = menu.dataset.target;
                const input = document.getElementById(targetId);
                const cursorPos = input.selectionStart;
                const textBefore = input.value.substring(0, cursorPos);
                const textAfter = input.value.substring(cursorPos);
                input.value = textBefore + item.dataset.var + textAfter;
                input.focus();
                input.setSelectionRange(cursorPos + item.dataset.var.length, cursorPos + item.dataset.var.length);
                // 更新預覽（如果是 folderFormat）
                if (targetId === 'folderFormat') updateFolderPreview();
            }
        });
    });

    // === 資料夾多層結構功能 ===
    const FOLDER_PREVIEW_DATA = {
        num: 'SSNI-618',
        maker: 'SOD',
        actor: '三上悠亞',
        actors: '三上悠亞, 明日花',
        title: '絕對領域',
        date: '2024-01-15',
        year: '2024'
    };

    // 連動啟用邏輯（右→左：內 → 中 → 外）
    function updateFolderLayers() {
        const createFolder = document.getElementById('createFolder').checked;
        const layer3Input = document.getElementById('folderLayer3');  // 內層
        const layer2Input = document.getElementById('folderLayer2');  // 中層
        const layer1Input = document.getElementById('folderLayer1');  // 外層

        const layer3Btn = document.getElementById('folderLayer3Btn');
        const layer2Btn = document.getElementById('folderLayer2Btn');
        const layer1Btn = document.getElementById('folderLayer1Btn');

        // 如果「建立資料夾」未勾選，全部 disabled
        if (!createFolder) {
            layer3Input.disabled = true;
            layer3Btn.disabled = true;
            layer2Input.disabled = true;
            layer2Btn.disabled = true;
            layer1Input.disabled = true;
            layer1Btn.disabled = true;
            updateFolderPreview();
            return;
        }

        // 「建立資料夾」已勾選，啟用內層
        layer3Input.disabled = false;
        layer3Btn.disabled = false;

        // 連動啟用
        const layer3HasValue = !!layer3Input.value.trim();
        const layer2HasValue = !!layer2Input.value.trim();

        layer2Input.disabled = !layer3HasValue;
        layer2Btn.disabled = !layer3HasValue;

        layer1Input.disabled = !layer2HasValue;
        layer1Btn.disabled = !layer2HasValue;

        // 禁用時清空
        if (layer2Input.disabled) layer2Input.value = '';
        if (layer1Input.disabled) layer1Input.value = '';

        updateFolderPreview();
    }

    function updateFolderPreview() {
        const createFolder = document.getElementById('createFolder').checked;

        // 格式化檔名預覽
        const filenameFormat = document.getElementById('filenameFormat').value || '{num} {title}';
        let filenamePreview = filenameFormat;
        for (const [key, val] of Object.entries(FOLDER_PREVIEW_DATA)) {
            filenamePreview = filenamePreview.replace(new RegExp(`\\{${key}\\}`, 'g'), val);
        }

        // 如果「建立資料夾」未勾選，只顯示檔名
        if (!createFolder) {
            document.getElementById('folderPreview').textContent = filenamePreview + '.mp4';
            return;
        }

        // 收集所有層（由外到內）
        const layers = [
            document.getElementById('folderLayer1').value.trim(),
            document.getElementById('folderLayer2').value.trim(),
            document.getElementById('folderLayer3').value.trim()
        ].filter(v => v);

        // 格式化資料夾預覽
        let folderPreview = layers.map(layer => {
            let part = layer;
            for (const [key, val] of Object.entries(FOLDER_PREVIEW_DATA)) {
                part = part.replace(new RegExp(`\\{${key}\\}`, 'g'), val);
            }
            return part;
        }).join('/');

        const folder = folderPreview ? folderPreview + '/' : '';
        document.getElementById('folderPreview').textContent = folder + filenamePreview + '.mp4';
    }

    // 初始化資料夾層變數下拉選單
    document.querySelectorAll('.folder-layer-vars').forEach(menu => {
        menu.innerHTML = `
            <li><a class="dropdown-item" href="#" data-var="{num}">{num}</a></li>
            <li><a class="dropdown-item" href="#" data-var="{actor}">{actor}</a></li>
            <li><a class="dropdown-item" href="#" data-var="{maker}">{maker}</a></li>
            <li><a class="dropdown-item" href="#" data-var="{title}">{title}</a></li>
            <li><a class="dropdown-item" href="#" data-var="{year}">{year}</a></li>
        `;
        menu.addEventListener('click', (e) => {
            if (e.target.dataset.var) {
                e.preventDefault();
                const targetId = menu.dataset.target;
                const input = document.getElementById(targetId);
                input.value += e.target.dataset.var;
                input.focus();
                updateFolderLayers();
            }
        });
    });

    // 載入設定
    async function loadConfig() {
        try {
            const resp = await fetch('/api/config');
            const result = await resp.json();
            if (result.success) {
                const config = result.data;

                // Scraper 設定
                document.getElementById('createFolder').checked = config.scraper.create_folder;

                // 資料夾層（新格式 folder_layers 或對後兼容試圖分解舊的 folder_format）
                const layers = config.scraper.folder_layers || [];
                if (layers.length >= 1) {
                    document.getElementById('folderLayer3').value = layers[layers.length - 1] || '';
                }
                if (layers.length >= 2) {
                    document.getElementById('folderLayer2').value = layers[layers.length - 2] || '';
                }
                if (layers.length >= 3) {
                    document.getElementById('folderLayer1').value = layers[layers.length - 3] || '';
                }
                // 如果沒有 folder_layers，嘗試從舊的 folder_format 讀取
                if (layers.length === 0 && config.scraper.folder_format) {
                    document.getElementById('folderLayer3').value = config.scraper.folder_format;
                }

                // 先設定 filenameFormat，再更新預覽（預覽會用到 filenameFormat）
                document.getElementById('filenameFormat').value = config.scraper.filename_format;
                updateFolderLayers();
                document.getElementById('maxTitleLength').value = config.scraper.max_title_length;
                document.getElementById('maxFilenameLength').value = config.scraper.max_filename_length;
                document.getElementById('videoExtensions').value = config.scraper.video_extensions.join(', ');


                // 搜尋設定
                if (config.search) {
                    document.getElementById('galleryModeEnabled').checked = config.search.gallery_mode_enabled || false;
                    document.getElementById('uncensoredModeEnabled').checked = config.search.uncensored_mode_enabled || false;
                    document.getElementById('searchFavoriteFolder').value = config.search.favorite_folder || '';
                }

                // 翻譯設定
                document.getElementById('translateEnabled').checked = config.translate.enabled;
                document.getElementById('translateProvider').value = config.translate.provider || 'ollama';
                // Ollama 設定（支持新的嵌套结构和旧的扁平结构）
                document.getElementById('ollamaUrl').value = config.translate.ollama?.url || config.translate.ollama_url || '';

                // Gemini 設定
                if (config.translate.gemini) {
                    document.getElementById('geminiApiKey').value = config.translate.gemini.api_key || '';
                    // 預設填入模型（稍後測試時會更新）
                    const geminiModel = document.getElementById('geminiModel');
                    if (config.translate.gemini.model) {
                        geminiModel.innerHTML = `<option value="${config.translate.gemini.model}">${config.translate.gemini.model}</option>`;
                        geminiModel.value = config.translate.gemini.model;
                    }

                    // 如果有 API Key，自動測試獲取模型列表
                    if (config.translate.gemini.api_key && config.translate.provider === 'gemini') {
                        setTimeout(() => testGeminiConnection(), 100);
                    }
                }

                updateTranslateOptions();

                // AVList 設定
                if (config.gallery) {
                    document.getElementById('avlistMode').value = config.gallery.default_mode || 'image';
                    document.getElementById('avlistSort').value = config.gallery.default_sort || 'date';
                    document.getElementById('avlistOrder').value = config.gallery.default_order || 'descending';
                    document.getElementById('avlistItemsPerPage').value = config.gallery.items_per_page || 90;
                    document.getElementById('avlistMinSize').value = config.gallery.min_size_mb || 0;
                    document.getElementById('avlistOutputDir').value = config.gallery.output_dir || 'output';
                    document.getElementById('avlistOutputFilename').value = config.gallery.output_filename || 'gallery_output.html';
                }

                // 瀏覽器設定
                if (config.showcase) {
                    document.getElementById('viewerPlayer').value = config.showcase.player || '';
                }

                // 一般設定
                if (config.general) {
                    document.getElementById('defaultPage').value = config.general.default_page || 'search';
                    document.getElementById('themeMode').value = config.general.theme || 'light';
                    document.getElementById('sidebarCollapsed').checked = config.general.sidebar_collapsed || false;
                    // 即時套用主題
                    document.documentElement.setAttribute('data-theme', config.general.theme || 'light');
                }

                // 自動載入 Ollama 模型列表（如果有 URL 且是 Ollama provider）
                const ollamaUrl = config.translate.ollama?.url || config.translate.ollama_url;
                const ollamaModel = config.translate.ollama?.model || config.translate.ollama_model;
                if (ollamaUrl && config.translate.provider === 'ollama') {
                    await loadOllamaModels(ollamaUrl, ollamaModel);
                }
            }
        } catch (e) {
            console.error('載入設定失敗:', e);
        }
    }

    // 儲存設定
    async function saveConfig() {
        try {
            // 先載入現有設定，避免覆蓋其他頁面的資料
            const currentResp = await fetch('/api/config');
            const currentResult = await currentResp.json();
            if (!currentResult.success) {
                showToast('載入現有設定失敗', 'danger');
                return;
            }
            const config = currentResult.data;

            // 更新 scraper 設定
            const folderLayers = [
                document.getElementById('folderLayer1').value.trim(),
                document.getElementById('folderLayer2').value.trim(),
                document.getElementById('folderLayer3').value.trim()
            ].filter(v => v);

            config.scraper = {
                ...config.scraper,
                create_folder: document.getElementById('createFolder').checked,
                folder_layers: folderLayers,  // 新格式
                folder_format: folderLayers.join('/') || '{num}',  // 向後兼容
                filename_format: document.getElementById('filenameFormat').value,
                max_title_length: parseInt(document.getElementById('maxTitleLength').value),
                max_filename_length: parseInt(document.getElementById('maxFilenameLength').value),
                video_extensions: document.getElementById('videoExtensions').value
                    .split(',').map(s => s.trim()).filter(s => s)
            };

            // 更新 search 設定
            config.search = {
                ...config.search,
                gallery_mode_enabled: document.getElementById('galleryModeEnabled').checked,
                uncensored_mode_enabled: document.getElementById('uncensoredModeEnabled').checked,
                favorite_folder: document.getElementById('searchFavoriteFolder').value.trim()
            };

            // 更新 translate 設定（使用新的嵌套结构）
            config.translate = {
                ...config.translate,
                enabled: document.getElementById('translateEnabled').checked,
                provider: document.getElementById('translateProvider').value,
                ollama: {
                    url: document.getElementById('ollamaUrl').value,
                    model: document.getElementById('ollamaModel').value
                },
                gemini: {
                    api_key: document.getElementById('geminiApiKey').value,
                    model: document.getElementById('geminiModel').value || 'gemini-flash-lite-latest'
                }
            };

            // 更新 avlist 設定
            config.gallery = {
                ...config.gallery,
                default_mode: document.getElementById('avlistMode').value,
                default_sort: document.getElementById('avlistSort').value,
                default_order: document.getElementById('avlistOrder').value,
                items_per_page: parseInt(document.getElementById('avlistItemsPerPage').value),
                min_size_mb: parseInt(document.getElementById('avlistMinSize').value) || 0,
                output_dir: document.getElementById('avlistOutputDir').value.trim() || 'output',
                output_filename: document.getElementById('avlistOutputFilename').value.trim() || 'gallery_output.html'
            };

            // 更新 viewer 設定
            config.showcase = {
                ...config.showcase,
                player: document.getElementById('viewerPlayer').value.trim()
            };

            // 更新 general 設定
            config.general = {
                ...config.general,
                default_page: document.getElementById('defaultPage').value,
                theme: document.getElementById('themeMode').value,
                sidebar_collapsed: document.getElementById('sidebarCollapsed').checked
            };

            const resp = await fetch('/api/config', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
            const result = await resp.json();
            if (result.success) {
                showToast('設定已儲存', 'success');
                // 即時套用主題
                const newTheme = document.getElementById('themeMode').value;
                document.documentElement.setAttribute('data-theme', newTheme);
            } else {
                showToast('儲存失敗: ' + result.error, 'danger');
            }
        } catch (e) {
            showToast('儲存失敗: ' + e.message, 'danger');
        }
    }

    // 更新翻譯選項顯示
    function updateTranslateOptions() {
        const enabled = document.getElementById('translateEnabled').checked;
        document.getElementById('translateOptions').style.opacity = enabled ? '1' : '0.5';
        document.querySelectorAll('#translateOptions input, #translateOptions select, #translateOptions button').forEach(el => {
            // 不禁用整個區塊，只處理 opacity
            if (!enabled) {
                el.disabled = true;
            }
        });

        if (enabled) {
            // 先啟用 Provider 下拉選單
            document.getElementById('translateProvider').disabled = false;
            // 再應用 Provider 切換邏輯
            onTranslateProviderChange();
        }
    }

    // ===== Provider 切換邏輯 =====
    function onTranslateProviderChange() {
        const provider = document.getElementById('translateProvider').value;
        const ollamaFields = document.getElementById('ollamaFields');
        const geminiFields = document.getElementById('geminiFields');
        const enabled = document.getElementById('translateEnabled').checked;

        if (provider === 'ollama') {
            ollamaFields.style.display = 'block';
            geminiFields.style.display = 'none';
            // 啟用 Ollama 字段
            if (enabled) {
                ollamaFields.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
            }
        } else if (provider === 'gemini') {
            ollamaFields.style.display = 'none';
            geminiFields.style.display = 'block';
            // 啟用 Gemini 字段（除了模型選擇，需要先測試 API Key）
            if (enabled) {
                geminiFields.querySelectorAll('input, button').forEach(el => el.disabled = false);
                // 模型選擇保持 disabled 直到測試成功
                const geminiModel = document.getElementById('geminiModel');
                if (geminiModel.options.length <= 1 || !geminiModel.options[0].value) {
                    geminiModel.disabled = true;
                }
            }
        }
    }

    // ===== Gemini API Key 測試 =====
    async function testGeminiConnection() {
        const apiKey = document.getElementById('geminiApiKey').value;
        const statusEl = document.getElementById('geminiStatus');
        const testBtn = document.getElementById('testGeminiBtn');
        const modelSelect = document.getElementById('geminiModel');
        const hintEl = document.getElementById('geminiModelHint');

        if (!apiKey) {
            statusEl.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> 請輸入 API Key</span>';
            return;
        }

        // 禁用按鈕，顯示加載狀態
        testBtn.disabled = true;
        testBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        statusEl.innerHTML = '<span class="text-muted">連線中...</span>';

        try {
            const response = await fetch('/api/gemini/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: apiKey })
            });

            const data = await response.json();

            if (data.success) {
                // 成功：顯示找到的模型數量
                statusEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> 找到 ${data.count} 個 Flash 模型</span>`;

                // 填充模型下拉框
                populateGeminiModels(data.models);

                // 啟用模型下拉框和測試按鈕
                modelSelect.disabled = false;
                document.getElementById('testGeminiTranslateBtn').disabled = false;

            } else {
                // 失敗：顯示錯誤信息
                statusEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${data.error || '連接失敗'}</span>`;

                // 禁用模型下拉框
                modelSelect.disabled = true;
                modelSelect.innerHTML = '<option value="">-- 請先測試 API Key --</option>';
                hintEl.textContent = '';
            }

        } catch (error) {
            statusEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${error.message}</span>`;
        } finally {
            // 恢復按鈕
            testBtn.disabled = false;
            testBtn.innerHTML = '<i class="bi bi-plug"></i> 測試';
        }
    }

    // 填充 Gemini 模型下拉框
    function populateGeminiModels(models) {
        const select = document.getElementById('geminiModel');
        const savedModel = select.value;

        select.innerHTML = '';

        models.forEach((model, index) => {
            const option = document.createElement('option');
            option.value = model.name;

            // 添加推薦標籤
            if (index === 0 && model.name.includes('lite')) {
                option.textContent = `${model.name} (推薦，最快)`;
            } else if (index === 0) {
                option.textContent = `${model.name} (推薦)`;
            } else {
                option.textContent = model.name;
            }

            select.appendChild(option);
        });

        // 恢復之前選擇的模型
        if (savedModel && models.some(m => m.name === savedModel)) {
            select.value = savedModel;
        }
    }

    // 測試 Gemini 翻譯功能
    async function testGeminiTranslation() {
        const apiKey = document.getElementById('geminiApiKey').value;
        const model = document.getElementById('geminiModel').value;
        const statusEl = document.getElementById('geminiModelStatus');
        const testBtn = document.getElementById('testGeminiTranslateBtn');

        if (!apiKey) {
            statusEl.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> 請先輸入 API Key</span>';
            return;
        }

        if (!model) {
            statusEl.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> 請先選擇模型</span>';
            return;
        }

        // 禁用按鈕，顯示加載狀態
        testBtn.disabled = true;
        testBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        statusEl.innerHTML = '<span class="text-muted">測試翻譯中...</span>';

        try {
            const response = await fetch('/api/gemini/test-translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    api_key: apiKey,
                    model: model
                })
            });

            const data = await response.json();

            if (data.success) {
                // 翻譯成功
                statusEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle-fill"></i> 翻譯測試成功！ (${data.translation})</span>`;
            } else {
                // 翻譯失敗 - 顯示 Google 的錯誤訊息
                statusEl.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> ${data.error}</span>`;
            }

        } catch (error) {
            statusEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> 測試失敗: ${error.message}</span>`;
        } finally {
            // 恢復按鈕
            testBtn.disabled = false;
            testBtn.innerHTML = '<i class="bi bi-chat-dots"></i> 測試';
        }
    }

    // 選擇輸出資料夾 (PyWebView)
    async function selectOutputFolder() {
        if (typeof window.pywebview === 'undefined' || !window.pywebview.api) {
            alert('此功能需要在桌面應用程式中使用');
            return;
        }

        try {
            const result = await window.pywebview.api.select_folder();
            if (result && result.folder) {
                document.getElementById('avlistOutputDir').value = result.folder;
            }
        } catch (e) {
            console.error('選擇資料夾失敗:', e);
        }
    }

    // Toast 提示
    function showToast(message, type = 'info') {
        // 簡單的 alert，可以之後改成 Bootstrap toast
        if (type === 'success') {
            alert(message);
        } else {
            alert('錯誤: ' + message);
        }
    }

    // 載入 Ollama 模型列表（靜默版本，頁面載入時使用）
    async function loadOllamaModels(url, savedModel = '') {
        const statusEl = document.getElementById('ollamaStatus');
        const modelSelect = document.getElementById('ollamaModel');

        if (!url) return;

        statusEl.innerHTML = '<span class="text-muted">載入模型中...</span>';

        try {
            const resp = await fetch(`/api/ollama/models?url=${encodeURIComponent(url)}`);
            const result = await resp.json();

            if (result.success && result.models && result.models.length > 0) {
                modelSelect.innerHTML = result.models.map(m =>
                    `<option value="${m}">${m}</option>`
                ).join('');

                // 設定儲存的模型
                if (savedModel && result.models.includes(savedModel)) {
                    modelSelect.value = savedModel;
                }

                statusEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> ${result.models.length} 個模型</span>`;
            } else {
                statusEl.innerHTML = `<span class="text-warning"><i class="bi bi-exclamation-circle"></i> ${result.error || '無法連線'}</span>`;
            }
        } catch (e) {
            statusEl.innerHTML = `<span class="text-warning"><i class="bi bi-exclamation-circle"></i> 無法連線</span>`;
        }
    }

    // 測試 Ollama 連線並載入模型
    async function testOllamaConnection() {
        const url = document.getElementById('ollamaUrl').value.trim();
        const statusEl = document.getElementById('ollamaStatus');
        const modelSelect = document.getElementById('ollamaModel');
        const btn = document.getElementById('testOllamaBtn');

        if (!url) {
            statusEl.innerHTML = '<span class="text-danger">請輸入 URL</span>';
            return;
        }

        // 顯示載入中
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        statusEl.innerHTML = '<span class="text-muted">連線中...</span>';

        try {
            const resp = await fetch(`/api/ollama/models?url=${encodeURIComponent(url)}`);
            const result = await resp.json();

            if (result.success && result.models && result.models.length > 0) {
                // 成功：填入模型選單
                const currentModel = modelSelect.value;
                modelSelect.innerHTML = result.models.map(m =>
                    `<option value="${m}">${m}</option>`
                ).join('');

                // 保留之前選擇的模型（如果還存在）
                if (currentModel && result.models.includes(currentModel)) {
                    modelSelect.value = currentModel;
                }

                statusEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> 已連線，${result.models.length} 個模型</span>`;
            } else {
                statusEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${result.error || '無可用模型'}</span>`;
                modelSelect.innerHTML = '<option value="">-- 連線失敗 --</option>';
            }
        } catch (e) {
            statusEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${e.message}</span>`;
            modelSelect.innerHTML = '<option value="">-- 連線失敗 --</option>';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-plug"></i> 測試';
        }
    }

    // 測試模型是否能正常回應
    async function testModel() {
        const url = document.getElementById('ollamaUrl').value.trim();
        const model = document.getElementById('ollamaModel').value;
        const statusEl = document.getElementById('modelStatus');
        const btn = document.getElementById('testModelBtn');

        if (!url || !model) {
            statusEl.innerHTML = '<span class="text-danger">請先選擇模型</span>';
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        statusEl.innerHTML = '<span class="text-muted">測試中...</span>';

        try {
            // 直接調用 Ollama API 測試當前選擇的模型
            const resp = await fetch('/api/ollama/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url, model })
            });
            const result = await resp.json();

            if (result.success) {
                statusEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> ${result.result}</span>`;
            } else {
                statusEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${result.error}</span>`;
            }
        } catch (e) {
            statusEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${e.message}</span>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-chat-dots"></i> 測試';
        }
    }

    // 事件綁定
    document.getElementById('translateEnabled').addEventListener('change', updateTranslateOptions);
    document.getElementById('translateProvider').addEventListener('change', onTranslateProviderChange);
    document.getElementById('testOllamaBtn').addEventListener('click', testOllamaConnection);
    document.getElementById('testModelBtn').addEventListener('click', testModel);
    document.getElementById('testGeminiBtn').addEventListener('click', testGeminiConnection);
    document.getElementById('testGeminiTranslateBtn').addEventListener('click', testGeminiTranslation);

    document.getElementById('settingsForm').addEventListener('submit', (e) => {
        e.preventDefault();
        saveConfig();
    });

    document.getElementById('resetBtn').addEventListener('click', async () => {
        if (confirm('確定要重置所有設定嗎？此操作將刪除所有自訂設定。')) {
            try {
                const resp = await fetch('/api/config', { method: 'DELETE' });
                const result = await resp.json();
                if (result.success) {
                    await loadConfig();
                    showToast('已恢復預設設定', 'success');
                } else {
                    showToast('重置失敗: ' + result.error, 'danger');
                }
            } catch (e) {
                showToast('重置失敗: ' + e.message, 'danger');
            }
        }
    });

    // 重看新手引導
    document.getElementById('btnRestartTutorial')?.addEventListener('click', () => {
        window.location.href = '/search?tutorial=restart';
    });

    // 載入版本資訊
    async function loadVersion() {
        try {
            const resp = await fetch('/api/version');
            const data = await resp.json();
            if (data.success) {
                document.getElementById('appVersion').textContent = `v${data.version}`;
                document.getElementById('appVersion').classList.remove('text-muted');
                document.getElementById('appVersion').classList.add('text-primary');
            }
        } catch (e) {
            document.getElementById('appVersion').textContent = '無法載入';
        }
    }

    // 檢查更新
    document.getElementById('btnCheckUpdate')?.addEventListener('click', async () => {
        const btn = document.getElementById('btnCheckUpdate');
        const status = document.getElementById('updateStatus');

        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> 檢查中...';
        status.textContent = '';
        status.className = 'small';

        try {
            const resp = await fetch('/api/check-update');
            const data = await resp.json();

            if (data.success) {
                if (data.has_update) {
                    status.innerHTML = `<a href="${data.download_url}" target="_blank" class="text-success">
                        <i class="bi bi-download"></i> 新版本 ${data.latest_version} 可用
                    </a>`;
                } else {
                    status.innerHTML = '<span class="text-muted"><i class="bi bi-check-circle"></i> 已是最新版本</span>';
                }
            } else {
                status.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-circle"></i> ${data.error || '檢查失敗'}</span>`;
            }
        } catch (e) {
            status.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-circle"></i> 網路錯誤</span>';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-cloud-download"></i> 檢查更新';
        }
    });

    // 初始載入
    loadConfig();
    loadVersion();
</script>
{% endblock %}