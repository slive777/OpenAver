{% extends "base.html" %}

{% block title %}設定 - OpenAver{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/pages/settings.css">
{% endblock %}

{% block content %}
<div id="settings-components" x-data="settingsPage()">
    <div class="settings-header">
        <h4 class="mb-0">
            <i class="bi bi-gear"></i> 設定
        </h4>
        <div class="settings-theme-toggle">
            <button class="theme-toggle-btn"
                    @click="theme = (theme === 'light' ? 'dim' : 'light')"
                    :title="theme === 'light' ? '切換至深色模式' : '切換至淺色模式'"
                    type="button">
                <i class="bi" :class="theme === 'light' ? 'bi-moon-stars' : 'bi-sun'"></i>
                <span class="theme-toggle-label" x-text="theme === 'light' ? 'Light' : 'Dim'"></span>
            </button>
        </div>
    </div>

    <form id="settingsForm" @submit.prevent="saveConfig">
        <!-- 1. 搜尋與刮削設定 (Search & Scraper) -->
        <div class="card mb-4">
            <div class="settings-card-header">
                <i class="bi bi-search"></i> 搜尋與刮削
            </div>
            <div class="card-body">

                <div class="settings-form-group">
                    <label class="settings-label">
                        <input type="checkbox" class="toggle toggle-primary" id="galleryModeEnabled"
                            x-model="form.galleryModeEnabled">
                        <span class="label-text">女優畫廊模式 <span class="badge badge-error badge-sm">Beta</span></span>
                    </label>
                </div>

                <div class="settings-form-group">
                    <label class="settings-label">
                        <input type="checkbox" class="toggle toggle-primary" id="uncensoredModeEnabled"
                            x-model="form.uncensoredModeEnabled">
                        <span class="label-text">無碼模式</span>
                    </label>
                    <small class="settings-hint">啟用時只搜尋 AVSOX / FC2，適合無碼作品</small>
                </div>

                <!-- 我的最愛資料夾 -->
                <div class="settings-form-row">
                    <label class="row-label">
                        我的最愛資料夾
                        <small class="settings-hint">一鍵載入常用資料夾</small>
                    </label>
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                        <input type="text" class="input input-bordered input-sm" id="searchFavoriteFolder"
                            x-model="form.searchFavoriteFolder"
                            placeholder="留空 = 系統下載資料夾">
                        <small class="settings-hint">範例：C:\Users\&lt;你的使用者名稱&gt;\下載</small>
                    </div>
                </div>

                <div class="settings-form-group">
                    <label class="settings-label">
                        <input type="checkbox" class="toggle toggle-primary" id="translateEnabled"
                            x-model="form.translateEnabled">
                        <span class="label-text">啟用標題翻譯</span>
                    </label>
                </div>

                <!-- 翻譯選項 (動態顯示) -->
                <div id="translateOptions"
                     :style="{ opacity: form.translateEnabled ? '1' : '0.5' }">
                    <div class="settings-form-row">
                        <label class="row-label">翻譯服務</label>
                        <select class="select select-bordered select-sm" id="translateProvider"
                            x-model="form.translateProvider"
                            :disabled="!form.translateEnabled">
                            <option value="ollama">Ollama（本地）</option>
                            <option value="gemini">Gemini（Google 雲端）</option>
                        </select>
                    </div>

                    <!-- Ollama 設定 -->
                    <div id="ollamaFields" x-show="form.translateProvider === 'ollama'">
                        <div class="settings-form-row">
                            <label class="row-label">Ollama URL</label>
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                                <div class="variable-input-group">
                                    <input type="text" class="input input-bordered input-sm" id="ollamaUrl"
                                        x-model="form.ollamaUrl" style="flex: 1;"
                                        :disabled="!form.translateEnabled">
                                    <button class="btn btn-sm btn-outline btn-neutral" type="button" id="testOllamaBtn"
                                        @click="testOllamaConnection()"
                                        :disabled="!form.translateEnabled">
                                        <i class="bi bi-plug"></i> 測試
                                    </button>
                                </div>
                                <small class="settings-hint" x-html="ollamaStatus"></small>
                            </div>
                        </div>

                        <div class="settings-form-row">
                            <label class="row-label">模型</label>
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                                <div class="variable-input-group">
                                    <select class="select select-bordered select-sm" id="ollamaModel" style="flex: 1;"
                                        x-model="form.ollamaModel" :disabled="!form.translateEnabled || ollamaModels.length === 0">
                                        <option value="" disabled x-show="ollamaModels.length === 0">請先測試連線</option>
                                        <template x-for="model in ollamaModels" :key="model">
                                            <option :value="model" x-text="model"></option>
                                        </template>
                                    </select>
                                    <button class="btn btn-sm btn-outline btn-neutral" type="button" id="testModelBtn"
                                        @click="testModel()" title="測試模型"
                                        :disabled="!form.translateEnabled">
                                        <i class="bi bi-chat-dots"></i> 測試
                                    </button>
                                </div>
                                <small class="settings-hint" x-html="modelStatus"></small>
                            </div>
                        </div>
                    </div>

                    <!-- Gemini 設定 (初始隱藏) -->
                    <div id="geminiFields" x-show="form.translateProvider === 'gemini'">
                        <div class="settings-form-row">
                            <label class="row-label">API Key</label>
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                                <div class="variable-input-group">
                                    <input type="password" class="input input-bordered input-sm" id="geminiApiKey"
                                        x-model="form.geminiApiKey" placeholder="AIza..." style="flex: 1;"
                                        :disabled="!form.translateEnabled">
                                    <button class="btn btn-sm btn-outline btn-neutral" type="button" id="testGeminiBtn"
                                        @click="testGeminiConnection()"
                                        :disabled="!form.translateEnabled">
                                        <i class="bi bi-plug"></i> 測試
                                    </button>
                                </div>
                                <small class="settings-hint" x-html="geminiStatus"></small>
                                <small class="settings-hint">
                                    <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a>
                                    可免費申請
                                </small>

                                <!-- 安全警告 -->
                                <div class="alert alert-warning api-key-alert" role="alert">
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                    <div class="alert-content">
                                        <strong>安全提示：</strong>
                                        <ul class="alert-list">
                                            <li>API Key 將以明文存儲在 config.json</li>
                                            <li>請勿將 config.json 分享給他人</li>
                                            <li>如需撤銷，請前往 <a href="https://aistudio.google.com/apikey" target="_blank" class="alert-link">Google
                                                    AI Studio</a> 重新生成</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-form-row">
                            <label class="row-label">模型</label>
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                                <div class="variable-input-group">
                                    <select class="select select-bordered select-sm" id="geminiModel" style="flex: 1;"
                                        x-model="form.geminiModel" :disabled="!form.translateEnabled || geminiModels.length === 0">
                                        <option value="" disabled x-show="geminiModels.length === 0">請先測試 API Key</option>
                                        <template x-for="model in geminiModels" :key="model.name">
                                            <option :value="model.name" x-text="model.name"></option>
                                        </template>
                                    </select>
                                    <button class="btn btn-sm btn-outline btn-neutral" type="button" id="testGeminiTranslateBtn"
                                        @click="testGeminiTranslation()" title="測試翻譯功能"
                                        :disabled="!form.translateEnabled || geminiModels.length === 0">
                                        <i class="bi bi-chat-dots"></i> 測試
                                    </button>
                                </div>
                                <small class="settings-hint" x-html="geminiModelStatus"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 進階刮削設定 (Collapsed) -->
                <hr class="my-3">
                <div x-data="{ expanded: false }">
                    <button class="collapsible-trigger" type="button" @click="expanded = !expanded" :aria-expanded="expanded.toString()">
                        <span class="collapsible-title">
                            <i class="bi bi-gear"></i> 進階刮削設定
                        </span>
                        <span class="btn-icon-collapse" aria-hidden="true">
                            <i class="bi bi-chevron-down" :class="{ 'rotate-180': expanded }"></i>
                        </span>
                    </button>
                    <div x-show="expanded" x-transition class="collapsible-content" id="scraperAdvanced">
                    <div class="settings-form-group">
                        <label class="settings-label">
                            <input type="checkbox" class="toggle toggle-primary" id="createFolder"
                                x-model="form.createFolder">
                            <span class="label-text">建立資料夾</span>
                        </label>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">資料夾層級</label>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                            <!-- 第一行：外層 / 中層 -->
                            <div class="folder-layers-row">
                                <div class="folder-layer-group" :class="{ 'disabled': !layer1Enabled }" x-data="{ open: false }">
                                    <input type="text" class="input input-bordered input-sm" id="folderLayer1" placeholder="外層"
                                        x-model="form.folderLayer1" :disabled="!layer1Enabled">
                                    <button class="btn-variable-sm" type="button"
                                        id="folderLayer1Btn" @click="open = !open" :disabled="!layer1Enabled">
                                        <i class="bi bi-braces"></i>
                                    </button>
                                    <div x-show="open" @click.outside="open = false" x-transition class="variable-menu">
                                        <template x-for="v in folderVariables" :key="v.name">
                                            <div class="variable-item" @click="appendVariable('folderLayer1', v.name); open = false">
                                                <code class="variable-name" x-text="v.name"></code>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                <span class="folder-separator">/</span>
                                <div class="folder-layer-group" :class="{ 'disabled': !layer2Enabled }" x-data="{ open: false }">
                                    <input type="text" class="input input-bordered input-sm" id="folderLayer2" placeholder="中層"
                                        x-model="form.folderLayer2" :disabled="!layer2Enabled">
                                    <button class="btn-variable-sm" type="button"
                                        id="folderLayer2Btn" @click="open = !open" :disabled="!layer2Enabled">
                                        <i class="bi bi-braces"></i>
                                    </button>
                                    <div x-show="open" @click.outside="open = false" x-transition class="variable-menu">
                                        <template x-for="v in folderVariables" :key="v.name">
                                            <div class="variable-item" @click="appendVariable('folderLayer2', v.name); open = false">
                                                <code class="variable-name" x-text="v.name"></code>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            <!-- 第二行：內層（佔整行） -->
                            <div class="folder-layer-group" :class="{ 'disabled': !layer3Enabled }" x-data="{ open: false }">
                                <span class="input-group-text">內層</span>
                                <input type="text" class="input input-bordered input-sm" id="folderLayer3"
                                    x-model="form.folderLayer3" placeholder="{num}" :disabled="!layer3Enabled" style="flex: 1;">
                                <button class="btn-variable-sm" type="button"
                                    id="folderLayer3Btn" @click="open = !open" :disabled="!layer3Enabled">
                                    <i class="bi bi-braces"></i>
                                </button>
                                <div x-show="open" @click.outside="open = false" x-transition class="variable-menu">
                                    <template x-for="v in folderVariables" :key="v.name">
                                        <div class="variable-item" @click="appendVariable('folderLayer3', v.name); open = false">
                                            <code class="variable-name" x-text="v.name"></code>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="folder-preview">
                                <i class="bi bi-file-earmark-play"></i>
                                <span class="preview-text">預覽: <span x-text="folderPreviewText"></span></span>
                            </div>
                        </div>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">檔案命名格式</label>
                        <div class="variable-input-group" x-data="{ open: false }">
                            <input type="text" class="input input-bordered input-sm" id="filenameFormat"
                                x-model="form.filenameFormat" placeholder="[{num}][{maker}] {title}" style="flex: 1;">
                            <button class="btn-variable" type="button"
                                @click="open = !open" :aria-expanded="open">
                                <i class="bi bi-braces"></i> 變數
                            </button>
                            <div x-show="open" @click.outside="open = false" x-transition class="variable-menu">
                                <template x-for="v in formatVariables" :key="v.name">
                                    <div class="variable-item" @click="insertVariable('filenameFormat', v.name); open = false">
                                        <code class="variable-name" x-text="v.name"></code>
                                        <span class="variable-desc" x-text="v.description"></span>
                                        <small class="variable-example" x-text="'例：' + v.example"></small>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">標題長度限制</label>
                        <div class="input-group-inline">
                            <input type="number" class="input input-bordered input-sm" id="maxTitleLength"
                                x-model.number="form.maxTitleLength" min="20" max="200">
                            <span class="input-suffix">字元</span>
                        </div>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">檔名長度限制</label>
                        <div class="input-group-inline">
                            <input type="number" class="input input-bordered input-sm" id="maxFilenameLength"
                                x-model.number="form.maxFilenameLength" min="50" max="255">
                            <span class="input-suffix">字元</span>
                        </div>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">影片副檔名</label>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                            <input type="text" class="input input-bordered input-sm" id="videoExtensions"
                                x-model="form.videoExtensions">
                            <small class="settings-hint">以逗號分隔</small>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. 列表生成設定 (Gallery) -->
        <div class="card mb-4">
            <div class="settings-card-header">
                <i class="bi bi-list-ul"></i> 列表生成
            </div>
            <div class="card-body">
                <!-- 常用設定 -->
                <div class="settings-form-row">
                    <label class="row-label">輸出目錄</label>
                    <div class="variable-input-group">
                        <input type="text" class="input input-bordered input-sm" id="avlistOutputDir"
                            x-model="form.avlistOutputDir" placeholder="output" style="flex: 1;">
                        <button class="btn btn-sm btn-outline btn-neutral" type="button"
                            @click="selectOutputFolder()" title="選擇資料夾">
                            <i class="bi bi-folder"></i>
                        </button>
                    </div>
                </div>

                <div class="settings-form-row">
                    <label class="row-label">輸出檔名</label>
                    <input type="text" class="input input-bordered input-sm" id="avlistOutputFilename"
                        x-model="form.avlistOutputFilename" placeholder="gallery_output.html">
                </div>

                <!-- 進階顯示選項 (Collapsed) -->
                <hr class="my-3">
                <div x-data="{ expanded: false }">
                    <button class="collapsible-trigger" type="button" @click="expanded = !expanded" :aria-expanded="expanded.toString()">
                        <span class="collapsible-title">
                            <i class="bi bi-sliders"></i> 進階顯示選項
                        </span>
                        <span class="btn-icon-collapse" aria-hidden="true">
                            <i class="bi bi-chevron-down" :class="{ 'rotate-180': expanded }"></i>
                        </span>
                    </button>
                    <div x-show="expanded" x-transition class="collapsible-content" id="galleryAdvanced">
                    <div class="settings-form-row">
                        <label class="row-label">預設顯示模式</label>
                        <select class="select select-bordered select-sm" id="avlistMode"
                            x-model="form.avlistMode">
                            <option value="image">圖片模式</option>
                            <option value="detail">詳細模式</option>
                            <option value="text">文字模式</option>
                        </select>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">預設排序</label>
                        <div class="sort-row" style="display: flex; gap: 8px; flex: 1;">
                            <select class="select select-bordered select-sm" id="avlistSort" style="flex: 1;"
                                x-model="form.avlistSort">
                                <option value="date">發售日期</option>
                                <option value="mdate">修改日期</option>
                                <option value="num">番號</option>
                                <option value="title">片名</option>
                                <option value="actor">演員</option>
                                <option value="maker">片商</option>
                                <option value="size">檔案大小</option>
                            </select>
                            <select class="select select-bordered select-sm" id="avlistOrder" style="width: 100px;"
                                x-model="form.avlistOrder">
                                <option value="descending">遞減</option>
                                <option value="ascending">遞增</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">每頁顯示數量</label>
                        <select class="select select-bordered select-sm" id="avlistItemsPerPage"
                            x-model.number="form.avlistItemsPerPage">
                            <option value="30">30</option>
                            <option value="45">45</option>
                            <option value="60">60</option>
                            <option value="90">90</option>
                            <option value="120">120</option>
                            <option value="0">全部</option>
                        </select>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">最小影片尺寸</label>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                            <div class="input-group-inline">
                                <input type="number" class="input input-bordered input-sm" id="avlistMinSize"
                                    x-model.number="form.avlistMinSize" min="0">
                                <span class="input-suffix">MB</span>
                            </div>
                            <small class="settings-hint">0 = 不過濾</small>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 瀏覽與播放 (Showcase) -->
        <div class="card mb-4">
            <div class="settings-card-header">
                <i class="bi bi-collection-play"></i> 瀏覽與播放
            </div>
            <div class="card-body">
                <div class="settings-form-row">
                    <label class="row-label">影片播放器</label>
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                        <input type="text" class="input input-bordered input-sm" id="viewerPlayer"
                            x-model="form.viewerPlayer" placeholder="留空使用系統預設">
                        <small class="settings-hint">例如: C:\Program Files\DAUM\PotPlayer\PotPlayerMini64.exe</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. 系統設定 (System) -->
        <div class="card mb-4">
            <div class="settings-card-header">
                <i class="bi bi-sliders"></i> 系統設定
            </div>
            <div class="card-body">
                <div class="settings-form-row">
                    <label class="row-label">啟動時開啟頁面</label>
                    <select class="select select-bordered select-sm" id="defaultPage"
                        x-model="form.defaultPage">
                        <option value="search">搜尋</option>
                        <option value="scanner">列表生成</option>
                        <option value="showcase">瀏覽</option>
                    </select>
                </div>
                <div class="settings-form-group">
                    <label class="settings-label">
                        <input type="checkbox" class="toggle toggle-primary" id="sidebarCollapsed"
                            x-model="form.sidebarCollapsed">
                        <span class="label-text">啟動時收合側邊欄</span>
                    </label>
                    <small class="settings-hint">僅影響桌面版</small>
                </div>

                <hr class="my-3">

                <!-- 重置按鈕 -->
                <div class="settings-form-row">
                    <label class="row-label text-error">
                        重置所有設定
                        <small class="settings-hint">刪除所有自訂設定，恢復預設值</small>
                    </label>
                    <button type="button" class="btn btn-sm btn-outline btn-error"
                        @click="resetConfig()">
                        <i class="bi bi-arrow-counterclockwise"></i> 重置為預設值
                    </button>
                </div>

                <hr class="my-3">

                <!-- 重看新手引導 -->
                <div class="settings-form-row">
                    <label class="row-label">
                        新手引導
                        <small class="settings-hint">觀看功能介紹教學</small>
                    </label>
                    <button type="button" class="btn btn-sm btn-outline btn-primary"
                        @click="restartTutorial()">
                        <i class="bi bi-play-circle"></i> 重看新手引導
                    </button>
                </div>
            </div>
        </div>
        <hr class="my-3">

        <!-- 版本資訊 -->
        <div class="settings-form-row">
            <label class="row-label">版本資訊</label>
            <span class="version-text" x-text="appVersion"></span>
        </div>

        <!-- 檢查更新 -->
        <div class="settings-form-row">
            <label class="row-label">
                軟體更新
                <small class="settings-hint">手動檢查 GitHub 是否有新版本</small>
            </label>
            <div class="update-check-wrapper">
                <button type="button" class="btn btn-sm btn-outline btn-neutral" id="btnCheckUpdate"
                    @click="checkUpdate()">
                    <i class="bi bi-cloud-download"></i> 檢查更新
                </button>
                <span class="small" x-html="updateStatus"></span>
            </div>
        </div>

        <!-- 儲存按鈕 -->
        <div class="save-btn-wrapper">
            <button type="submit" class="btn btn-primary save-btn" id="saveBtn">
                <i class="bi bi-save"></i> 儲存設定
            </button>
        </div>
    </form>

    <!-- Dirty Check Modal -->
    <dialog id="dirtyCheckModal" class="modal fluent-modal">
        <div class="modal-box fluent-modal-box">
            <h3 class="fluent-modal-title">
                <i class="bi bi-exclamation-triangle"></i> 尚未儲存的變更
            </h3>
            <p class="fluent-modal-body">
                您有修改尚未儲存，要如何處理？
            </p>
            <div class="modal-action fluent-modal-actions">
                <button type="button" class="btn btn-ghost" @click="dirtyCheckCancel()">
                    取消
                </button>
                <button type="button" class="btn btn-outline btn-warning" @click="dirtyCheckDiscard()">
                    <i class="bi bi-x-circle"></i> 不儲存
                </button>
                <button type="button" class="btn btn-primary" @click="dirtyCheckSave()">
                    <i class="bi bi-save"></i> 儲存更改
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

<!-- Toast 通知容器 -->
<div id="toastContainer" class="toast toast-end toast-top" style="z-index: 9999;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/pages/settings.js"></script>
{% endblock %}