{% extends "base.html" %}

{% block title %}設定 - JavHelper{% endblock %}

{% block content %}
<div class="container-fluid">
    <h4 class="mb-4">
        <i class="bi bi-gear"></i> 設定
    </h4>

    <form id="settingsForm">
        <!-- Scraper 設定 -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-cloud-download"></i> Scraper 設定
            </div>
            <div class="card-body">
                <!-- 資料夾設定 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="createFolder" checked>
                            <label class="form-check-label" for="createFolder">建立資料夾</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">格式</span>
                            <input type="text" class="form-control" id="folderFormat" value="{num}">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">變數</button>
                            <ul class="dropdown-menu dropdown-menu-end format-vars" data-target="folderFormat"></ul>
                        </div>
                    </div>
                </div>

                <!-- 檔名設定 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">檔案命名格式</label>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="filenameFormat" value="{num} {title}">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">變數</button>
                            <ul class="dropdown-menu dropdown-menu-end format-vars" data-target="filenameFormat"></ul>
                        </div>
                    </div>
                </div>

                <!-- 長度限制 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">標題長度限制</label>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" id="maxTitleLength" value="80" min="20" max="200">
                            <span class="input-group-text">字元</span>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">檔名長度限制</label>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" id="maxFilenameLength" value="200" min="50" max="255">
                            <span class="input-group-text">字元</span>
                        </div>
                    </div>
                </div>

                <!-- 影片副檔名 -->
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">影片副檔名</label>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control form-control-sm" id="videoExtensions"
                               value=".mp4, .avi, .mkv, .wmv, .rmvb, .flv, .mov, .m4v, .ts">
                        <small class="text-muted">以逗號分隔</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜尋設定 -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-search"></i> 搜尋設定
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoSearchOnDrop" checked>
                            <label class="form-check-label" for="autoSearchOnDrop">拖入檔案自動搜尋</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 翻譯設定 -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-translate"></i> 翻譯設定
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="translateEnabled">
                            <label class="form-check-label" for="translateEnabled">啟用標題翻譯</label>
                        </div>
                    </div>
                </div>

                <div id="translateOptions">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">翻譯服務</label>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select form-select-sm" id="translateProvider">
                                <option value="ollama">Ollama（本地）</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Ollama URL</label>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control form-control-sm" id="ollamaUrl"
                                   value="http://localhost:11434">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">模型名稱</label>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control form-control-sm" id="ollamaModel"
                                   value="qwen2.5:7b">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 儲存按鈕 -->
        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" id="resetBtn">
                <i class="bi bi-arrow-counterclockwise"></i> 重置
            </button>
            <button type="submit" class="btn btn-primary" id="saveBtn">
                <i class="bi bi-save"></i> 儲存設定
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 格式變數清單
const formatVariables = [
    {name: '{num}', description: '番號', example: 'SONE-205'},
    {name: '{title}', description: '標題', example: '新人出道...'},
    {name: '{actor}', description: '演員（第一位）', example: '三上悠亜'},
    {name: '{actors}', description: '所有演員', example: '三上悠亜, 明日花'},
    {name: '{maker}', description: '片商', example: 'S1'},
    {name: '{date}', description: '發行日期', example: '2024-01-15'},
    {name: '{year}', description: '年份', example: '2024'}
];

// 初始化格式變數下拉選單
document.querySelectorAll('.format-vars').forEach(menu => {
    formatVariables.forEach(v => {
        const li = document.createElement('li');
        li.innerHTML = `<a class="dropdown-item" href="#" data-var="${v.name}">
            <code>${v.name}</code> - ${v.description}
            <small class="text-muted d-block">${v.example}</small>
        </a>`;
        menu.appendChild(li);
    });

    menu.addEventListener('click', (e) => {
        e.preventDefault();
        const item = e.target.closest('[data-var]');
        if (item) {
            const targetId = menu.dataset.target;
            const input = document.getElementById(targetId);
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(cursorPos);
            input.value = textBefore + item.dataset.var + textAfter;
            input.focus();
            input.setSelectionRange(cursorPos + item.dataset.var.length, cursorPos + item.dataset.var.length);
        }
    });
});

// 載入設定
async function loadConfig() {
    try {
        const resp = await fetch('/api/config');
        const result = await resp.json();
        if (result.success) {
            const config = result.data;

            // Scraper 設定
            document.getElementById('createFolder').checked = config.scraper.create_folder;
            document.getElementById('folderFormat').value = config.scraper.folder_format;
            document.getElementById('filenameFormat').value = config.scraper.filename_format;
            document.getElementById('maxTitleLength').value = config.scraper.max_title_length;
            document.getElementById('maxFilenameLength').value = config.scraper.max_filename_length;
            document.getElementById('videoExtensions').value = config.scraper.video_extensions.join(', ');

            // 搜尋設定
            document.getElementById('autoSearchOnDrop').checked = config.search.auto_search_on_drop;

            // 翻譯設定
            document.getElementById('translateEnabled').checked = config.translate.enabled;
            document.getElementById('translateProvider').value = config.translate.provider;
            document.getElementById('ollamaUrl').value = config.translate.ollama_url;
            document.getElementById('ollamaModel').value = config.translate.ollama_model;

            updateTranslateOptions();
        }
    } catch (e) {
        console.error('載入設定失敗:', e);
    }
}

// 儲存設定
async function saveConfig() {
    const config = {
        scraper: {
            create_folder: document.getElementById('createFolder').checked,
            folder_format: document.getElementById('folderFormat').value,
            filename_format: document.getElementById('filenameFormat').value,
            max_title_length: parseInt(document.getElementById('maxTitleLength').value),
            max_filename_length: parseInt(document.getElementById('maxFilenameLength').value),
            video_extensions: document.getElementById('videoExtensions').value
                .split(',').map(s => s.trim()).filter(s => s)
        },
        search: {
            auto_search_on_drop: document.getElementById('autoSearchOnDrop').checked
        },
        translate: {
            enabled: document.getElementById('translateEnabled').checked,
            provider: document.getElementById('translateProvider').value,
            ollama_url: document.getElementById('ollamaUrl').value,
            ollama_model: document.getElementById('ollamaModel').value
        }
    };

    try {
        const resp = await fetch('/api/config', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        const result = await resp.json();
        if (result.success) {
            showToast('設定已儲存', 'success');
        } else {
            showToast('儲存失敗: ' + result.error, 'danger');
        }
    } catch (e) {
        showToast('儲存失敗: ' + e.message, 'danger');
    }
}

// 更新翻譯選項顯示
function updateTranslateOptions() {
    const enabled = document.getElementById('translateEnabled').checked;
    document.getElementById('translateOptions').style.opacity = enabled ? '1' : '0.5';
    document.querySelectorAll('#translateOptions input, #translateOptions select').forEach(el => {
        el.disabled = !enabled;
    });
}

// Toast 提示
function showToast(message, type = 'info') {
    // 簡單的 alert，可以之後改成 Bootstrap toast
    if (type === 'success') {
        alert(message);
    } else {
        alert('錯誤: ' + message);
    }
}

// 事件綁定
document.getElementById('translateEnabled').addEventListener('change', updateTranslateOptions);

document.getElementById('settingsForm').addEventListener('submit', (e) => {
    e.preventDefault();
    saveConfig();
});

document.getElementById('resetBtn').addEventListener('click', () => {
    if (confirm('確定要重置所有設定嗎？')) {
        loadConfig();
    }
});

// 初始載入
loadConfig();
</script>
{% endblock %}
