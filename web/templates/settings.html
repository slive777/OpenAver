{% extends "base.html" %}

{% block title %}設定 - OpenAver{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/pages/settings.css">
{% endblock %}

{% block content %}
<div id="settings-components">
    <h4 class="mb-4">
        <i class="bi bi-gear"></i> 設定
    </h4>

    <form id="settingsForm">
        <!-- 1. 搜尋與刮削設定 (Search & Scraper) -->
        <div class="card mb-4">
            <div class="settings-card-header">
                <i class="bi bi-search"></i> 搜尋與刮削
            </div>
            <div class="card-body">

                <div class="settings-form-group">
                    <label class="settings-label">
                        <input type="checkbox" class="toggle toggle-primary" id="galleryModeEnabled"
                            data-section="search" data-key="gallery_mode_enabled">
                        <span class="label-text">女優畫廊模式 <span class="badge badge-error badge-sm">Beta</span></span>
                    </label>
                </div>

                <div class="settings-form-group">
                    <label class="settings-label">
                        <input type="checkbox" class="toggle toggle-primary" id="uncensoredModeEnabled"
                            data-section="search" data-key="uncensored_mode_enabled">
                        <span class="label-text">無碼模式</span>
                    </label>
                    <small class="settings-hint">啟用時只搜尋 AVSOX / FC2，適合無碼作品</small>
                </div>

                <!-- 我的最愛資料夾 -->
                <div class="settings-form-row">
                    <label class="row-label">
                        我的最愛資料夾
                        <small class="settings-hint">一鍵載入常用資料夾</small>
                    </label>
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                        <input type="text" class="input input-bordered input-sm" id="searchFavoriteFolder"
                            placeholder="留空 = 系統下載資料夾">
                        <small class="settings-hint">範例：C:\Users\&lt;你的使用者名稱&gt;\下載</small>
                    </div>
                </div>

                <div class="settings-form-group">
                    <label class="settings-label">
                        <input type="checkbox" class="toggle toggle-primary" id="translateEnabled">
                        <span class="label-text">啟用標題翻譯</span>
                    </label>
                </div>

                <!-- 翻譯選項 (動態顯示) -->
                <div id="translateOptions">
                    <div class="settings-form-row">
                        <label class="row-label">翻譯服務</label>
                        <select class="select select-bordered select-sm" id="translateProvider">
                            <option value="ollama">Ollama（本地）</option>
                            <option value="gemini">Gemini（Google 雲端）</option>
                        </select>
                    </div>

                    <!-- Ollama 設定 -->
                    <div id="ollamaFields">
                        <div class="settings-form-row">
                            <label class="row-label">Ollama URL</label>
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                                <div class="variable-input-group">
                                    <input type="text" class="input input-bordered input-sm" id="ollamaUrl"
                                        value="http://localhost:11434" style="flex: 1;">
                                    <button class="btn btn-sm btn-outline btn-neutral" type="button" id="testOllamaBtn">
                                        <i class="bi bi-plug"></i> 測試
                                    </button>
                                </div>
                                <small class="settings-hint" id="ollamaStatus"></small>
                            </div>
                        </div>

                        <div class="settings-form-row">
                            <label class="row-label">模型</label>
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                                <div class="variable-input-group">
                                    <select class="select select-bordered select-sm" id="ollamaModel" style="flex: 1;">
                                        <option value="">-- 請先測試連線 --</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline btn-neutral" type="button" id="testModelBtn"
                                        title="測試模型">
                                        <i class="bi bi-chat-dots"></i> 測試
                                    </button>
                                </div>
                                <small class="settings-hint" id="modelStatus"></small>
                            </div>
                        </div>
                    </div>

                    <!-- Gemini 設定 (初始隱藏) -->
                    <div id="geminiFields" style="display: none;">
                        <div class="settings-form-row">
                            <label class="row-label">API Key</label>
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                                <div class="variable-input-group">
                                    <input type="password" class="input input-bordered input-sm" id="geminiApiKey" placeholder="AIza..." style="flex: 1;">
                                    <button class="btn btn-sm btn-outline btn-neutral" type="button" id="testGeminiBtn">
                                        <i class="bi bi-plug"></i> 測試
                                    </button>
                                </div>
                                <small class="settings-hint" id="geminiStatus"></small>
                                <small class="settings-hint">
                                    <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a>
                                    可免費申請
                                </small>

                                <!-- 安全警告 -->
                                <div class="alert alert-warning api-key-alert" role="alert">
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                    <div class="alert-content">
                                        <strong>安全提示：</strong>
                                        <ul class="alert-list">
                                            <li>API Key 將以明文存儲在 config.json</li>
                                            <li>請勿將 config.json 分享給他人</li>
                                            <li>如需撤銷，請前往 <a href="https://aistudio.google.com/apikey" target="_blank" class="alert-link">Google
                                                    AI Studio</a> 重新生成</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-form-row">
                            <label class="row-label">模型</label>
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                                <div class="variable-input-group">
                                    <select class="select select-bordered select-sm" id="geminiModel" disabled style="flex: 1;">
                                        <option value="">-- 請先測試 API Key --</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline btn-neutral" type="button" id="testGeminiTranslateBtn"
                                        title="測試翻譯功能" disabled>
                                        <i class="bi bi-chat-dots"></i> 測試
                                    </button>
                                </div>
                                <small class="settings-hint" id="geminiModelStatus"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 進階刮削設定 (Collapsed) -->
                <hr class="my-3">
                <div x-data="{ expanded: false }">
                    <button class="collapsible-trigger" type="button" @click="expanded = !expanded" :aria-expanded="expanded.toString()">
                        <span class="collapsible-title">
                            <i class="bi bi-gear"></i> 進階刮削設定
                        </span>
                        <span class="btn-icon-collapse" aria-hidden="true">
                            <i class="bi bi-chevron-down" :class="{ 'rotate-180': expanded }"></i>
                        </span>
                    </button>
                    <div x-show="expanded" x-transition class="collapsible-content" id="scraperAdvanced">
                    <div class="settings-form-group">
                        <label class="settings-label">
                            <input type="checkbox" class="toggle toggle-primary" id="createFolder" checked
                                onchange="updateFolderLayers()">
                            <span class="label-text">建立資料夾</span>
                        </label>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">資料夾層級</label>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                            <!-- 第一行：外層 / 中層 -->
                            <div class="folder-layers-row">
                                <div class="folder-layer-group disabled" x-data="{ open: false }">
                                    <input type="text" class="input input-bordered input-sm" id="folderLayer1" placeholder="外層"
                                        oninput="updateFolderLayers()" disabled>
                                    <button class="btn-variable-sm" type="button"
                                        id="folderLayer1Btn" @click="open = !open" disabled>
                                        <i class="bi bi-braces"></i>
                                    </button>
                                    <div x-show="open" @click.outside="open = false" x-transition
                                        class="variable-menu"
                                        data-target="folderLayer1" style="display: none;"></div>
                                </div>
                                <span class="folder-separator">/</span>
                                <div class="folder-layer-group disabled" x-data="{ open: false }">
                                    <input type="text" class="input input-bordered input-sm" id="folderLayer2" placeholder="中層"
                                        oninput="updateFolderLayers()" disabled>
                                    <button class="btn-variable-sm" type="button"
                                        id="folderLayer2Btn" @click="open = !open" disabled>
                                        <i class="bi bi-braces"></i>
                                    </button>
                                    <div x-show="open" @click.outside="open = false" x-transition
                                        class="variable-menu"
                                        data-target="folderLayer2" style="display: none;"></div>
                                </div>
                            </div>
                            <!-- 第二行：內層（佔整行） -->
                            <div class="folder-layer-group" x-data="{ open: false }">
                                <span class="input-group-text">內層</span>
                                <input type="text" class="input input-bordered input-sm" id="folderLayer3" value="{num}"
                                    placeholder="{num}" oninput="updateFolderLayers()" style="flex: 1;">
                                <button class="btn-variable-sm" type="button"
                                    id="folderLayer3Btn" @click="open = !open">
                                    <i class="bi bi-braces"></i>
                                </button>
                                <div x-show="open" @click.outside="open = false" x-transition
                                    class="variable-menu"
                                    data-target="folderLayer3" style="display: none;"></div>
                            </div>
                            <div class="folder-preview">
                                <i class="bi bi-file-earmark-play"></i>
                                <span class="preview-text">預覽: <span
                                    id="folderPreview">SSNI-618/[SSNI-618][SOD] 絕對領域.mp4</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">檔案命名格式</label>
                        <div class="variable-input-group" x-data="{ open: false }">
                            <input type="text" class="input input-bordered input-sm" id="filenameFormat"
                                value="[{num}][{maker}] {title}" placeholder="[{num}][{maker}] {title}"
                                oninput="updateFolderPreview()" style="flex: 1;">
                            <button class="btn-variable" type="button"
                                @click="open = !open" :aria-expanded="open">
                                <i class="bi bi-braces"></i> 變數
                            </button>
                            <div x-show="open" @click.outside="open = false" x-transition
                                class="variable-menu"
                                data-target="filenameFormat" data-type="format" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">標題長度限制</label>
                        <div class="input-group-inline">
                            <input type="number" class="input input-bordered input-sm" id="maxTitleLength" value="80" min="20"
                                max="200">
                            <span class="input-suffix">字元</span>
                        </div>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">檔名長度限制</label>
                        <div class="input-group-inline">
                            <input type="number" class="input input-bordered input-sm" id="maxFilenameLength" value="200" min="50"
                                max="255">
                            <span class="input-suffix">字元</span>
                        </div>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">影片副檔名</label>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                            <input type="text" class="input input-bordered input-sm" id="videoExtensions"
                                value=".mp4, .avi, .mkv, .wmv, .rmvb, .flv, .mov, .m4v, .ts">
                            <small class="settings-hint">以逗號分隔</small>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. 列表生成設定 (Gallery) -->
        <div class="card mb-4">
            <div class="settings-card-header">
                <i class="bi bi-list-ul"></i> 列表生成
            </div>
            <div class="card-body">
                <!-- 常用設定 -->
                <div class="settings-form-row">
                    <label class="row-label">輸出目錄</label>
                    <div class="variable-input-group">
                        <input type="text" class="input input-bordered input-sm" id="avlistOutputDir" value="output"
                            placeholder="output" style="flex: 1;">
                        <button class="btn btn-sm btn-outline btn-neutral" type="button" onclick="selectOutputFolder()"
                            title="選擇資料夾">
                            <i class="bi bi-folder"></i>
                        </button>
                    </div>
                </div>

                <div class="settings-form-row">
                    <label class="row-label">輸出檔名</label>
                    <input type="text" class="input input-bordered input-sm" id="avlistOutputFilename"
                        value="gallery_output.html" placeholder="gallery_output.html">
                </div>

                <!-- 進階顯示選項 (Collapsed) -->
                <hr class="my-3">
                <div x-data="{ expanded: false }">
                    <button class="collapsible-trigger" type="button" @click="expanded = !expanded" :aria-expanded="expanded.toString()">
                        <span class="collapsible-title">
                            <i class="bi bi-sliders"></i> 進階顯示選項
                        </span>
                        <span class="btn-icon-collapse" aria-hidden="true">
                            <i class="bi bi-chevron-down" :class="{ 'rotate-180': expanded }"></i>
                        </span>
                    </button>
                    <div x-show="expanded" x-transition class="collapsible-content" id="galleryAdvanced">
                    <div class="settings-form-row">
                        <label class="row-label">預設顯示模式</label>
                        <select class="select select-bordered select-sm" id="avlistMode">
                            <option value="image">圖片模式</option>
                            <option value="detail">詳細模式</option>
                            <option value="text">文字模式</option>
                        </select>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">預設排序</label>
                        <div class="sort-row" style="display: flex; gap: 8px; flex: 1;">
                            <select class="select select-bordered select-sm" id="avlistSort" style="flex: 1;">
                                <option value="date">發售日期</option>
                                <option value="mdate">修改日期</option>
                                <option value="num">番號</option>
                                <option value="title">片名</option>
                                <option value="actor">演員</option>
                                <option value="maker">片商</option>
                                <option value="size">檔案大小</option>
                            </select>
                            <select class="select select-bordered select-sm" id="avlistOrder" style="width: 100px;">
                                <option value="descending">遞減</option>
                                <option value="ascending">遞增</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">每頁顯示數量</label>
                        <select class="select select-bordered select-sm" id="avlistItemsPerPage">
                            <option value="30">30</option>
                            <option value="45">45</option>
                            <option value="60">60</option>
                            <option value="90">90</option>
                            <option value="120">120</option>
                            <option value="0">全部</option>
                        </select>
                    </div>

                    <div class="settings-form-row">
                        <label class="row-label">最小影片尺寸</label>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                            <div class="input-group-inline">
                                <input type="number" class="input input-bordered input-sm" id="avlistMinSize" value="0" min="0">
                                <span class="input-suffix">MB</span>
                            </div>
                            <small class="settings-hint">0 = 不過濾</small>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 瀏覽與播放 (Showcase) -->
        <div class="card mb-4">
            <div class="settings-card-header">
                <i class="bi bi-collection-play"></i> 瀏覽與播放
            </div>
            <div class="card-body">
                <div class="settings-form-row">
                    <label class="row-label">影片播放器</label>
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                        <input type="text" class="input input-bordered input-sm" id="viewerPlayer"
                            placeholder="留空使用系統預設">
                        <small class="settings-hint">例如: C:\Program Files\DAUM\PotPlayer\PotPlayerMini64.exe</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. 系統設定 (System) -->
        <div class="card mb-4">
            <div class="settings-card-header">
                <i class="bi bi-sliders"></i> 系統設定
            </div>
            <div class="card-body">
                <div class="settings-form-row">
                    <label class="row-label">主題模式</label>
                    <select class="select select-bordered select-sm" id="themeMode" x-model="theme">
                        <option value="light">淺色模式 (Light)</option>
                        <option value="dim">深色模式 (Dim)</option>
                    </select>
                </div>
                <div class="settings-form-row">
                    <label class="row-label">啟動時開啟頁面</label>
                    <select class="select select-bordered select-sm" id="defaultPage">
                        <option value="search">搜尋</option>
                        <option value="scanner">列表生成</option>
                        <option value="showcase">瀏覽</option>
                    </select>
                </div>
                <div class="settings-form-group">
                    <label class="settings-label">
                        <input type="checkbox" class="toggle toggle-primary" id="sidebarCollapsed">
                        <span class="label-text">啟動時收合側邊欄</span>
                    </label>
                    <small class="settings-hint">僅影響桌面版</small>
                </div>

                <hr class="my-3">

                <!-- 重置按鈕 -->
                <div class="settings-form-row">
                    <label class="row-label text-error">
                        重置所有設定
                        <small class="settings-hint">刪除所有自訂設定，恢復預設值</small>
                    </label>
                    <button type="button" class="btn btn-sm btn-outline btn-error" id="resetBtn">
                        <i class="bi bi-arrow-counterclockwise"></i> 重置為預設值
                    </button>
                </div>

                <hr class="my-3">

                <!-- 重看新手引導 -->
                <div class="settings-form-row">
                    <label class="row-label">
                        新手引導
                        <small class="settings-hint">觀看功能介紹教學</small>
                    </label>
                    <button type="button" class="btn btn-sm btn-outline btn-primary" id="btnRestartTutorial">
                        <i class="bi bi-play-circle"></i> 重看新手引導
                    </button>
                </div>
            </div>
        </div>
        <hr class="my-3">

        <!-- 版本資訊 -->
        <div class="settings-form-row">
            <label class="row-label">版本資訊</label>
            <span id="appVersion" class="version-text">載入中...</span>
        </div>

        <!-- 檢查更新 -->
        <div class="settings-form-row">
            <label class="row-label">
                軟體更新
                <small class="settings-hint">手動檢查 GitHub 是否有新版本</small>
            </label>
            <div class="update-check-wrapper">
                <button type="button" class="btn btn-sm btn-outline btn-neutral" id="btnCheckUpdate">
                    <i class="bi bi-cloud-download"></i> 檢查更新
                </button>
                <span id="updateStatus" class="small"></span>
            </div>
        </div>

        <!-- 儲存按鈕 -->
        <div class="save-btn-wrapper">
            <button type="submit" class="btn btn-primary save-btn" id="saveBtn">
                <i class="bi bi-save"></i> 儲存設定
            </button>
        </div>
    </form>

<!-- Toast 通知容器 -->
<div id="toastContainer" class="toast toast-end toast-top" style="z-index: 9999;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/pages/settings/core.js"></script>
<script src="/static/js/pages/settings/translate.js"></script>
<script src="/static/js/pages/settings/folders.js"></script>
<script src="/static/js/pages/settings/format.js"></script>
<script src="/static/js/pages/settings/init.js"></script>
{% endblock %}