{% extends "base.html" %}

{% block title %}影片瀏覽 - OpenAver{% endblock %}

{% block extra_css %}
<link href="/static/css/pages/showcase.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="showcase-container ds-gallery-composition"
     x-data="showcaseState()"
     x-init="init()"
     @keydown.window="handleKeydown($event)">

    <!-- Loading State (初始顯示) -->
    <div class="state-page" x-show="loading && videos.length === 0">
        <i class="bi bi-hourglass-split state-page-icon"></i>
        <p class="state-page-text">載入影片列表中...</p>
    </div>

    <!-- Empty State (API 回傳空資料時) -->
    <div class="state-page" x-show="!loading && !error && videos.length === 0">
        <i class="bi bi-collection-play state-page-icon"></i>
        <p class="state-page-text">尚未產生影片列表</p>
        <div class="empty-actions">
            <a href="/scanner" class="btn btn-outline btn-primary btn-sm">
                <i class="bi bi-plus-circle"></i> 產生列表
            </a>
        </div>
    </div>

    <!-- Error State (API 錯誤時) -->
    <div class="state-page error" x-show="!loading && error">
        <i class="bi bi-exclamation-triangle state-page-icon"></i>
        <p class="state-page-text" x-text="error"></p>
        <div class="empty-actions">
            <button class="btn btn-outline btn-primary btn-sm" @click="retry()">
                <i class="bi bi-arrow-clockwise"></i> 重試
            </button>
        </div>
    </div>

    <!-- Main Content (API 載入後顯示) -->
    <div x-show="!error && videos.length > 0" style="display: none;">

        <!-- Toolbar -->
        <div class="showcase-toolbar">
            <div class="toolbar-section toolbar-search">
                <div class="spotlight-search">
                    <i class="bi bi-search search-icon-left"></i>
                    <input type="text"
                           placeholder="搜尋番號、女優、標題..."
                           x-model="search"
                           @input.debounce.300ms="onSearchChange()">
                    <div class="search-actions-right">
                        <button class="btn-icon"
                                x-show="search !== ''"
                                @click="search = ''; onSearchChange()"
                                title="清除搜尋">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="toolbar-section toolbar-controls">
                <!-- 排序 -->
                <div class="control-group">
                    <select class="select select-sm select-bordered" x-model="sort" @change="onSortChange()">
                        <option value="date">日期</option>
                        <option value="num">番號</option>
                        <option value="title">標題</option>
                        <option value="actor">女優</option>
                        <option value="maker">片商</option>
                        <option value="size">大小</option>
                        <option value="mdate">修改時間</option>
                        <option value="random">隨機</option>
                    </select>
                    <button class="btn-icon" @click="toggleOrder()" title="切換排序方向">
                        <i class="bi" :class="order === 'asc' ? 'bi-sort-up' : 'bi-sort-down'"></i>
                    </button>
                </div>

                <!-- 顯示模式 (M3 啟用 table) -->
                <div class="control-group mode-switcher">
                    <button class="btn-icon"
                            :class="{ 'active': mode === 'grid' }"
                            @click="switchMode('grid')"
                            title="圖片模式 (A)">
                        <i class="bi bi-grid-3x3"></i>
                    </button>
                    <button class="btn-icon"
                            :class="{ 'active': mode === 'table' }"
                            @click="switchMode('table')"
                            title="表格模式">
                        <i class="bi bi-table"></i>
                    </button>
                    <button class="btn-icon" disabled title="列表模式 (即將推出)">
                        <i class="bi bi-list-ul"></i>
                    </button>
                </div>

                <!-- 每頁數量 -->
                <div class="control-group">
                    <select class="select select-sm select-bordered" x-model="perPage" @change="onPerPageChange()">
                        <option value="30">30 部</option>
                        <option value="45">45 部</option>
                        <option value="60">60 部</option>
                        <option value="90">90 部</option>
                        <option value="120">120 部</option>
                        <option value="0">全部</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Image Grid -->
        <div class="showcase-grid" x-show="mode === 'grid'">
            <template x-for="(video, index) in paginatedVideos" :key="video.path">
                <div class="av-card-preview"
                     @click="openLightbox(getCurrentFilteredIndex(index))"
                     :style="`--card-index: ${index}`">
                    <div class="av-card-preview-img">
                        <img :src="video.cover_url"
                             :alt="video.number"
                             loading="lazy">
                        <!-- Badge: Local / HD 等狀態標籤 (M2a 先不實作) -->
                    </div>
                    <div class="av-card-preview-footer">
                        <span class="av-num" x-text="video.number"></span>
                        <span class="av-actress" x-text="video.actresses || '未知'"></span>
                    </div>
                </div>
            </template>
        </div>

        <!-- Detail Table (M3b) -->
        <div class="showcase-table-wrapper" x-show="mode === 'table'" style="display: none;">
            <div class="table-scroll-container">
                <table class="table table-zebra table-pin-rows">
                    <thead>
                        <tr>
                            <th class="table-col-index">#</th>
                            <th class="table-col-number sortable"
                                :class="{ 'sort-active': sort === 'num' }"
                                @click="sortBy('num')">
                                番號
                                <i class="bi sort-icon"
                                   :class="sort === 'num' ? (order === 'asc' ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i>
                            </th>
                            <th class="table-col-title sortable"
                                :class="{ 'sort-active': sort === 'title' }"
                                @click="sortBy('title')">
                                標題
                                <i class="bi sort-icon"
                                   :class="sort === 'title' ? (order === 'asc' ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i>
                            </th>
                            <th class="table-col-actor sortable"
                                :class="{ 'sort-active': sort === 'actor' }"
                                @click="sortBy('actor')">
                                女優
                                <i class="bi sort-icon"
                                   :class="sort === 'actor' ? (order === 'asc' ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i>
                            </th>
                            <th class="table-col-maker sortable"
                                :class="{ 'sort-active': sort === 'maker' }"
                                @click="sortBy('maker')">
                                片商
                                <i class="bi sort-icon"
                                   :class="sort === 'maker' ? (order === 'asc' ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i>
                            </th>
                            <th class="table-col-date sortable"
                                :class="{ 'sort-active': sort === 'date' }"
                                @click="sortBy('date')">
                                日期
                                <i class="bi sort-icon"
                                   :class="sort === 'date' ? (order === 'asc' ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i>
                            </th>
                            <th class="table-col-tags">標籤</th>
                            <th class="table-col-size sortable"
                                :class="{ 'sort-active': sort === 'size' }"
                                @click="sortBy('size')">
                                大小
                                <i class="bi sort-icon"
                                   :class="sort === 'size' ? (order === 'asc' ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(video, index) in paginatedVideos" :key="video.path">
                            <tr @click="openLightbox(getCurrentFilteredIndex(index))" class="table-row-clickable">
                                <td class="table-cell-index" x-text="getCurrentFilteredIndex(index) + 1"></td>
                                <td class="table-cell-number">
                                    <span class="table-number-highlight" x-text="video.number"></span>
                                </td>
                                <td class="table-cell-title" x-text="video.title || '未知標題'"></td>
                                <td class="table-cell-actor" x-text="video.actresses || '未知'"></td>
                                <td class="table-cell-maker" x-text="video.maker || '-'"></td>
                                <td class="table-cell-date" x-text="video.release_date || '-'"></td>
                                <td class="table-cell-tags">
                                    <template x-if="video.tags">
                                        <div class="table-tags-wrapper">
                                            <template x-for="tag in video.tags.split(',').slice(0, 3).filter(t => t.trim())" :key="tag">
                                                <span class="table-tag" x-text="tag.trim()"></span>
                                            </template>
                                            <template x-if="video.tags.split(',').length > 3">
                                                <span class="table-tag-more" x-text="`+${video.tags.split(',').length - 3}`"></span>
                                            </template>
                                        </div>
                                    </template>
                                    <template x-if="!video.tags">
                                        <span class="text-muted">-</span>
                                    </template>
                                </td>
                                <td class="table-cell-size">
                                    <span class="table-size-mono" x-text="formatSize(video.size || 0)"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="showcase-pagination" x-show="totalPages > 1">
            <button class="btn btn-sm btn-outline"
                    @click="prevPage()"
                    :disabled="page === 1">
                <i class="bi bi-chevron-left"></i> 上一頁
            </button>
            <span class="pagination-info" x-text="`第 ${page} / ${totalPages} 頁`"></span>
            <button class="btn btn-sm btn-outline"
                    @click="nextPage()"
                    :disabled="page === totalPages">
                下一頁 <i class="bi bi-chevron-right"></i>
            </button>
        </div>

        <!-- Lightbox (M3a) -->
        <div class="showcase-lightbox"
             :class="{ 'show': lightboxOpen }"
             @click="handleLightboxBackdropClick($event)"
             @mousemove="handleLightboxMousemove($event)">

            <div class="lightbox-content" @click.stop>
                <!-- Close Button -->
                <button class="lightbox-close"
                        @click="closeLightbox()"
                        title="關閉 (ESC)">
                    <i class="bi bi-x-lg"></i>
                </button>

                <!-- Cover Image -->
                <div class="lightbox-cover">
                    <img :src="currentLightboxVideo?.cover_url"
                         :alt="currentLightboxVideo?.number"
                         @error="$event.target.src='/static/images/placeholder.png'">
                </div>

                <!-- Metadata Panel -->
                <div class="lightbox-metadata">
                    <!-- Title Section -->
                    <div class="lb-section lb-title-section">
                        <h2 class="lb-title" x-text="currentLightboxVideo?.title || '未知標題'"></h2>
                        <p class="lb-original-title"
                           x-show="currentLightboxVideo?.original_title"
                           x-text="currentLightboxVideo?.original_title"></p>
                    </div>

                    <!-- Actress Section -->
                    <div class="lb-section lb-actress-section"
                         x-show="currentLightboxVideo?.actresses">
                        <div class="lb-label">
                            <i class="bi bi-person-fill"></i> 女優
                        </div>
                        <div class="lb-value" x-text="currentLightboxVideo?.actresses || '未知'"></div>
                    </div>

                    <!-- Number & Maker Section -->
                    <div class="lb-section lb-meta-row">
                        <div class="lb-meta-item">
                            <div class="lb-label">
                                <i class="bi bi-hash"></i> 番號
                            </div>
                            <div class="lb-value lb-number"
                                 x-text="currentLightboxVideo?.number || '未知'"></div>
                        </div>
                        <div class="lb-meta-item"
                             x-show="currentLightboxVideo?.maker">
                            <div class="lb-label">
                                <i class="bi bi-building"></i> 片商
                            </div>
                            <div class="lb-value" x-text="currentLightboxVideo?.maker"></div>
                        </div>
                    </div>

                    <!-- Date Section -->
                    <div class="lb-section"
                         x-show="currentLightboxVideo?.release_date">
                        <div class="lb-label">
                            <i class="bi bi-calendar3"></i> 發行日期
                        </div>
                        <div class="lb-value" x-text="currentLightboxVideo?.release_date"></div>
                    </div>

                    <!-- Tags Section -->
                    <div class="lb-section lb-tags-section"
                         x-show="currentLightboxVideo?.tags">
                        <div class="lb-label">
                            <i class="bi bi-tags-fill"></i> 標籤
                        </div>
                        <div class="lb-tags">
                            <template x-for="tag in (currentLightboxVideo?.tags || '').split(',').filter(t => t.trim())" :key="tag">
                                <span class="lb-tag" x-text="tag"></span>
                            </template>
                        </div>
                    </div>

                    <!-- File Size Section -->
                    <div class="lb-section lb-size-section">
                        <div class="lb-label">
                            <i class="bi bi-hdd"></i> 檔案大小
                        </div>
                        <div class="lb-value lb-size" x-text="formatSize(currentLightboxVideo?.size || 0)"></div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="lb-actions">
                        <button class="btn-hero btn-hero-primary"
                                @click="playVideo(currentLightboxVideo?.path)">
                            <i class="bi bi-play-circle-fill"></i> 開啟影片
                        </button>
                        <button class="btn-hero btn-hero-secondary"
                                @click="copyPath(currentLightboxVideo?.path)">
                            <i class="bi bi-clipboard"></i> 複製路徑
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation Arrows OUTSIDE lightbox-content -->
            <button class="lightbox-nav lightbox-nav-prev"
                    @click.stop="prevLightboxVideo()"
                    x-show="lightboxIndex > 0"
                    title="上一部 (←)">
                <i class="bi bi-chevron-left"></i>
            </button>
            <button class="lightbox-nav lightbox-nav-next"
                    @click.stop="nextLightboxVideo()"
                    x-show="lightboxIndex < filteredVideos.length - 1"
                    title="下一部 (→)">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- M2c: 傳遞 config 給 JS -->
<script>
window.__SHOWCASE_CONFIG__ = {{ (config.gallery or {}) | tojson | safe }};
</script>
<!-- M2a 只需 core.js -->
<script src="/static/js/pages/showcase/core.js"></script>
{% endblock %}
